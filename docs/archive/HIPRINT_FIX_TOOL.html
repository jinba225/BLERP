<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiPrint æ˜ç»†æ•°æ®ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-left: 4px solid #3b82f6;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 20px 0;
        }
        .error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 20px 0;
        }
        ol, ul {
            line-height: 2;
        }
        code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: "Courier New", monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ HiPrint æ˜ç»†æ•°æ®å¿«é€Ÿä¿®å¤</h1>
        <p style="color: #6b7280;">è§£å†³æ¨¡æ¿ç¼–è¾‘å™¨ä¸­æ˜ç»†æ•°æ®ä¸æ˜¾ç¤ºçš„é—®é¢˜</p>

        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
            <ol>
                <li>è¯·å…ˆ <strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong>ï¼ˆCtrl+Shift+R æˆ– Cmd+Shift+Rï¼‰</li>
                <li>æ‰“å¼€æ¨¡æ¿ç¼–è¾‘å™¨é¡µé¢ï¼š<code>http://127.0.0.1:8000/sales/templates/1/edit/</code></li>
                <li>æŒ‰ <strong>F12</strong> æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° <strong>Console</strong> æ ‡ç­¾</li>
            </ol>
        </div>

        <div class="section">
            <h2>ğŸ“‹ æ­¥éª¤ 1ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬</h2>
            <p>å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼Œç²˜è´´åˆ°æµè§ˆå™¨ Console ä¸­ï¼ŒæŒ‰å›è½¦è¿è¡Œï¼š</p>
            <div class="code-block">
(function() {
    console.clear();
    console.log('%c=== HiPrint æ˜ç»†æ•°æ®è¯Šæ–­ ===', 'color: #3b82f6; font-size: 16px; font-weight: bold');

    // 1. æ£€æŸ¥ä¾èµ–
    console.log('\n%c1. ä¾èµ–æ£€æŸ¥', 'color: #10b981; font-weight: bold');
    var checks = {
        'jQuery': typeof $ !== 'undefined',
        'HiPrint': typeof hiprint !== 'undefined',
        'QuoteElementProvider': typeof QuoteElementProvider !== 'undefined',
        'hiprintTemplate': typeof hiprintTemplate !== 'undefined',
        'getSampleData': typeof getSampleData === 'function'
    };

    Object.keys(checks).forEach(function(key) {
        console.log('  ' + (checks[key] ? 'âœ…' : 'âŒ') + ' ' + key);
    });

    if (!checks['hiprintTemplate']) {
        console.error('âŒ æ¨¡æ¿æœªåˆå§‹åŒ–ï¼è¯·ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†è¿è¡Œæ­¤è„šæœ¬ã€‚');
        return;
    }

    // 2. æ£€æŸ¥ç”»å¸ƒå…ƒç´ 
    console.log('\n%c2. ç”»å¸ƒå…ƒç´ æ£€æŸ¥', 'color: #10b981; font-weight: bold');
    var json = hiprintTemplate.getJson();
    console.log('  ç”»å¸ƒæ•°é‡:', json.panels ? json.panels.length : 0);

    if (json.panels && json.panels[0]) {
        var elements = json.panels[0].printElements || [];
        console.log('  æ€»å…ƒç´ æ•°é‡:', elements.length);

        // æ‰¾å‡ºæ˜ç»†é¡¹å­—æ®µ
        var itemFields = elements.filter(function(elem) {
            return elem.options && elem.options.field &&
                   elem.options.field.indexOf('items.#.') === 0;
        });

        console.log('  æ˜ç»†é¡¹å­—æ®µæ•°é‡:', itemFields.length);

        if (itemFields.length > 0) {
            console.log('\n  æ˜ç»†é¡¹å­—æ®µè¯¦æƒ…:');
            itemFields.forEach(function(field, i) {
                var opts = field.options;
                console.log('    ' + (i+1) + '. å­—æ®µ:', opts.field);
                console.log('       æ ‡é¢˜:', opts.title);
                console.log('       testData:', opts.testData);
                console.log('       ä½ç½®: (' + opts.left + ', ' + opts.top + ')');
                console.log('       å°ºå¯¸: ' + opts.width + 'x' + opts.height);
            });
        } else {
            console.warn('  âš ï¸ ç”»å¸ƒä¸­æ²¡æœ‰æ˜ç»†é¡¹å­—æ®µï¼è¯·ä»å·¦ä¾§"ğŸ“¦ æ˜ç»†é¡¹å­—æ®µ"åˆ†ç»„ä¸­æ‹–æ‹½å­—æ®µåˆ°ç”»å¸ƒã€‚');
        }
    }

    // 3. æ£€æŸ¥æµ‹è¯•æ•°æ®
    console.log('\n%c3. æµ‹è¯•æ•°æ®æ£€æŸ¥', 'color: #10b981; font-weight: bold');
    if (checks['getSampleData']) {
        var testData = getSampleData();
        console.log('  items æ˜¯æ•°ç»„:', Array.isArray(testData.items));
        console.log('  items æ•°é‡:', testData.items ? testData.items.length : 0);

        if (testData.items && testData.items.length > 0) {
            console.log('\n  ç¬¬ä¸€æ¡æ˜ç»†æ•°æ®:');
            var item = testData.items[0];
            console.table(item);

            // æ£€æŸ¥å­—æ®µå®Œæ•´æ€§
            var requiredFields = ['index', 'product_code', 'product_name', 'specification',
                                 'quantity', 'unit', 'unit_price', 'subtotal'];
            var missingFields = requiredFields.filter(function(f) {
                return !(f in item);
            });

            if (missingFields.length > 0) {
                console.warn('  âš ï¸ ç¼ºå°‘å­—æ®µ:', missingFields.join(', '));
            } else {
                console.log('  âœ… æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨');
            }
        }
    }

    // 4. æµ‹è¯•é¢„è§ˆåŠŸèƒ½
    console.log('\n%c4. é¢„è§ˆåŠŸèƒ½æµ‹è¯•', 'color: #10b981; font-weight: bold');
    console.log('  æç¤º: ç‚¹å‡»å·¥å…·æ çš„"é¢„è§ˆ"æŒ‰é’®ï¼Œç„¶åæŸ¥çœ‹ä¸‹æ–¹çš„æµ‹è¯•ç»“æœ');

    // 5. ç»™å‡ºå»ºè®®
    console.log('\n%c5. è¯Šæ–­ç»“æœ', 'color: #f59e0b; font-weight: bold');

    var hasItemFields = json.panels && json.panels[0] &&
                       json.panels[0].printElements.some(function(e) {
                           return e.options && e.options.field &&
                                  e.options.field.indexOf('items.#.') === 0;
                       });

    if (!hasItemFields) {
        console.log('  âŒ é—®é¢˜: ç”»å¸ƒä¸­æ²¡æœ‰æ˜ç»†é¡¹å­—æ®µ');
        console.log('  ğŸ’¡ è§£å†³: ä»å·¦ä¾§å…ƒç´ åº“æ‹–æ‹½"ğŸ“¦ æ˜ç»†é¡¹å­—æ®µ"åˆ°ç”»å¸ƒ');
    } else if (!checks['getSampleData']) {
        console.log('  âŒ é—®é¢˜: æµ‹è¯•æ•°æ®å‡½æ•°ä¸å­˜åœ¨');
        console.log('  ğŸ’¡ è§£å†³: æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œå…¨åŠ è½½');
    } else {
        console.log('  âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡ï¼');
        console.log('  ğŸ’¡ å¦‚æœé¢„è§ˆä»æ— æ•°æ®ï¼Œè¯·è¿è¡Œæ­¥éª¤ 2 çš„ä¿®å¤è„šæœ¬');
    }

    console.log('\n%c=== è¯Šæ–­å®Œæˆ ===', 'color: #3b82f6; font-size: 16px; font-weight: bold');
})();
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ æ­¥éª¤ 2ï¼šè¿è¡Œä¿®å¤è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰</h2>
            <p>å¦‚æœè¯Šæ–­å‘ç°é—®é¢˜ï¼Œå¤åˆ¶ä»¥ä¸‹ä¿®å¤è„šæœ¬åˆ° Console è¿è¡Œï¼š</p>
            <div class="code-block">
(function() {
    console.clear();
    console.log('%c=== å¼€å§‹ä¿®å¤ ===', 'color: #10b981; font-size: 16px; font-weight: bold');

    // ä¿®å¤ 1: ç¡®ä¿æµ‹è¯•æ•°æ®å®Œæ•´
    if (typeof getSampleData !== 'function') {
        console.log('åˆ›å»ºæµ‹è¯•æ•°æ®å‡½æ•°...');
        window.getSampleData = function() {
            return {
                quote_number: 'BL-Q-20250107-001',
                quote_date: '2025-01-07',
                customer_name: 'ç¤ºä¾‹å®¢æˆ·æœ‰é™å…¬å¸',
                items: [
                    {
                        index: 1,
                        product_code: 'BL-LS-1000',
                        product_name: 'å…‰çº¤æ¿€å…‰å™¨ 1000W',
                        specification: 'IPG YLR-1000',
                        quantity: '2',
                        unit: 'å°',
                        unit_price: '35000.00',
                        discount_rate: '5%',
                        tax_rate: '13%',
                        subtotal: '70000.00',
                        lead_time: '30å¤©',
                        notes: 'å«é…ä»¶'
                    },
                    {
                        index: 2,
                        product_code: 'BL-CUT-3015',
                        product_name: 'æ¿€å…‰åˆ‡å‰²æœº 3015',
                        specification: 'å·¥ä½œå° 3000Ã—1500mm',
                        quantity: '1',
                        unit: 'å°',
                        unit_price: '280000.00',
                        subtotal: '280000.00',
                        lead_time: '45å¤©'
                    }
                ]
            };
        };
        console.log('âœ… æµ‹è¯•æ•°æ®å‡½æ•°å·²åˆ›å»º');
    }

    // ä¿®å¤ 2: å¢å¼ºé¢„è§ˆå‡½æ•°
    console.log('\nå¢å¼ºé¢„è§ˆå‡½æ•°...');
    window.previewPrintFixed = function() {
        console.log('=== å¼€å§‹é¢„è§ˆï¼ˆä¿®å¤ç‰ˆï¼‰===');

        if (!hiprintTemplate) {
            alert('æ¨¡æ¿æœªåˆå§‹åŒ–');
            return;
        }

        var data = getSampleData();
        console.log('é¢„è§ˆæ•°æ®:', data);
        console.log('æ˜ç»†é¡¹æ•°é‡:', data.items ? data.items.length : 0);

        try {
            // ä½¿ç”¨ print æ–¹æ³•ï¼ˆæ‰“å¼€é¢„è§ˆçª—å£ï¼‰
            hiprintTemplate.print(data, {
                styleHandler: function() {
                    // ç¡®ä¿æ ·å¼æ­£ç¡®
                    return '<style>@page { size: A4; margin: 10mm; }</style>';
                }
            });
            console.log('âœ… é¢„è§ˆçª—å£å·²æ‰“å¼€');
        } catch (e) {
            console.error('âŒ é¢„è§ˆå¤±è´¥:', e);
            alert('é¢„è§ˆå¤±è´¥: ' + e.message);
        }
    };

    console.log('âœ… é¢„è§ˆå‡½æ•°å·²å¢å¼º');

    // ä¿®å¤ 3: æ·»åŠ å¿«æ·æµ‹è¯•æŒ‰é’®
    console.log('\næ·»åŠ æµ‹è¯•æŒ‰é’®...');
    if (!document.getElementById('quick-test-btn')) {
        var btn = document.createElement('button');
        btn.id = 'quick-test-btn';
        btn.textContent = 'ğŸ§ª å¿«é€Ÿé¢„è§ˆæµ‹è¯•';
        btn.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; ' +
                           'padding: 10px 20px; background: #10b981; color: white; ' +
                           'border: none; border-radius: 6px; cursor: pointer; ' +
                           'box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
        btn.onclick = window.previewPrintFixed;
        document.body.appendChild(btn);
        console.log('âœ… æµ‹è¯•æŒ‰é’®å·²æ·»åŠ åˆ°é¡µé¢å³ä¸Šè§’');
    }

    console.log('\n%c=== ä¿®å¤å®Œæˆ ===', 'color: #10b981; font-size: 16px; font-weight: bold');
    console.log('ğŸ’¡ ç°åœ¨å¯ä»¥ï¼š');
    console.log('   1. ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„"ğŸ§ª å¿«é€Ÿé¢„è§ˆæµ‹è¯•"æŒ‰é’®');
    console.log('   2. æˆ–åœ¨ Console ä¸­è¾“å…¥: previewPrintFixed()');
})();
            </div>
        </div>

        <div class="section">
            <h2>âœ… æ­¥éª¤ 3ï¼šæ‰‹åŠ¨æ·»åŠ æµ‹è¯•å…ƒç´ </h2>
            <p>å¦‚æœç”»å¸ƒä¸­æ²¡æœ‰æ˜ç»†é¡¹å­—æ®µï¼Œè¿è¡Œæ­¤è„šæœ¬è‡ªåŠ¨æ·»åŠ ï¼š</p>
            <div class="code-block">
(function() {
    console.log('æ·»åŠ æµ‹è¯•æ˜ç»†å­—æ®µ...');

    if (!hiprintTemplate || !hiprintTemplate.printPanels || !hiprintTemplate.printPanels[0]) {
        alert('æ¨¡æ¿æœªåˆå§‹åŒ–ï¼');
        return;
    }

    var panel = hiprintTemplate.printPanels[0];

    // æ·»åŠ æ ‡é¢˜
    panel.addPrintText({
        left: 250,
        top: 30,
        width: 200,
        height: 30,
        text: 'æŠ¥ä»·å•',
        fontSize: 20,
        fontWeight: 'bold',
        textAlign: 'center'
    });

    // æ·»åŠ æ˜ç»†é¡¹è¡¨å¤´æç¤º
    panel.addPrintText({
        left: 50,
        top: 120,
        width: 700,
        height: 20,
        text: 'äº§å“æ˜ç»†ï¼š',
        fontSize: 12,
        fontWeight: 'bold'
    });

    // æ·»åŠ æ˜ç»†é¡¹å­—æ®µï¼ˆæ ‡å‡† 6 åˆ—ï¼‰
    var fields = [
        { field: 'index', title: 'åºå·', left: 50, width: 40, align: 'center' },
        { field: 'product_name', title: 'äº§å“åç§°', left: 100, width: 200, align: 'left' },
        { field: 'specification', title: 'è§„æ ¼', left: 310, width: 150, align: 'left' },
        { field: 'quantity', title: 'æ•°é‡', left: 470, width: 60, align: 'right' },
        { field: 'unit_price', title: 'å•ä»·', left: 540, width: 80, align: 'right' },
        { field: 'subtotal', title: 'å°è®¡', left: 630, width: 90, align: 'right' }
    ];

    fields.forEach(function(f) {
        panel.addPrintText({
            left: f.left,
            top: 150,
            width: f.width,
            height: 20,
            field: 'items.#.' + f.field,
            testData: f.field === 'index' ? '1' :
                     f.field === 'product_name' ? 'æµ‹è¯•äº§å“' :
                     f.field === 'quantity' ? '10' :
                     f.field === 'unit_price' ? '1000.00' :
                     f.field === 'subtotal' ? '10000.00' : 'ç¤ºä¾‹',
            title: f.title,
            hideTitle: true,
            fontSize: 11,
            textAlign: f.align,
            borderWidth: 1,
            borderColor: '#d1d5db',
            borderStyle: 'solid'
        });
    });

    console.log('âœ… å·²æ·»åŠ  6 ä¸ªæ˜ç»†å­—æ®µåˆ°ç”»å¸ƒ');
    alert('âœ… æµ‹è¯•å­—æ®µå·²æ·»åŠ ï¼\n\nç°åœ¨ç‚¹å‡»"é¢„è§ˆ"æŒ‰é’®æŸ¥çœ‹æ•ˆæœã€‚');
})();
            </div>
        </div>

        <div class="success">
            <h3>âœ… å®Œæˆåçš„éªŒè¯</h3>
            <ol>
                <li>ç”»å¸ƒä¸Šåº”è¯¥èƒ½çœ‹åˆ°æ˜ç»†é¡¹å­—æ®µï¼ˆæ˜¾ç¤ºæµ‹è¯•æ•°æ®ï¼Œå¦‚"æµ‹è¯•äº§å“"ã€"1000.00"ç­‰ï¼‰</li>
                <li>ç‚¹å‡»"é¢„è§ˆ"æŒ‰é’®ï¼Œåº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„ 4 æ¡æ˜ç»†æ•°æ®</li>
                <li>æ•°æ®åº”è¯¥åŒ…å«ï¼šå…‰çº¤æ¿€å…‰å™¨ã€æ¿€å…‰åˆ‡å‰²æœºç­‰äº§å“</li>
            </ol>
        </div>

        <div class="section">
            <h2>ğŸ“ ä»ç„¶æœ‰é—®é¢˜ï¼Ÿ</h2>
            <p>å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š</p>
            <ul>
                <li>æ­¥éª¤ 1 è¯Šæ–­è„šæœ¬çš„å®Œæ•´è¾“å‡ºï¼ˆæˆªå›¾ï¼‰</li>
                <li>æµè§ˆå™¨ Console ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰</li>
                <li>æ¨¡æ¿ç¼–è¾‘å™¨çš„æˆªå›¾</li>
                <li>é¢„è§ˆçª—å£çš„æˆªå›¾</li>
            </ul>
        </div>

        <div style="margin-top: 40px; text-align: center; color: #6b7280; font-size: 14px;">
            <p>HiPrint æ˜ç»†æ•°æ®ä¿®å¤å·¥å…· v1.0</p>
            <p>å¦‚éœ€å¸®åŠ©ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š<code>docs/HIPRINT_DEBUG_GUIDE.md</code></p>
        </div>
    </div>
</body>
</html>
