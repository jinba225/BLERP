# 供应商预付款自动合并核销功能说明

## 功能概述

在供应商应付账款核销页面，新增"使用所有预付款"选项，一键使用该供应商的所有可用预付款进行核销。

---

## 使用方式

### 界面位置
访问路径：`/finance/supplier-accounts/<id>/writeoff/`

### 下拉框选项

```
┌─────────────────────────────────────────────┐
│ 不使用预付款                                │
│ ⭐ 使用所有预付款（总余额 ¥15,000.00）     │  ← 新增选项
│ ────────────────────────────────────────    │
│ 2025-01-15 - 余额 ¥5,000.00                │
│ 2025-01-10 - 余额 ¥10,000.00               │
└─────────────────────────────────────────────┘
```

### 操作步骤

1. **进入核销页面**
   - 显示当前应付账款余额
   - 显示供应商总应付余额（所有未结清账户）
   - 列出所有可用预付款及总余额

2. **选择核销方式**

   **方式一：使用所有预付款**
   - 在下拉框中选择 `⭐ 使用所有预付款（总余额 ¥XXX）`
   - 系统自动按日期顺序使用所有预付款
   - 可补充填写现金付款金额
   - 点击"确认核销"

   **方式二：使用单个预付款**
   - 在下拉框中选择具体的预付款
   - 填写现金付款金额
   - 点击"确认核销"

   **方式三：不使用预付款**
   - 保持下拉框为"不使用预付款"
   - 只填写现金付款金额
   - 点击"确认核销"

3. **系统自动处理**
   - 验证核销金额有效性
   - 按顺序扣减预付款余额
   - 生成付款记录
   - 更新应付账款余额
   - 显示核销成功消息

---

## 核心特性

### 1. 智能余额管理
- ✅ 自动计算预付款总余额
- ✅ 不会超额核销（最多核销至应付余额）
- ✅ 按预付款日期顺序使用

### 2. 实时数据刷新
- ✅ 页面加载时自动刷新
- ✅ 支持手动刷新按钮
- � 每30秒自动刷新（页面可见时）
- ✅ 创建新预付款后自动返回刷新

### 3. 友好的用户界面
- ✅ 清晰的选项标识（⭐ 星标）
- ✅ 实时提示当前选中项
- ✅ 显示预付款数量和总余额
- ✅ Toast 消息反馈

### 4. 向下兼容
- ✅ 保留原有单选功能
- ✅ 不影响现有业务流程
- ✅ 用户可自由选择核销方式

---

## 业务逻辑

### 核销规则

1. **使用所有预付款时**
   ```python
   # 按预付款日期倒序排列
   for prepay in all_prepays.order_by('-paid_date'):
       # 计算可用金额
       max_use = 应付余额 - 现金付款 - 已使用预付款

       if max_use < 0:
           max_use = 0

       # 使用预付款余额和可用金额中较小的一个
       use_amount = min(prepay.balance, max_use)

       if use_amount > 0:
           prepay.balance -= use_amount
           prepay.save()

       # 如果核销完毕，停止使用更多预付款
       if (已使用预付款 + 现金付款) >= 应付余额:
           break
   ```

2. **付款记录生成**
   - 每个使用的预付款生成一条付款记录
   - 记录描述包含预付款日期：`预付款冲抵（2025-01-15）`
   - 现金付款单独生成一条记录

3. **余额更新**
   - 应付账款余额 = 原余额 - (预付款总额 + 现金付款)
   - 预付款余额 = 原余额 - 已使用金额
   - 处理进位误差，确保结清时余额为0

---

## 数据示例

### 场景1：预付款总额 ≥ 应付余额

```
应付账款余额：¥12,000
可用预付款：
  - 2025-01-15 余额 ¥5,000
  - 2025-01-10 余额 ¥10,000
  总计：¥15,000

核销操作：选择"使用所有预付款"，现金付款填0

系统处理：
1. 使用 2025-01-15 预付款 ¥5,000
2. 使用 2025-01-10 预付款 ¥7,000（只需¥7,000即可结清）
3. 生成两条付款记录
4. 应付账款余额变为 ¥0
5. 预付款剩余余额：
   - 2025-01-15: ¥0
   - 2025-01-10: ¥3,000
```

### 场景2：预付款总额 < 应付余额

```
应付账款余额：¥20,000
可用预付款：
  - 2025-01-15 余额 ¥5,000
  - 2025-01-10 余额 ¥10,000
  总计：¥15,000

核销操作：选择"使用所有预付款"，现金付款填0

系统处理：
1. 使用 2025-01-15 预付款 ¥5,000
2. 使用 2025-01-10 预付款 ¥10,000
3. 生成两条付款记录
4. 应付账款余额变为 ¥5,000（仍需支付）
5. 提示用户：可补充填写现金付款金额
```

### 场景3：部分使用预付款

```
应付账款余额：¥12,000
可用预付款：
  - 2025-01-15 余额 ¥5,000
  - 2025-01-10 余额 ¥10,000
  总计：¥15,000

核销操作：选择"使用所有预付款"，现金付款填¥2,000

系统处理：
1. 使用 2025-01-15 预付款 ¥5,000
2. 使用 2025-01-10 预付款 ¥5,000（只需¥5,000即可）
3. 现金付款 ¥2,000
4. 总计核销 ¥12,000
5. 应付账款余额变为 ¥0
```

---

## API 接口

### 获取可用预付款

**接口**：`/finance/supplier-accounts/<id>/available-prepays/`

**方法**：GET

**响应示例**：
```json
{
    "success": true,
    "prepayments": [
        {
            "id": 1,
            "balance": "5000.00",
            "amount": "5000.00",
            "paid_date": "2025-01-15"
        },
        {
            "id": 2,
            "balance": "10000.00",
            "amount": "10000.00",
            "paid_date": "2025-01-10"
        }
    ],
    "account_balance": "12000.00"
}
```

---

## 技术实现

### 修改的文件

1. **apps/finance/views.py**
   - `supplier_account_writeoff()` - 核销视图
     - 添加 `use_all_prepays` 参数处理
     - 计算预付款总余额
     - 循环处理多个预付款

2. **templates/modules/finance/supplier_account_writeoff.html**
   - 添加"使用所有预付款"下拉选项
   - 简化JavaScript逻辑
   - 实时提示功能

### 关键代码

```python
# 视图处理
if prepay_id == 'ALL_PREPAY':
    use_all_prepays = True
else:
    use_all_prepays = False

if use_all_prepays and account.supplier:
    all_prepays = SupplierPrepayment.objects.filter(
        supplier=account.supplier,
        is_deleted=False,
        balance__gt=0
    ).order_by('-paid_date')

    for prepay in all_prepays:
        # 计算可用金额
        max_use = (account.balance - amount - effective_prepay_amount)
        if max_use < 0:
            max_use = Decimal('0')
        use_amount = min(prepay.balance, max_use)

        if use_amount > 0:
            prepay.balance -= use_amount
            prepay.save()
            used_prepays.append({
                'prepay': prepay,
                'amount': use_amount
            })
            effective_prepay_amount += use_amount

            # 如果核销完毕，停止
            if (effective_prepay_amount + amount) >= account.balance:
                break
```

---

## 用户界面效果

### 下拉框样式

- **"使用所有预付款"** 选项：
  - 加粗字体（`font-semibold`）
  - 主题色高亮（`text-theme-600`）
  - 星标前缀（⭐）
  - 显示总余额

- **分隔线**：
  - 禁用选项（`disabled`）
  - 横线视觉效果

- **单个预付款**：
  - 显示日期和余额
  - 普通样式

### 提示信息

```
选择"使用所有预付款"时：
提示: "将使用 2 个预付款，总余额 ¥15,000.00"
颜色: 主题色

选择单个预付款时：
提示: "已选择：2025-01-15 - 余额 ¥5,000.00"
颜色: 灰色

未选择时：
提示: "共 2 个预付款，总余额 ¥15,000.00"
颜色: 绿色
```

---

## 优势总结

✅ **简化操作**
- 一次选择使用所有预付款
- 无需多次手动选择
- 减少点击次数

✅ **智能处理**
- 自动计算使用金额
- 不会超额核销
- 按日期顺序合理使用

✅ **数据透明**
- 显示预付款总余额
- 实时刷新可用预付款
- 清晰的提示信息

✅ **灵活选择**
- 支持全部使用
- 支持单个使用
- 支持不使用预付款

---

## 实现日期
2026-02-07

## 版本
v1.0
