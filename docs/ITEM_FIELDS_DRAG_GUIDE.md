# 明细项字段拖拽排版指南

## 🎯 功能概述

现在你可以通过**拖拽单个字段**来自由设计报价单明细表格，无需使用固定的表格布局！

**传统方式 ❌：**
```
固定表格 → 12列固定布局 → 无法调整列顺序和位置
```

**新方式 ✅：**
```
拖拽字段 → 自由排列 → 像搭积木一样设计表格
```

---

## 🚀 快速开始

### 步骤1：打开模板编辑器

访问：`http://localhost:8000/sales/templates/<id>/edit/`

### 步骤2：查看明细项字段

在左侧元素库，找到 **"📦 明细项字段"** 分类：

```
📦 明细项字段
├─ 序号
├─ 产品编码
├─ 产品名称
├─ 规格型号 ⭐ 新增
├─ 数量
├─ 单位
├─ 单价
├─ 折扣率
├─ 税率
├─ 小计
├─ 交货期
└─ 备注
```

### 步骤3：拖拽字段到画布

**设计表头：**
1. 拖拽"序号"到画布（如Y坐标=100）
2. 拖拽"产品编码"到"序号"右边
3. 拖拽"产品名称"到"产品编码"右边
4. ... 依次排列所有需要的字段

**效果：**
```
Y=100: [序号] [产品编码] [产品名称] [规格型号] [数量] [单价] [小计]
       ↑      ↑          ↑          ↑          ↑      ↑      ↑
      拖拽   拖拽        拖拽        拖拽       拖拽   拖拽   拖拽
```

### 步骤4：调整字段样式

选中任意字段，在右侧属性面板调整：
- 宽度/高度
- 字体大小
- 对齐方式（左/中/右）
- 边框样式
- 背景色

### 步骤5：保存模板

点击"保存模板"按钮。

### 步骤6：打印预览

进入报价单详情页，点击"打印"查看效果。

**系统会自动：**
- 检测明细项字段元素
- 为每个明细项复制这些字段
- 自动调整Y坐标（每行间隔25px）
- 填充对应的数据

---

## 🚀 使用明细助手面板（推荐）

### 什么是明细助手？

**明细助手**是一个快速设计工具，帮你一键应用预设字段组合，无需手动拖拽每个字段。

### 如何使用？

#### 步骤1：打开明细助手

点击工具栏中的 **"📦 明细助手"** 按钮。

#### 步骤2：选择字段组合

明细助手提供3种预设组合：

**✨ 简洁版（6列）**
```
序号、产品名称、规格型号、数量、单价、小计
```
- 适合：日常报价单、简易出货单
- 总宽度：约670px（A4纵向适用）

**⭐ 标准版（9列）**
```
序号、产品编码、产品名称、规格型号、数量、单位、单价、小计、交货期
```
- 适合：正式报价单、采购订单
- 总宽度：约795px（A4横向或A3纵向）

**📊 完整版（12列）**
```
全部字段（含折扣率、税率、备注）
```
- 适合：详细报价单、合同附件
- 总宽度：约925px（A3纵向或A4横向）

点击任一组合，系统会自动添加所有字段到画布。

#### 步骤3：调整行高（可选）

使用滑块调整行高：
- **20-25px**：紧凑布局，适合明细项多的单据
- **25-30px**：标准布局，适合大多数场景
- **30-40px**：宽松布局，适合字体较大的单据

> 💡 提示：行高设置会保存到全局配置，在打印时生效。

#### 步骤4：使用对齐工具（可选）

**水平对齐**
- 将所有明细字段对齐到同一水平线
- 确保表格行看起来整齐

**均匀分布**
- 自动计算字段间距
- 让字段均匀分布在画布上

**清除字段**
- 一键删除所有明细项字段
- 重新开始设计

#### 步骤5：查看状态

面板底部会实时显示：
- 画布中已添加多少个明细字段
- 具体包含哪些字段

---

## 📋 手动拖拽 vs 明细助手

| 对比项 | 手动拖拽 | 明细助手 |
|--------|----------|----------|
| 速度 | 慢（每个字段单独拖） | 快（一键添加多个字段） |
| 灵活性 | ⭐⭐⭐⭐⭐ 完全自定义 | ⭐⭐⭐ 3种预设组合 |
| 对齐 | 需手动调整 | 自动对齐 |
| 适合场景 | 特殊布局、个性化需求 | 标准布局、快速设计 |

**推荐策略：**
1. 使用明细助手快速生成基础布局
2. 手动微调个别字段（位置、宽度、样式）
3. 保存模板

---

## 📊 可用字段列表

### 基本字段

| 字段名 | 中文名 | 默认宽度 | 对齐 | 数据示例 |
|--------|--------|----------|------|----------|
| `items.#.index` | 序号 | 40px | 居中 | 1, 2, 3... |
| `items.#.product_code` | 产品编码 | 100px | 左 | BL-001 |
| `items.#.product_name` | 产品名称 | 150px | 左 | 激光器A |

### 规格和单位

| 字段名 | 中文名 | 默认宽度 | 对齐 | 数据示例 |
|--------|--------|----------|------|----------|
| `items.#.specification` | 规格型号 ⭐ | 120px | 左 | 10W 红外激光器 |
| `items.#.unit` | 单位 | 50px | 居中 | 台、个、套 |

### 价格字段

| 字段名 | 中文名 | 默认宽度 | 对齐 | 数据示例 |
|--------|--------|----------|------|----------|
| `items.#.quantity` | 数量 | 60px | 右 | 10 |
| `items.#.unit_price` | 单价 | 80px | 右 | 1000.00 |
| `items.#.discount_rate` | 折扣率 | 60px | 居中 | 5% |
| `items.#.tax_rate` | 税率 | 50px | 居中 | 13% |
| `items.#.subtotal` | 小计 | 90px | 右 | 9500.00 |

### 其他字段

| 字段名 | 中文名 | 默认宽度 | 对齐 | 数据示例 |
|--------|--------|----------|------|----------|
| `items.#.lead_time` | 交货期 | 80px | 居中 | 30天 |
| `items.#.notes` | 备注 | 120px | 左 | 特殊要求... |

**字段说明：**
- `items.#.` 前缀表示这是明细项字段
- `#` 代表循环索引，系统自动处理

---

## 🎨 设计示例

### 示例1：简洁版（6列）

**字段选择：**
```
序号 | 产品名称 | 规格型号 | 数量 | 单价 | 小计
```

**拖拽布局：**
```
Y=100, X=20:   [序号 40px]
Y=100, X=70:   [产品名称 180px]
Y=100, X=260:  [规格型号 150px]
Y=100, X=420:  [数量 60px]
Y=100, X=490:  [单价 80px]
Y=100, X=580:  [小计 90px]
```

**打印效果：**
```
1  激光器A    10W 红外激光器    10   1000.00   10000.00
2  激光器B    20W 蓝光激光器    5    2000.00   10000.00
3  激光器C    30W 绿光激光器    3    3000.00   9000.00
```

### 示例2：完整版（12列）

**字段选择：** 全部12个字段

**拖拽技巧：**
1. 先排列关键列（序号、名称、数量、金额）
2. 再插入次要列（规格、单位、税率等）
3. 调整间距让布局美观

### 示例3：横向宽表（适合A3或横向A4）

**布局：**
```
[序号] [编码] [名称] [规格] [数量] [单位] [单价] [折扣] [税率] [小计] [交期] [备注]
  30   100    150    150     60     40     80     60     50     90     80     150
```

总宽度：1040px（适合A3或A4横向）

---

## ⚙️ 高级功能

### 1. 调整行高

**默认行高：** 25px

**修改方法：**
在 `/templates/sales/quote_print_hiprint.html` 第526行修改：

```javascript
var rowHeight = 25; // 改为 30, 35, 40 等
```

**建议值：**
- 紧凑布局：20-25px
- 标准布局：25-30px
- 宽松布局：30-40px

### 2. 添加表头

**方法1：使用普通文本元素**
```
1. 拖拽"文本"元素
2. 设置文本为"序号"
3. 放在明细项字段上方
4. 设置字体加粗、背景色
```

**方法2：使用横线分隔**
```
1. 拖拽"横线"元素
2. 放在表头和明细之间
3. 宽度设为表格总宽度
```

### 3. 添加边框

**为所有明细字段添加边框：**
```
默认已设置：
- borderWidth: 1
- borderColor: #d1d5db (浅灰色)
- borderStyle: solid
```

**自定义边框：**
选中字段 → 右侧属性 → 边框设置

### 4. 斑马纹效果

**需求：** 奇偶行不同背景色

**实现方法：**
修改 `processItemFieldsLoop()` 函数，添加：

```javascript
// 偶数行设置背景色
if (index % 2 === 0) {
    $clone.css('background-color', '#f9fafb');
}
```

---

## 🔧 技术细节

### 字段识别机制

系统通过以下方式识别明细项字段：

```javascript
// 查找所有 data-field 属性包含 items.#. 的元素
var $itemFields = $('[data-field]').filter(function() {
    var field = $(this).attr('data-field');
    return field && field.startsWith('items.#.');
});
```

### 循环复制逻辑

```javascript
// 为每个明细项（quoteData.items）
items.forEach(function(item, index) {
    // 复制所有明细项字段
    $itemFields.each(function() {
        var $clone = $(this).clone();

        // 调整Y坐标
        var newTop = originalTop + (index * rowHeight);
        $clone.css('top', newTop + 'px');

        // 填充数据
        $clone.text(getItemFieldValue(item, fieldName, index));

        // 添加到DOM
        $original.parent().append($clone);
    });
});
```

### 数据获取

```javascript
function getItemFieldValue(item, fieldName, index) {
    switch(fieldName) {
        case 'index':
            return index + 1;
        case 'specification':
            return item.specification || '-';
        // ... 其他字段
    }
}
```

---

## 📝 使用场景

### 场景1：极简报价单

**需求：** 只显示产品名称、数量、单价、小计

**设计：**
```
[产品名称 300px] [数量 80px] [单价 100px] [小计 120px]
```

### 场景2：详细报价单

**需求：** 显示所有12个字段

**设计：**
```
A4纵向不够宽，改用A4横向或A3
```

### 场景3：生产订单

**需求：** 突出规格型号和交货期

**设计：**
```
[编号] [产品名称] [规格型号 200px] [数量] [交货期 120px]
```

### 场景4：简易出库单

**需求：** 只要产品和数量

**设计：**
```
[序号] [产品编码] [产品名称 250px] [数量] [单位]
```

---

## ⚠️ 注意事项

### 1. HiPrint DOM结构

**注意：** HiPrint生成的DOM可能不使用`data-field`属性。

**调试步骤：**
1. 拖拽一个明细项字段到画布
2. 保存模板
3. 打开打印预览页面
4. 按F12查看元素的实际属性
5. 根据实际属性调整`processItemFieldsLoop()`函数

**常见属性：**
```html
<!-- 可能是这样： -->
<div class="hiprint-printElement" data-field="items.#.product_name">...</div>

<!-- 或这样： -->
<div class="hiprint-printElement">
    <span class="hiprint-printElement-text" data-value="items.#.product_name">...</span>
</div>
```

### 2. 第一行元素位置

**重要：** 所有明细项字段应该在**同一个Y坐标**上。

**原因：** 系统使用第一个字段的Y坐标作为起始位置。

**建议：**
1. 先排列第一行所有字段
2. 使用对齐工具确保同一水平线
3. 记录Y坐标值

### 3. 字段宽度规划

**总宽度限制：**
- A4纵向：约600-650px可打印区域
- A4横向：约800-850px
- A3纵向：约850-900px

**建议分配：**
```
重要字段（名称、金额）：150-200px
标准字段（数量、单价）：60-100px
次要字段（序号、单位）：30-50px
```

### 4. 数据字段映射

**确保数据字段与数据库一致：**

```javascript
// items数组必须包含所有字段
items: [{
    product_code: 'BL-001',
    product_name: '激光器',
    specification: '10W红外',  // 确保有这个字段
    unit: '台',
    quantity: 10,
    // ...
}]
```

---

## 🐛 故障排查

### 问题1：拖拽后看不到明细项字段

**可能原因：**
- 元素库未加载
- 浏览器缓存

**解决方法：**
```
1. 按 Ctrl+F5 强制刷新
2. 检查控制台是否显示：
   "✅ QuoteElementProvider 已加载 [版本: 2025-01-07-14:00]"
3. 检查元素分类是否包含"📦 明细项字段"
```

### 问题2：打印时明细项字段不循环

**检查步骤：**
```
1. 打开打印预览页面
2. 按F12查看控制台
3. 查看是否有：
   "🔄 开始处理明细项字段循环打印..."
   "找到 X 个明细项字段元素"
4. 如果没有找到元素，检查DOM结构
```

**调试代码：**
```javascript
// 在控制台执行
$('[data-field]').each(function() {
    console.log($(this).attr('data-field'));
});
```

### 问题3：字段位置重叠

**原因：** Y坐标相同，X坐标也相同

**解决方法：**
```
1. 在设计器中重新拖拽字段
2. 确保X坐标不同（水平间距至少10px）
```

### 问题4：数据显示为空或"-"

**检查数据：**
```javascript
// 控制台查看
console.log(quoteData.items);

// 确认字段存在
console.log(quoteData.items[0].specification);
```

---

## 💡 最佳实践

### 1. 设计流程

```
第一步：规划字段
       列出需要显示的字段，确定优先级

第二步：选择画布
       根据字段数量选择纸张大小和方向

第三步：拖拽排列
       先拖拽重要字段，再添加次要字段

第四步：对齐调整
       使用标尺或网格对齐所有字段

第五步：样式美化
       设置边框、字体、对齐方式

第六步：测试打印
       用测试数据查看效果，调整间距
```

### 2. 性能优化

**大量明细项（>50行）：**
```
- 减少字段数量（只保留必要字段）
- 减小字体（10px）
- 缩小行高（20px）
```

### 3. 多模板策略

```
模板1: 简洁版（6列） - 日常使用
模板2: 详细版（12列） - 正式报价
模板3: 生产版（突出规格和交期）
```

---

## 🚀 未来计划

**计划中的功能：**
- [ ] 可视化行高调整器
- [ ] 明细项分组（按类别）
- [ ] 明细项小计行
- [ ] 自动换页功能
- [ ] 表头自动重复

---

## 📚 相关文档

- **表格字段自定义**：`docs/CUSTOMIZE_TABLE_FIELDS.md`
- **HiPrint功能说明**：`docs/HIPRINT_TABLE_WORKAROUND.md`
- **更新日志**：`docs/HIPRINT_UPDATE_LOG.md`

---

**文档版本：** v1.0
**更新日期：** 2025-01-07
**功能状态：** ✅ 可用（测试版）
**维护者：** BetterLaser ERP 开发团队
