name: Django ERP CI/CD 测试流水线

# 触发条件
on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天凌晨2点运行（夜间构建）
    - cron: '0 2 * * *'

# 环境变量
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: 代码质量检查
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: 代码格式检查 (Black)
      run: |
        black --check apps/
      continue-on-error: true

    - name: 导入排序检查 (isort)
      run: |
        isort --check-only apps/
      continue-on-error: true

    - name: 代码风格检查 (Flake8)
      run: |
        flake8 apps/ --max-line-length=120 --exclude=migrations
      continue-on-error: true

    - name: 代码质量检查 (Pylint)
      run: |
        pylint apps/ --disable=C0111,R0903 --max-line-length=120
      continue-on-error: true

  # Job 2: 安全扫描
  security-scan:
    name: 安全扫描
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety

    - name: Bandit安全扫描
      run: |
        bandit -r apps/ -f json -o bandit-report.json
      continue-on-error: true

    - name: Safety依赖检查
      run: |
        safety check --json > safety-report.json
      continue-on-error: true

    - name: 上传安全报告
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # Job 3: 单元测试 (SQLite)
  unit-tests-sqlite:
    name: 单元测试 (SQLite)
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: 运行数据库迁移
      env:
        DJANGO_SETTINGS_MODULE: better_laser_erp.settings
      run: |
        python manage.py migrate

    - name: 运行单元测试
      env:
        DJANGO_SETTINGS_MODULE: better_laser_erp.settings
      run: |
        pytest apps/ -m "unit or not (integration or api or e2e)" \
          --cov=apps \
          --cov-report=xml \
          --cov-report=term-missing \
          -v

    - name: 上传覆盖率报告到Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-sqlite

  # Job 4: 集成测试 (MySQL)
  integration-tests-mysql:
    name: 集成测试 (MySQL)
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: erp_test
          MYSQL_USER: erp_user
          MYSQL_PASSWORD: erp_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        pip install mysqlclient

    - name: 等待MySQL准备就绪
      run: |
        until mysqladmin ping -h"127.0.0.1" -P"3306" -u"erp_user" -p"erp_password" --silent; do
          echo "等待MySQL..."
          sleep 2
        done

    - name: 运行数据库迁移
      env:
        DB_ENGINE: django.db.backends.mysql
        DB_NAME: erp_test
        DB_USER: erp_user
        DB_PASSWORD: erp_password
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
      run: |
        python manage.py migrate

    - name: 运行集成测试
      env:
        DB_ENGINE: django.db.backends.mysql
        DB_NAME: erp_test
        DB_USER: erp_user
        DB_PASSWORD: erp_password
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        REDIS_HOST: 127.0.0.1
        REDIS_PORT: 6379
      run: |
        pytest apps/ -m "integration" \
          --cov=apps \
          --cov-report=xml \
          --cov-report=term-missing \
          -v

    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: integration
        name: codecov-mysql

  # Job 5: API测试
  api-tests:
    name: API测试
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt

    - name: 运行数据库迁移
      run: |
        python manage.py migrate

    - name: 运行API测试
      run: |
        pytest apps/ -m "api" \
          --cov=apps \
          --cov-report=xml \
          --cov-report=term-missing \
          -v

    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: api
        name: codecov-api

  # Job 6: 端到端测试 (E2E)
  e2e-tests:
    name: 端到端测试
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
        npm install
        playwright install chromium

    - name: 构建前端资源
      run: |
        npm run build

    - name: 运行数据库迁移
      run: |
        python manage.py migrate

    - name: 创建测试用户
      run: |
        python manage.py shell -c "
        from apps.users.models import User
        User.objects.create_superuser('admin', 'admin@test.com', 'admin123')
        "

    - name: 启动Django服务器
      run: |
        python manage.py runserver &
        sleep 5

    - name: 运行E2E测试
      run: |
        pytest tests/e2e/ -v
      continue-on-error: true

    - name: 上传E2E测试截图
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: e2e-screenshots
        path: tests/e2e/screenshots/

  # Job 7: 测试报告汇总
  test-summary:
    name: 测试报告汇总
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, unit-tests-sqlite, integration-tests-mysql, api-tests]
    if: always()

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 下载所有测试报告
      uses: actions/download-artifact@v4

    - name: 生成测试摘要
      run: |
        echo "## 测试结果摘要" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| 测试类型 | 状态 |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| 代码质量检查 | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| 安全扫描 | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| 单元测试 (SQLite) | ${{ needs.unit-tests-sqlite.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| 集成测试 (MySQL) | ${{ needs.integration-tests-mysql.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| API测试 | ${{ needs.api-tests.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: 通知测试结果
      if: failure()
      run: |
        echo "⚠️ 测试失败！请查看详细日志。"
