# 预付款/预收款编辑删除功能

## 功能概述

为预付款/预收款添加编辑和删除功能，避免误操作无法修正的问题。

## 功能特性

### 1. 编辑功能

#### 业务规则：
- ✅ 允许编辑备注信息（始终可编辑）
- ✅ 未被使用的预付款可编辑金额、日期和备注
- ⚠️ 已被使用的预付款只能编辑备注（金额和日期不可修改）
- ❌ 已合并的预付款不允许编辑

#### 编辑限制说明：
**为什么已使用的预付款不能修改金额和日期？**
- 预付款可能已被用于核销应收/应付账款
- 修改金额会导致账务不一致
- 修改日期会影响财务报表准确性
- 只允许编辑备注，保证数据安全

### 2. 删除功能

#### 业务规则：
- ✅ 使用软删除机制（is_deleted=True）
- ✅ 有余额的预付款需要确认后才能删除
- ✅ 无余额的预付款可直接删除
- ❌ 已合并的预付款不允许删除
- ✅ 记录删除人、删除时间

#### 软删除优势：
- 数据不会真正从数据库中删除
- 可追溯删除历史
- 必要时可恢复数据
- 符合审计要求

## 实现内容

### 1. 视图函数（apps/finance/views.py）

#### 新增视图：
- `supplier_prepayment_edit(pk)` - 编辑供应商预付款
- `supplier_prepayment_delete(pk)` - 删除供应商预付款
- `customer_prepayment_edit(pk)` - 编辑客户预收款
- `customer_prepayment_delete(pk)` - 删除客户预收款

#### 视图逻辑：

**编辑视图：**
```python
# 检查是否已合并
if prepay.status == 'merged':
    messages.warning(request, '该预付款已被合并，无法编辑')
    return redirect(...)

# 检查是否已被使用
has_usage = prepay.balance < prepay.amount

# 根据使用情况决定可编辑的字段
if not has_usage:
    # 未被使用：可编辑金额、日期、备注
    prepay.notes = request.POST.get('notes', '')
    prepay.paid_date = request.POST.get('paid_date')
else:
    # 已被使用：只能编辑备注
    prepay.notes = request.POST.get('notes', '')
```

**删除视图：**
```python
# 检查是否已合并
if prepay.status == 'merged':
    messages.warning(request, '该预付款已被合并，无法删除')
    return redirect(...)

# 有余额需要确认
if prepay.balance > 0:
    if request.method == 'POST':
        # 执行软删除
        prepay.is_deleted = True
        prepay.deleted_by = request.user
        prepay.deleted_at = timezone.now()
        prepay.save()
else:
    # 无余额，直接删除
    prepay.is_deleted = True
    prepay.deleted_by = request.user
    prepay.deleted_at = timezone.now()
    prepay.save()
```

### 2. URL路由（apps/finance/urls.py）

```python
path('prepayments/customer/<int:pk>/edit/', views.customer_prepayment_edit, name='customer_prepayment_edit'),
path('prepayments/customer/<int:pk>/delete/', views.customer_prepayment_delete, name='customer_prepayment_delete'),
path('prepayments/supplier/<int:pk>/edit/', views.supplier_prepayment_edit, name='supplier_prepayment_edit'),
path('prepayments/supplier/<int:pk>/delete/', views.supplier_prepayment_delete, name='supplier_prepayment_delete'),
```

### 3. 模板文件

#### 更新的模板：
- `supplier_prepayment_form.html` - 支持新建和编辑模式
- `customer_prepayment_form.html` - 支持新建和编辑模式
- `supplier_prepayment_list.html` - 添加编辑和删除按钮
- `customer_prepayment_list.html` - 添加编辑和删除按钮

#### 新增的模板：
- `supplier_prepayment_confirm_delete.html` - 供应商预付款删除确认页面
- `customer_prepayment_confirm_delete.html` - 客户预收款删除确认页面

### 4. 表单模板功能

#### 新建模式：
- 可选择供应商/客户
- 可编辑金额、日期、备注
- 提交后创建新记录

#### 编辑模式：
- 显示当前信息（蓝色提示框）
- 供应商/客户不可修改
- 已使用时显示警告（黄色提示框）
- 金额和日期根据使用情况显示为只读或可编辑
- 始终可编辑备注

#### 删除确认页面：
- 显示预付款详细信息
- 有余额时显示警告
- 红色警告框说明不可撤销
- 取消/确认按钮

## 使用方法

### 编辑预付款/预收款

1. **进入列表页**
   - 供应商预付款：http://127.0.0.1:8000/finance/prepayments/supplier/
   - 客户预收款：http://127.0.0.1:8000/finance/prepayments/customer/

2. **点击编辑按钮**
   - 在操作列点击 📝 图标

3. **编辑信息**
   - 未被使用：可修改金额、日期、备注
   - 已被使用：只能修改备注
   - 已合并：不允许编辑

4. **保存修改**
   - 点击"更新"按钮

### 删除预付款/预收款

1. **进入列表页**
   - 同上

2. **点击删除按钮**
   - 在操作列点击 🗑️ 图标

3. **确认删除**
   - 查看详细信息
   - 查看余额警告
   - 点击"确认删除"按钮

4. **完成删除**
   - 记录将被软删除
   - 列表中不再显示
   - 数据仍保留在数据库

## 界面展示

### 编辑页面 - 未被使用
```
┌─────────────────────────────────────┐
│ 编辑预付款                          │
├─────────────────────────────────────┤
│ 供应商：[测试供应商丙] (只读)        │
│ 金额：[50000.00]                    │
│ 付款日期：[2026-02-04]              │
│ 备注：[第一季度预付款]               │
│                                      │
│ [取消] [更新]                        │
└─────────────────────────────────────┘
```

### 编辑页面 - 已被使用
```
┌─────────────────────────────────────┐
│ ⚠️ 预付款已被使用                  │
│ 该预付款已被部分使用，当前余额      │
│ ¥30000.00（原金额 ¥50000.00）。     │
│ 由于已有使用记录，您只能编辑备注    │
│ 信息，无法修改金额和日期。          │
├─────────────────────────────────────┤
│ ℹ️ 编辑说明                         │
│ 供应商：测试供应商丙                │
│ 原金额：¥50000.00                   │
│ 当前余额：¥30000.00                 │
├─────────────────────────────────────┤
│ 供应商：[测试供应商丙] (只读)        │
│ 金额：[¥50000.00] (只读)            │
│ 付款日期：[2026-02-04] (只读)       │
│ 备注：[第一季度预付款] (可编辑)     │
│                                      │
│ [取消] [更新]                        │
└─────────────────────────────────────┘
```

### 删除确认页面
```
┌─────────────────────────────────────┐
│         🗑️                          │
│     确认删除预付款？                 │
├─────────────────────────────────────┤
│ 预付款详情                          │
│ 供应商：测试供应商丙                │
│ 预付金额：¥50000.00                 │
│ 剩余余额：¥50000.00                 │
│ 付款日期：2026-02-04                │
│ 备注：第一季度预付款                │
├─────────────────────────────────────┤
│ ⚠️ 注意                             │
│ 该预付款仍有余额 ¥50000.00，        │
│ 删除后将无法使用此余额进行核销。    │
├─────────────────────────────────────┤
│ ⛔ 警告                             │
│ 此操作将软删除该预付款记录。        │
│ 删除后记录将不再在列表中显示，      │
│ 但数据仍保留在数据库中。            │
│ 此操作不可撤销。                    │
├─────────────────────────────────────┤
│          [取消] [确认删除]          │
└─────────────────────────────────────┘
```

## 列表页面更新

### 操作列
```
┌──────┬────────┬────────┬───────┬────────┬────────┐
│ 供应商 │ 金额   │ 余额    │ 日期   │ 备注    │ 操作    │
├──────┼────────┼────────┼───────┼────────┼────────┤
│ 供应商丙│50000  │ 50000  │02-04  │ 备注一  │📝 🗑️  │
│ 供应商丙│50000  │ 50000  │02-04  │ 备注二  │📝 🗑️  │
└──────┴────────┴────────┴───────┴────────┴────────┘
        📝 = 编辑按钮
        🗑️ = 删除按钮
```

## 安全机制

### 1. 编辑保护
- ✅ 已合并的记录不允许编辑
- ✅ 已使用的记录限制编辑字段
- ✅ 供应商/客户不可修改（保持数据一致性）

### 2. 删除保护
- ✅ 已合并的记录不允许删除
- ✅ 有余额的记录需要确认
- ✅ 软删除机制，数据可恢复
- ✅ 记录删除人和删除时间

### 3. 用户体验
- ✅ 清晰的警告和提示信息
- ✅ 禁用不可编辑的字段（视觉反馈）
- ✅ 删除确认页面展示详细信息
- ✅ 颜色编码（蓝色=信息，黄色=警告，红色=危险）

## 业务场景

### 场景1：修正错误
**问题**：新建预付款时备注写错了
**解决**：点击编辑 → 修改备注 → 保存

### 场景2：调整日期
**问题**：预付款日期填错了，还未使用
**解决**：点击编辑 → 修改日期 → 保存

### 场景3：删除误操作
**问题**：不小心创建了重复的预付款
**解决**：点击删除 → 确认删除（软删除）

### 场景4：已使用记录
**问题**：预付款已核销部分，想修改备注
**解决**：点击编辑 → 只能修改备注 → 保存
**限制**：金额和日期不可修改（保证账务一致）

## 相关功能

### 与合并功能的配合：
1. 合并后的原记录不允许编辑/删除
2. 合并后的新记录可以编辑/删除
3. 删除合并记录不会影响原记录的状态

### 与核销功能的配合：
1. 已核销的预付款显示使用情况
2. 删除有余额的预付款会提示警告
3. 编辑已核销的记录有字段限制

## 技术特点

1. **软删除机制**
   - 使用 `is_deleted` 字段标记删除
   - 记录 `deleted_by` 和 `deleted_at`
   - 数据不会真正删除

2. **状态检查**
   - 检查 `status` 字段（active/merged）
   - 检查 `balance` 字段判断是否已使用
   - 根据状态决定允许的操作

3. **用户体验**
   - 清晰的视觉反馈（颜色、图标）
   - 详细的警告和说明
   - 合理的字段禁用逻辑

## 后续建议

1. **批量删除**
   - 可考虑添加批量删除功能
   - 需要更严格的权限控制

2. **回收站功能**
   - 显示已删除的记录
   - 支持恢复操作

3. **审核流程**
   - 重要操作可加入审核流程
   - 预付款删除需要审批

## 总结

预付款/预收款编辑删除功能完整实现了用户需求，通过软删除、状态检查和字段限制等机制，在保证数据安全的前提下，提供了灵活的修正能力。清晰的UI提示和合理的业务规则，确保用户能够安全地管理预付款/预收款记录。
