"""
Purchase models tests.
"""
from django.test import TestCase
from django.contrib.auth import get_user_model
from django.utils import timezone
from decimal import Decimal
from datetime import timedelta

from apps.purchase.models import (
    PurchaseOrder, PurchaseOrderItem,
    PurchaseInquiry, PurchaseInquiryItem,
    SupplierQuotation, SupplierQuotationItem,
    QualityInspection, QualityInspectionItem
)
from apps.suppliers.models import Supplier
from apps.products.models import Product, ProductCategory, Unit

User = get_user_model()


class PurchaseOrderModelTest(TestCase):
    """Purchase order model tests."""

    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            email='testuser@test.com',
            password='testpass123'
        )

        self.supplier = Supplier.objects.create(
            name='测试供应商',
            code='SUP001',
            created_by=self.user
        )

        self.category = ProductCategory.objects.create(
            name='测试分类',
            code='CAT001',
            created_by=self.user
        )

        self.unit = Unit.objects.create(
            name='件',
            symbol='pcs',
            created_by=self.user
        )

        self.product = Product.objects.create(
            name='测试产品',
            code='PROD001',
            category=self.category,
            unit=self.unit,
            selling_price=Decimal('100.00'),
            created_by=self.user
        )

        self.order = PurchaseOrder.objects.create(
            order_number='PO2025110001',
            supplier=self.supplier,
            order_date=timezone.now().date(),
            required_date=timezone.now().date() + timedelta(days=7),
            created_by=self.user
        )

    def test_order_creation(self):
        """Test purchase order creation."""
        self.assertEqual(self.order.order_number, 'PO2025110001')
        self.assertEqual(self.order.supplier, self.supplier)
        self.assertEqual(self.order.status, 'draft')

    def test_order_calculate_totals(self):
        """Test purchase order totals calculation."""
        # Add order items
        PurchaseOrderItem.objects.create(
            order=self.order,
            product=self.product,
            quantity=10,
            unit_price=Decimal('80.00'),
            created_by=self.user
        )

        self.order.calculate_totals()
        self.order.save()

        # Expected: 10 * 80 = 800
        self.assertEqual(self.order.subtotal, Decimal('800.00'))

    def test_order_str_representation(self):
        """Test purchase order string representation."""
        expected = f"PO2025110001 - {self.supplier.name}"
        self.assertEqual(str(self.order), expected)


class PurchaseInquiryModelTest(TestCase):
    """Purchase inquiry model tests."""

    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            email='testuser@test.com',
            password='testpass123'
        )

        self.supplier = Supplier.objects.create(
            name='测试供应商',
            code='SUP001',
            created_by=self.user
        )

        self.category = ProductCategory.objects.create(
            name='测试分类',
            code='CAT001',
            created_by=self.user
        )

        self.unit = Unit.objects.create(
            name='件',
            symbol='pcs',
            created_by=self.user
        )

        self.product = Product.objects.create(
            name='测试产品',
            code='PROD001',
            category=self.category,
            unit=self.unit,
            selling_price=Decimal('100.00'),
            created_by=self.user
        )

        self.inquiry = PurchaseInquiry.objects.create(
            inquiry_number='RFQ2025110001',
            title='测试询价',
            inquiry_date=timezone.now().date(),
            deadline=timezone.now().date() + timedelta(days=7),
            required_date=timezone.now().date() + timedelta(days=7),
            created_by=self.user
        )

    def test_inquiry_creation(self):
        """Test purchase inquiry creation."""
        self.assertEqual(self.inquiry.inquiry_number, 'RFQ2025110001')
        self.assertEqual(self.inquiry.status, 'draft')

    def test_inquiry_str_representation(self):
        """Test inquiry string representation."""
        # Inquiry __str__ returns inquiry_number - title
        expected = f"RFQ2025110001 - 测试询价"
        self.assertEqual(str(self.inquiry), expected)


class QualityInspectionModelTest(TestCase):
    """Quality inspection model tests."""

    def setUp(self):
        """Set up test data."""
        self.user = User.objects.create_user(
            username='testuser',
            email='testuser@test.com',
            password='testpass123'
        )

        self.supplier = Supplier.objects.create(
            name='测试供应商',
            code='SUP001',
            created_by=self.user
        )

        self.category = ProductCategory.objects.create(
            name='测试分类',
            code='CAT001',
            created_by=self.user
        )

        self.unit = Unit.objects.create(
            name='件',
            symbol='pcs',
            created_by=self.user
        )

        self.product = Product.objects.create(
            name='测试产品',
            code='PROD001',
            category=self.category,
            unit=self.unit,
            selling_price=Decimal('100.00'),
            created_by=self.user
        )

        self.order = PurchaseOrder.objects.create(
            order_number='PO2025110001',
            supplier=self.supplier,
            order_date=timezone.now().date(),
            created_by=self.user
        )

        self.inspection = QualityInspection.objects.create(
            inspection_number='QC2025110001',
            source_type='purchase_receipt',
            source_id=1,
            source_number='PR2025110001',
            inspection_date=timezone.now().date(),
            product=self.product,
            quantity=Decimal('100.00'),
            created_by=self.user
        )

    def test_inspection_creation(self):
        """Test quality inspection creation."""
        self.assertEqual(self.inspection.inspection_number, 'QC2025110001')
        self.assertEqual(self.inspection.product, self.product)
        self.assertEqual(self.inspection.status, 'pending')

    def test_inspection_pass_rate_calculation(self):
        """Test inspection pass rate calculation."""
        self.inspection.passed_quantity = Decimal('95.00')
        self.inspection.failed_quantity = Decimal('5.00')
        self.inspection.calculate_pass_rate()
        self.inspection.save()

        # Expected: 95/100 = 95%
        self.assertEqual(self.inspection.pass_rate, Decimal('95.00'))

    def test_inspection_str_representation(self):
        """Test inspection string representation."""
        expected = f"QC2025110001 - {self.product.name}"
        self.assertEqual(str(self.inspection), expected)
