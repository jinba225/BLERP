"""
æ¨¡æ¿é€‰æ‹©æœåŠ¡

æä¾›æ¨¡æ¿é€‰æ‹©å’Œé»˜è®¤æ¨¡æ¿è·å–åŠŸèƒ½ï¼Œæ”¯æŒåŸºäºå¤§ç±»å’Œé€‚ç”¨æ€§çš„æ™ºèƒ½æ’åºã€‚
"""
from apps.sales.models import PrintTemplate, DefaultTemplateMapping


class TemplateSelector:
    """æ¨¡æ¿é€‰æ‹©æœåŠ¡"""

    # å•æ®ç±»å‹åˆ°æ¨¡æ¿ç±»åˆ«çš„æ˜ å°„
    DOCUMENT_CATEGORY_MAP = {
        # é”€å”®ç±»
        'quote': 'sales',
        'sales_order': 'sales',
        'delivery': 'sales',
        'sales_return': 'sales',

        # é‡‡è´­ç±»
        'purchase_order': 'purchase',
        'purchase_receipt': 'purchase',
        'purchase_return': 'purchase',

        # åº“å­˜ç±»
        'stock_in': 'inventory',
        'stock_out': 'inventory',
        'stock_transfer': 'inventory',
        'stock_check': 'inventory',

        # è´¢åŠ¡ç±»
        'invoice': 'finance',
        'payment': 'finance',
        'receipt': 'finance',
    }

    @classmethod
    def get_available_templates(cls, document_type, category=None):
        """
        è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨

        Args:
            document_type: å•æ®ç±»å‹ï¼ˆå¦‚ 'quote', 'sales_order'ï¼‰
            category: æ¨¡æ¿ç±»åˆ«ï¼ˆå¦‚ 'sales'ï¼‰ï¼Œä¸ä¼ åˆ™è‡ªåŠ¨åˆ¤æ–­

        Returns:
            list[PrintTemplate]: æŒ‰ç›¸å…³åº¦æ’åºçš„æ¨¡æ¿åˆ—è¡¨
        """
        # 1. ç¡®å®šæ¨¡æ¿ç±»åˆ«
        if not category:
            category = cls._get_category_by_document_type(document_type)

        # 2. è·å–è¯¥ç±»åˆ«çš„æ‰€æœ‰å¯ç”¨æ¨¡æ¿
        templates = list(
            PrintTemplate.objects.filter(
                template_category=category,
                is_active=True,
                is_deleted=False
            )
        )

        # 3. æŒ‰ç›¸å…³åº¦æ’åºï¼ˆåŒ…å«å½“å‰å•æ®ç±»å‹çš„ä¼˜å…ˆï¼‰
        def get_priority(template):
            """è®¡ç®—æ¨¡æ¿ä¼˜å…ˆçº§"""
            if document_type in template.suitable_for:
                return 2  # é«˜ä¼˜å…ˆçº§ï¼šæ˜ç¡®é€‚ç”¨
            elif not template.suitable_for:
                return 1  # ä¸­ä¼˜å…ˆçº§ï¼šé€šç”¨æ¨¡æ¿ï¼ˆç©ºåˆ—è¡¨è¡¨ç¤ºé€šç”¨ï¼‰
            else:
                return 0  # ä½ä¼˜å…ˆçº§ï¼šä¸å¤ªé€‚ç”¨

        templates.sort(key=get_priority, reverse=True)
        return templates

    @classmethod
    def get_default_template(cls, document_type_full):
        """
        è·å–é»˜è®¤æ¨¡æ¿

        Args:
            document_type_full: å®Œæ•´å•æ®ç±»å‹ï¼ˆå¦‚ 'quote_domestic', 'quote_overseas'ï¼‰
                              ç”¨äºæŸ¥æ‰¾ç²¾ç¡®çš„é»˜è®¤æ˜ å°„

        Returns:
            PrintTemplate or None: é»˜è®¤æ¨¡æ¿ï¼Œæ‰¾ä¸åˆ°åˆ™è¿”å› None
        """
        try:
            # 1. å°è¯•ä»é»˜è®¤æ˜ å°„è¡¨è·å–
            mapping = DefaultTemplateMapping.objects.filter(
                document_type=document_type_full,
                is_deleted=False
            ).select_related('template').first()

            if mapping and mapping.template and mapping.template.is_active:
                return mapping.template

        except DefaultTemplateMapping.DoesNotExist:
            pass

        # 2. é™çº§æ–¹æ¡ˆï¼šè¿”å›è¯¥ç±»åˆ«ç¬¬ä¸€ä¸ªå¯ç”¨æ¨¡æ¿
        # æå–åŸºç¡€å•æ®ç±»å‹ï¼ˆå¦‚ 'quote_domestic' â†’ 'quote'ï¼‰
        document_type = document_type_full.split('_')[0]
        templates = cls.get_available_templates(document_type)
        return templates[0] if templates else None

    @classmethod
    def _get_category_by_document_type(cls, document_type):
        """
        æ ¹æ®å•æ®ç±»å‹æ¨æ–­æ¨¡æ¿ç±»åˆ«

        Args:
            document_type: å•æ®ç±»å‹ï¼ˆå¦‚ 'quote', 'sales_order'ï¼‰

        Returns:
            str: æ¨¡æ¿ç±»åˆ«ï¼ˆ'sales', 'purchase', 'inventory', 'finance', 'other'ï¼‰
        """
        return cls.DOCUMENT_CATEGORY_MAP.get(document_type, 'other')

    @classmethod
    def get_category_display_name(cls, category):
        """
        è·å–æ¨¡æ¿ç±»åˆ«çš„æ˜¾ç¤ºåç§°

        Args:
            category: ç±»åˆ«ä»£ç ï¼ˆå¦‚ 'sales'ï¼‰

        Returns:
            str: æ˜¾ç¤ºåç§°ï¼ˆå¦‚ 'ğŸ“Š é”€å”®ç±»'ï¼‰
        """
        category_map = dict(PrintTemplate.CATEGORY_CHOICES)
        return category_map.get(category, category)
