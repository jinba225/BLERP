"""
Sales模块 - API和视图测试
测试Sales模块的API端点和视图
"""

from django.test import TestCase, Client
from django.urls import reverse
from django.contrib.auth import get_user_model
from rest_framework import status
from decimal import Decimal
from datetime import date, timedelta

from apps.sales.models import Quote, SalesOrder, SalesOrderItem, Delivery, SalesReturn
from apps.customers.models import Customer, CustomerCategory
from apps.products.models import Product, Unit, ProductCategory
from apps.departments.models import Department
from apps.inventory.models import Warehouse

User = get_user_model()


class SalesAPITestCaseBase(TestCase):
    """Sales API测试基类 - 准备测试数据"""

    def setUp(self):
        """每个测试前执行 - 创建测试数据"""
        # 创建测试用户
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123',
            email='test@example.com',
            employee_id='EMP001'
        )

        # 创建部门（用户需要）
        self.department = Department.objects.create(
            name='销售部',
            code='SALES',
            created_by=self.user
        )
        self.user.department = self.department
        self.user.save()

        # 使用Django Client并登录
        self.client = Client()
        self.client.login(username='testuser', password='testpass123')

        # 创建客户分类
        self.customer_category = CustomerCategory.objects.create(
            name='优质客户',
            code='VIP',
            created_by=self.user
        )

        # 创建测试客户
        self.customer = Customer.objects.create(
            name='测试客户A公司',
            code='CUS001',
            customer_level='A',  # 客户等级：A/B/C/D
            status='active',
            category=self.customer_category,
            address='北京市朝阳区测试路123号',
            city='北京',
            province='北京市',
            credit_limit=Decimal('1000000.00'),
            created_by=self.user
        )

        # 创建产品分类
        self.product_category = ProductCategory.objects.create(
            name='激光设备',
            code='LASER',
            created_by=self.user
        )

        # 创建单位
        self.unit = Unit.objects.create(
            name='台',
            symbol='台',
            created_by=self.user
        )

        # 创建测试产品
        self.product1 = Product.objects.create(
            name='激光切割机A型',
            code='PRD001',
            specifications='3000W 光纤激光切割机',  # 注意是specifications
            category=self.product_category,
            unit=self.unit,
            cost_price=Decimal('80000.00'),
            selling_price=Decimal('100000.00'),  # 注意是selling_price
            status='active',
            created_by=self.user
        )

        self.product2 = Product.objects.create(
            name='激光打标机B型',
            code='PRD002',
            specifications='20W 光纤激光打标机',
            category=self.product_category,
            unit=self.unit,
            cost_price=Decimal('8000.00'),
            selling_price=Decimal('10000.00'),
            status='active',
            created_by=self.user
        )

        # 创建仓库
        self.warehouse = Warehouse.objects.create(
            name='主仓库',
            code='WH001',
            created_by=self.user
        )


class CustomerInfoAPITestCase(SalesAPITestCaseBase):
    """客户信息API测试"""

    def test_get_customer_info_success(self):
        """测试获取客户信息 - 成功"""
        url = reverse('sales:api_customer_info', args=[self.customer.id])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('id', response.data)
        self.assertEqual(response.data['name'], '测试客户A公司')
        self.assertEqual(response.data['code'], 'CUS001')
        self.assertIn('contact', response.data)  # 默认联系人
        self.assertIn('phone', response.data)

    def test_get_customer_info_not_found(self):
        """测试获取客户信息 - 客户不存在"""
        url = reverse('sales:api_customer_info', args=[99999])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)

    def test_get_customer_info_unauthorized(self):
        """测试获取客户信息 - 未授权"""
        self.client.force_authenticate(user=None)
        url = reverse('sales:api_customer_info', args=[self.customer.id])
        response = self.client.get(url)

        # Django传统视图可能返回302重定向到登录页
        self.assertIn(response.status_code, [status.HTTP_401_UNAUTHORIZED, status.HTTP_302_FOUND])


class ProductInfoAPITestCase(SalesAPITestCaseBase):
    """产品信息API测试"""

    def test_get_product_info_success(self):
        """测试获取产品信息 - 成功"""
        url = reverse('sales:api_product_info', args=[self.product1.id])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('id', response.data)
        self.assertEqual(response.data['name'], '激光切割机A型')
        self.assertEqual(response.data['code'], 'PRD001')
        self.assertEqual(Decimal(response.data['selling_price']), Decimal('100000.00'))
        self.assertIn('unit', response.data)
        self.assertIn('specifications', response.data)

    def test_get_product_info_not_found(self):
        """测试获取产品信息 - 产品不存在"""
        url = reverse('sales:api_product_info', args=[99999])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)

    def test_get_product_info_price_check(self):
        """测试获取产品信息 - 价格字段验证"""
        url = reverse('sales:api_product_info', args=[self.product2.id])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        # 验证价格是Decimal类型或字符串（JSON序列化）
        selling_price = Decimal(response.data['selling_price'])
        self.assertEqual(selling_price, Decimal('10000.00'))
        self.assertGreater(selling_price, Decimal('0'))


class QuoteAPITestCase(SalesAPITestCaseBase):
    """报价单API测试（传统视图转换为API测试）"""

    def test_quote_list_view(self):
        """测试报价单列表访问"""
        # 创建测试报价单
        quote1 = Quote.objects.create(
            quote_number='QT20260106001',
            customer=self.customer,
            quote_date=date.today(),
            valid_until=date.today() + timedelta(days=30),
            status='draft',
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            total_amount=Decimal('113000.00'),
            created_by=self.user
        )

        quote2 = Quote.objects.create(
            quote_number='QT20260106002',
            customer=self.customer,
            quote_date=date.today(),
            valid_until=date.today() + timedelta(days=30),
            status='sent',
            subtotal=Decimal('50000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('6500.00'),
            total_amount=Decimal('56500.00'),
            created_by=self.user
        )

        # 访问报价单列表（使用GET请求）
        url = reverse('sales:quote_list')
        response = self.client.get(url)

        # Django视图返回HTML，状态应该是200
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        # 验证模板使用
        self.assertTemplateUsed(response, 'sales/quote_list.html')

    def test_quote_detail_view(self):
        """测试报价单详情访问"""
        quote = Quote.objects.create(
            quote_number='QT20260106003',
            customer=self.customer,
            quote_date=date.today(),
            valid_until=date.today() + timedelta(days=30),
            status='draft',
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            total_amount=Decimal('113000.00'),
            created_by=self.user
        )

        url = reverse('sales:quote_detail', args=[quote.pk])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/quote_detail.html')
        self.assertContains(response, quote.quote_number)


class SalesOrderAPITestCase(SalesAPITestCaseBase):
    """销售订单API测试"""

    def test_order_list_view(self):
        """测试订单列表访问"""
        # 创建测试订单
        order = SalesOrder.objects.create(
            order_number='SO20260106001',
            customer=self.customer,
            order_date=date.today(),
            status='draft',
            payment_status='unpaid',
            subtotal=Decimal('200000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('26000.00'),
            total_amount=Decimal('226000.00'),
            created_by=self.user
        )

        # 添加订单明细
        SalesOrderItem.objects.create(
            order=order,
            product=self.product1,
            quantity=Decimal('2'),
            unit_price=Decimal('100000.00'),
            subtotal=Decimal('200000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('26000.00'),
            line_total=Decimal('226000.00')
        )

        url = reverse('sales:order_list')
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/order_list.html')

    def test_order_detail_view(self):
        """测试订单详情访问"""
        order = SalesOrder.objects.create(
            order_number='SO20260106002',
            customer=self.customer,
            order_date=date.today(),
            status='confirmed',
            payment_status='unpaid',
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            total_amount=Decimal('113000.00'),
            created_by=self.user
        )

        url = reverse('sales:order_detail', args=[order.pk])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/order_detail.html')
        self.assertContains(response, order.order_number)
        self.assertContains(response, '测试客户A公司')

    def test_order_detail_not_found(self):
        """测试订单详情 - 订单不存在"""
        url = reverse('sales:order_detail', args=[99999])
        response = self.client.get(url)

        # 应该返回404
        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)


class DeliveryAPITestCase(SalesAPITestCaseBase):
    """发货单API测试"""

    def setUp(self):
        super().setUp()

        # 创建已审核的订单（发货单的前提）
        self.order = SalesOrder.objects.create(
            order_number='SO20260106003',
            customer=self.customer,
            order_date=date.today(),
            status='confirmed',
            payment_status='unpaid',
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            total_amount=Decimal('113000.00'),
            created_by=self.user
        )

        self.order_item = SalesOrderItem.objects.create(
            order=self.order,
            product=self.product1,
            quantity=Decimal('1'),
            unit_price=Decimal('100000.00'),
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            line_total=Decimal('113000.00')
        )

    def test_delivery_list_view(self):
        """测试发货单列表访问"""
        # 创建发货单
        delivery = Delivery.objects.create(
            delivery_number='OUT20260106001',
            sales_order=self.order,
            warehouse=self.warehouse,
            delivery_date=date.today(),
            status='pending',
            created_by=self.user
        )

        url = reverse('sales:delivery_list')
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/delivery_list.html')

    def test_delivery_detail_view(self):
        """测试发货单详情访问"""
        delivery = Delivery.objects.create(
            delivery_number='OUT20260106002',
            sales_order=self.order,
            warehouse=self.warehouse,
            delivery_date=date.today(),
            status='pending',
            created_by=self.user
        )

        url = reverse('sales:delivery_detail', args=[delivery.pk])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/delivery_detail.html')
        self.assertContains(response, delivery.delivery_number)


class SalesReturnAPITestCase(SalesAPITestCaseBase):
    """销售退货API测试"""

    def setUp(self):
        super().setUp()

        # 创建已完成的订单（退货的前提）
        self.order = SalesOrder.objects.create(
            order_number='SO20260106004',
            customer=self.customer,
            order_date=date.today() - timedelta(days=30),
            status='completed',
            payment_status='paid',
            subtotal=Decimal('100000.00'),
            tax_rate=Decimal('0.13'),
            tax_amount=Decimal('13000.00'),
            total_amount=Decimal('113000.00'),
            paid_amount=Decimal('113000.00'),
            created_by=self.user
        )

    def test_return_list_view(self):
        """测试退货单列表访问"""
        # 创建退货单
        sales_return = SalesReturn.objects.create(
            return_number='SR20260106001',
            sales_order=self.order,
            customer=self.customer,
            return_reason='quality',
            return_date=date.today(),
            status='pending',
            total_amount=Decimal('113000.00'),
            created_by=self.user
        )

        url = reverse('sales:return_list')
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/return_list.html')

    def test_return_detail_view(self):
        """测试退货单详情访问"""
        sales_return = SalesReturn.objects.create(
            return_number='SR20260106002',
            sales_order=self.order,
            customer=self.customer,
            return_reason='defective',
            return_date=date.today(),
            status='approved',
            total_amount=Decimal('113000.00'),
            approved_date=date.today(),
            created_by=self.user
        )

        url = reverse('sales:return_detail', args=[sales_return.pk])
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/return_detail.html')
        self.assertContains(response, sales_return.return_number)

    def test_return_statistics_view(self):
        """测试退货统计页面访问"""
        url = reverse('sales:return_statistics')
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertTemplateUsed(response, 'sales/return_statistics.html')


class SalesPermissionTestCase(SalesAPITestCaseBase):
    """Sales模块权限测试"""

    def test_order_list_requires_login(self):
        """测试订单列表需要登录"""
        self.client.force_authenticate(user=None)
        url = reverse('sales:order_list')
        response = self.client.get(url)

        # 未登录应重定向到登录页
        self.assertEqual(response.status_code, status.HTTP_302_FOUND)
        self.assertIn('/login/', response.url)

    def test_quote_list_requires_login(self):
        """测试报价单列表需要登录"""
        self.client.force_authenticate(user=None)
        url = reverse('sales:quote_list')
        response = self.client.get(url)

        self.assertEqual(response.status_code, status.HTTP_302_FOUND)
        self.assertIn('/login/', response.url)


class SalesSearchFilterTestCase(SalesAPITestCaseBase):
    """Sales模块搜索和过滤测试"""

    def setUp(self):
        super().setUp()

        # 创建多个测试订单
        self.order1 = SalesOrder.objects.create(
            order_number='SO20260106001',
            customer=self.customer,
            order_date=date.today(),
            status='draft',
            payment_status='unpaid',
            total_amount=Decimal('100000.00'),
            created_by=self.user
        )

        self.order2 = SalesOrder.objects.create(
            order_number='SO20260106002',
            customer=self.customer,
            order_date=date.today(),
            status='confirmed',
            payment_status='partial',
            total_amount=Decimal('200000.00'),
            paid_amount=Decimal('100000.00'),
            created_by=self.user
        )

        self.order3 = SalesOrder.objects.create(
            order_number='SO20260106003',
            customer=self.customer,
            order_date=date.today(),
            status='completed',
            payment_status='paid',
            total_amount=Decimal('150000.00'),
            paid_amount=Decimal('150000.00'),
            created_by=self.user
        )

    def test_filter_orders_by_status(self):
        """测试按状态过滤订单"""
        url = reverse('sales:order_list')
        response = self.client.get(url, {'status': 'confirmed'})

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        # 验证上下文中的订单列表
        if 'orders' in response.context:
            orders = response.context['orders']
            # 确保是QuerySet或列表
            if hasattr(orders, 'count'):
                confirmed_count = sum(1 for o in orders if o.status == 'confirmed')
                self.assertGreater(confirmed_count, 0)

    def test_search_orders_by_number(self):
        """测试按订单号搜索"""
        url = reverse('sales:order_list')
        response = self.client.get(url, {'search': 'SO20260106002'})

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertContains(response, 'SO20260106002')

    def test_filter_orders_by_payment_status(self):
        """测试按付款状态过滤订单"""
        url = reverse('sales:order_list')
        response = self.client.get(url, {'payment_status': 'paid'})

        self.assertEqual(response.status_code, status.HTTP_200_OK)
