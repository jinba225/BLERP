# 单据模板大类关联实施 - 执行计划

## 实施日期
2025-11-09

## 任务目标
将打印模板系统从固定类型映射改为灵活的大类分类方案，支持同类单据共享模板，并通过默认模板配置实现个性化设置。

## 核心设计
### 方案概述
- 模板分为5个大类：销售类、采购类、库存类、财务类、其他类
- 同类别的模板可以被该类别的所有单据使用
- 通过 DefaultTemplateMapping 表为每种单据设置默认模板
- 支持 suitable_for 字段优化模板排序

### 数据模型变更
1. **PrintTemplate 模型**：
   - 删除 `template_type` 字段（细粒度类型）
   - 删除 `is_default` 字段（改为独立表管理）
   - 新增 `template_category` 字段（5个大类）
   - 新增 `suitable_for` JSON字段（细粒度标签）

2. **DefaultTemplateMapping 模型**（新增）：
   - `document_type`：单据类型（如 quote_domestic, quote_overseas）
   - `template`：关联到 PrintTemplate
   - 每种单据类型只能有一个默认模板

## 实施步骤

### ✅ 步骤 1: 修改 PrintTemplate 模型
**文件**: `apps/sales/models_print_template.py`
**操作**:
- 添加 `CATEGORY_CHOICES`（5个大类）
- 添加 `DOCUMENT_TYPE_CHOICES`（参考用）
- 修改字段定义
- 更新 Meta 配置和方法

**结果**: 模型支持新的分类方式

### ✅ 步骤 2: 创建 DefaultTemplateMapping 模型
**文件**: `apps/sales/models_template_mapping.py` (新建)
**操作**:
- 定义完整的单据类型选项
- 关联到 PrintTemplate
- 添加验证逻辑

**结果**: 新模型创建完成

### ✅ 步骤 3: 更新模型导入
**文件**: `apps/sales/models.py`
**操作**: 导入新模型

**结果**: Django 可以识别新模型

### ✅ 步骤 4: 修复 Admin 配置
**文件**: `apps/sales/admin.py`
**操作**:
- 更新 PrintTemplateAdmin（使用新字段）
- 移除对 template_type 和 is_default 的引用

**结果**: Admin 配置与模型匹配

### ✅ 步骤 5: 生成并执行数据库迁移
**命令**:
```bash
python manage.py makemigrations sales
python manage.py migrate sales
```

**结果**:
- 生成迁移文件: `0011_defaulttemplatemapping_alter_printtemplate_options_and_more.py`
- 数据库结构更新成功

### ✅ 步骤 6: 创建数据迁移脚本
**文件**: `apps/sales/management/commands/migrate_template_data.py` (新建)
**功能**:
- 更新现有模板的 template_category
- 设置 suitable_for 字段
- 创建默认模板映射

**结果**: 数据迁移命令创建完成

### ✅ 步骤 7: 执行数据迁移
**命令**:
```bash
python manage.py migrate_template_data --dry-run  # 预览
python manage.py migrate_template_data             # 执行
```

**结果**:
- 更新 2 个模板
- 创建 2 个默认映射

### ✅ 步骤 8: 实现 TemplateSelector 服务
**文件**: `apps/sales/services/template_selector.py` (新建)
**功能**:
- `get_available_templates()`: 获取可用模板并智能排序
- `get_default_template()`: 获取默认模板
- `_get_category_by_document_type()`: 类型推断

**结果**: 服务层实现完成

### ✅ 步骤 9-10: 更新视图层
**文件**: `apps/sales/views.py`
**修改函数**:
- `quote_detail`: 使用新服务获取模板列表和默认模板
- `quote_print`: 使用新服务获取默认模板

**结果**: 视图使用新的模板选择逻辑

### ✅ 步骤 11: 添加 Admin 管理界面
**文件**: `apps/sales/admin.py`
**操作**:
- 导入 DefaultTemplateMapping
- 添加 DefaultTemplateMappingAdmin 配置
- 配置 list_display, fieldsets 等

**结果**: 可以在 Admin 管理默认模板配置

### ✅ 步骤 12: 测试验证
**验证项目**:
1. ✅ Django 项目检查无错误
2. ✅ 模板数据正确迁移
3. ✅ 默认模板映射创建成功
4. ✅ TemplateSelector 服务功能正常
5. ✅ 可以获取销售类模板列表
6. ✅ 可以获取国内/海外报价单的默认模板

## 实施结果

### 文件变更统计
- 📁 新增文件: 3个
  - `apps/sales/models_template_mapping.py`
  - `apps/sales/services/template_selector.py`
  - `apps/sales/management/commands/migrate_template_data.py`

- 📝 修改文件: 4个
  - `apps/sales/models_print_template.py`
  - `apps/sales/models.py`
  - `apps/sales/views.py`
  - `apps/sales/admin.py`

### 数据库变更
- 🗄️ 新增表: 1张 (`sales_default_template_mapping`)
- 🔄 修改表: 1张 (`sales_print_template`)
  - 移除字段: `template_type`, `is_default`
  - 新增字段: `template_category`, `suitable_for`
  - 更新索引

### 数据迁移
- 📊 更新模板: 2个
- 🔗 创建默认映射: 2个

## 功能验证

### 模板数据
```
✅ 模板 ID=1: 标准国内报价单
   分类: 📊 销售类
   适用: ['quote']

✅ 模板 ID=2: 标准海外报价单
   分类: 📊 销售类
   适用: ['quote']
```

### 默认模板映射
```
✅ 报价单-国内 → 标准国内报价单
✅ 报价单-海外 → 标准海外报价单
```

### 服务功能
```
✅ 获取销售类报价单模板: 2 个
✅ 国内报价单默认模板: 标准国内报价单
✅ 海外报价单默认模板: 标准海外报价单
```

## 使用指南

### 1. 创建新模板
访问: http://127.0.0.1:8000/sales/templates/create/
- 选择模板类别（销售/采购/库存/财务/其他）
- 设置适用单据类型（可选，用于排序）
- 设计模板布局

### 2. 设置默认模板
访问: http://127.0.0.1:8000/admin/sales/defaulttemplatemapping/
- 选择单据类型（如"报价单-国内"）
- 选择默认模板
- 保存

### 3. 打印单据
访问报价单详情页: http://127.0.0.1:8000/sales/quotes/{id}/
- 下拉框显示所有销售类模板
- 自动选中默认模板
- 选择模板后点击"打印"

## 核心优势

1. **灵活性**：同类单据可以共享模板，无需为每种单据单独创建
2. **可扩展性**：新增单据类型无需修改代码
3. **智能排序**：通过 suitable_for 字段优先显示相关模板
4. **独立配置**：默认模板配置与模板定义分离，易于管理

## 后续优化建议

1. 在模板列表中显示"推荐"标签（based on suitable_for）
2. 添加模板预览功能
3. 支持模板使用统计
4. 添加模板复制功能（基于现有模板创建新模板）
5. 优化 Admin 界面的模板选择器（按类别分组显示）

## 完成时间
2025-11-09

## 状态
✅ 全部完成
