## 问题与目标
- 订单退货后未看到“应付”记录（退款负债）。
- 目标：在销售退货流程中生成并展示对应的“退款应付”（待付款），并在最终处理时完成付款结算。

## 现状分析
- 退货处理逻辑位于 `apps/sales/views.py:1623-1749`：仅在“处理”阶段创建 `Payment(payment_type='payment', customer=..., status=completed)` 并减少 `CustomerAccount.balance`。
- 未在“批准/收货”阶段生成任何待付款记录，且财务的“付款记录列表”仅按供应商维度筛选，不展示对客户的付款（退款）。

## 方案概述
1) 在退货“收货”阶段生成一条“退款应付（待付款）”：
- 位置：`apps/sales/views.py:return_receive`
- 创建 `Payment`：
  - `payment_type='payment'`
  - `status='pending'`（待处理）
  - `customer=sales_return.sales_order.customer`
  - `amount=sales_return.refund_amount`
  - 关联 `reference_type='sales_return'`, `reference_id`, `reference_number`
- 在退货详情页提供跳转查看该付款单。

2) 在退货“处理”阶段结算退款并同步应付：
- 位置：`apps/sales/views.py:return_process`
- 计算 `actual_refund = refund_amount - restocking_fee`。
- 查找并更新上一步创建的 `Payment`：
  - 更新 `amount=actual_refund`
  - `status='completed'`，`payment_date=timezone.now().date()`
- 同步减少 `CustomerAccount.balance`（已有逻辑保留）。

3) 财务“付款记录列表”支持展示客户退款：
- 位置：`apps/finance/views.py:payment_payment_list`
- 现有列表仅筛选供应商维度，调整为同时展示 `supplier` 或 `customer` 的付款记录：
  - 搜索/筛选添加客户维度（customer）
  - 列表展示对方（客户/供应商）名称与付款对象类型标识
- 对应模板调整字段显示（不新增模型）。

4) 退货详情页可视化提示
- 在 `sales:return_detail` 页面：
  - 状态为“已收货”时，显示“已生成退款应付（待付款）”的提示与链接
  - 状态为“已处理”时，显示“退款已完成”的付款单链接与金额

## 边界与一致性
- 若“收货后”直接跳过“处理”阶段，仍有待付款记录，便于财务后续执行。
- 若“处理阶段”调整了重新入库费，最终金额以 `actual_refund` 为准，更新待付款记录。
- 不新增数据库模型，复用 `Payment` 与 `CustomerAccount`。

## 变更文件
- `apps/sales/views.py`：在 `return_receive` 创建 pending 付款；在 `return_process` 完成付款并更新金额。
- `apps/finance/views.py`：`payment_payment_list` 支持客户维度（展示退款应付）。
- `templates/sales/return_detail.html`：新增付款记录链接与提示。
- （如需）`templates/finance/payment_payment_list.html`：兼容显示客户退款付款记录。

## 验证
- 在 `returns/12` 流程中：
  - 收货后查看财务付款列表，能看到“退款应付（待付款）”记录
  - 处理后记录变为“已完成”，金额以扣除重新入库费后的实际退款为准
  - 客户应收余额同步减少

请确认以上方案，我将据此实现并进行联调与页面展示优化。