{% extends 'layouts/base.html' %}

{% block title %}{% if action == 'create' %}新建入库单{% else %}编辑入库单{% endif %} - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">库存管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'inventory:inbound_list' %}" class="text-gray-500 hover:text-gray-700">入库单</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{% if action == 'create' %}新建{% else %}编辑{% endif %}</span>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建入库单{% else %}编辑入库单{% endif %}</h3>
            {% if inbound %}
            <p class="text-sm text-gray-600">{{ inbound.order_number }}</p>
            {% endif %}
        </div>
    </div>

    <form method="post" class="bg-white rounded-lg shadow overflow-hidden" id="inboundForm">
        {% csrf_token %}
        <input type="hidden" name="items_json" id="items_json">

        <!-- Basic Information -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">基本信息</h4>
        </div>
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        入库类型 <span class="text-red-500">*</span>
                    </label>
                    <select name="order_type"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <option value="">请选择入库类型</option>
                        {% for type_code, type_name in order_types %}
                        <option value="{{ type_code }}" {% if inbound and inbound.order_type == type_code %}selected{% endif %}>
                            {{ type_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        仓库 <span class="text-red-500">*</span>
                    </label>
                    <select name="warehouse"
                            required
                            id="warehouseSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <option value="">请选择仓库</option>
                        {% for w in warehouses %}
                        <option value="{{ w.id }}" {% if inbound and inbound.warehouse_id == w.id %}selected{% endif %}>
                            {{ w.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        入库日期 <span class="text-red-500">*</span>
                    </label>
                    <input type="date"
                           name="order_date"
                           required
                           value="{% if inbound %}{{ inbound.order_date|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">供应商</label>
                    <select name="supplier"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <option value="">请选择供应商</option>
                        {% for s in suppliers %}
                        <option value="{{ s.id }}" {% if inbound and inbound.supplier_id == s.id %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">参考单号</label>
                    <input type="text"
                           name="reference_number"
                           value="{% if inbound %}{{ inbound.reference_number }}{% endif %}"
                           placeholder="关联的采购单号等"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">参考类型</label>
                    <input type="text"
                           name="reference_type"
                           value="{% if inbound %}{{ inbound.reference_type }}{% endif %}"
                           placeholder="如: 采购订单、退货单等"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="notes"
                              rows="3"
                              placeholder="备注信息"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">{% if inbound %}{{ inbound.notes }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="px-6 py-4 bg-gray-50 border-t border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h4 class="text-md font-semibold text-gray-900">入库明细</h4>
                <button type="button"
                        onclick="addItem()"
                        class="btn btn-primary text-sm px-3 py-1.5">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
</svg>添加产品
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full" id="itemsTable">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="pb-2" style="width: 25%">产品 <span class="text-red-500">*</span></th>
                            <th class="pb-2" style="width: 15%">库位</th>
                            <th class="pb-2" style="width: 12%">数量 <span class="text-red-500">*</span></th>
                            <th class="pb-2" style="width: 12%">批次号</th>
                            <th class="pb-2" style="width: 13%">过期日期</th>
                            <th class="pb-2" style="width: 18%">备注</th>
                            <th class="pb-2" style="width: 5%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
                <div id="noItemsMessage" class="text-center py-8 text-gray-500">
                    <svg class="icon mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
</svg>
                    <p>暂无产品明细，点击"添加产品"按钮开始</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
            <a href="{% if inbound %}{% url 'inventory:inbound_detail' inbound.pk %}{% else %}{% url 'inventory:inbound_list' %}{% endif %}"
               class="btn btn-outline">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>取消
            </a>
            <button type="submit"
                    class="btn btn-primary">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存
            </button>
        </div>
    </form>
</div>

<script>
// 设置入库日期默认为当天
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const orderDateInput = document.querySelector('input[name="order_date"]');
    if (orderDateInput && !orderDateInput.value) {
        orderDateInput.value = today;
    }
});

let itemIndex = 0;
const products = {{ products|safe }};
const locations = {{ locations|safe }};

function addItem() {
    const tbody = document.getElementById('itemsBody');
    const noItemsMsg = document.getElementById('noItemsMessage');

    noItemsMsg.style.display = 'none';

    const row = document.createElement('tr');
    row.className = 'border-t border-gray-200';
    row.id = `item-row-${itemIndex}`;

    row.innerHTML = `
        <td class="py-2 pr-2">
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                    id="product-${itemIndex}">
                <option value="">请选择产品</option>
                ${products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
            </select>
        </td>
        <td class="py-2 pr-2">
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                    id="location-${itemIndex}">
                <option value="">请选择库位</option>
                ${locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('')}
            </select>
        </td>
        <td class="py-2 pr-2">
            <input type="number"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                   placeholder="数量"
                   step="1"
                   min="1"
                   id="quantity-${itemIndex}">
        </td>
        <td class="py-2 pr-2">
            <input type="text"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                   placeholder="批次号"
                   id="batch-${itemIndex}">
        </td>
        <td class="py-2 pr-2">
            <input type="date"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                   id="expiry-${itemIndex}">
        </td>
        <td class="py-2 pr-2">
            <input type="text"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500"
                   placeholder="备注"
                   id="notes-${itemIndex}">
        </td>
        <td class="py-2">
            <button type="button"
                    onclick="removeItem(${itemIndex})"
                    class="text-red-600 hover:text-red-800">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg>
            </button>
        </td>
    `;

    tbody.appendChild(row);
    itemIndex++;
}

function removeItem(index) {
    const row = document.getElementById(`item-row-${index}`);
    if (row) {
        row.remove();
    }

    // Check if there are no items left
    const tbody = document.getElementById('itemsBody');
    if (tbody.children.length === 0) {
        document.getElementById('noItemsMessage').style.display = 'block';
    }
}

function collectItems() {
    const items = [];
    const tbody = document.getElementById('itemsBody');

    for (let row of tbody.children) {
        const rowId = row.id.split('-')[2];
        const productSelect = document.getElementById(`product-${rowId}`);
        const locationSelect = document.getElementById(`location-${rowId}`);
        const quantityInput = document.getElementById(`quantity-${rowId}`);
        const batchInput = document.getElementById(`batch-${rowId}`);
        const expiryInput = document.getElementById(`expiry-${rowId}`);
        const notesInput = document.getElementById(`notes-${rowId}`);

        if (productSelect && productSelect.value && quantityInput && quantityInput.value) {
            items.push({
                product_id: productSelect.value,
                location_id: locationSelect ? locationSelect.value : '',
                quantity: quantityInput.value,
                batch_number: batchInput ? batchInput.value : '',
                expiry_date: expiryInput ? expiryInput.value : '',
                notes: notesInput ? notesInput.value : ''
            });
        }
    }

    return items;
}

document.getElementById('inboundForm').addEventListener('submit', function(e) {
    const items = collectItems();

    if (items.length === 0) {
        e.preventDefault();
        alert('请至少添加一个产品明细');
        return false;
    }

    document.getElementById('items_json').value = JSON.stringify(items);
});

// Initialize with one empty row for create mode
{% if action == 'create' %}
addItem();
{% endif %}

// Load existing items for edit mode
{% if inbound and inbound.items.all %}
{% for item in inbound.items.all %}
addItem();
document.getElementById(`product-${itemIndex-1}`).value = '{{ item.product_id }}';
{% if item.location %}
document.getElementById(`location-${itemIndex-1}`).value = '{{ item.location_id }}';
{% endif %}
document.getElementById(`quantity-${itemIndex-1}`).value = '{{ item.quantity }}';
document.getElementById(`batch-${itemIndex-1}`).value = '{{ item.batch_number }}';
{% if item.expiry_date %}
document.getElementById(`expiry-${itemIndex-1}`).value = '{{ item.expiry_date|date:"Y-m-d" }}';
{% endif %}
document.getElementById(`notes-${itemIndex-1}`).value = '{{ item.notes }}';
{% endfor %}
{% endif %}
</script>
{% endblock %}