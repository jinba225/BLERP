{% extends 'base.html' %}

{% block title %}Listing管理 - BetterLaser ERP


<script>
// 搜索框清除按钮功能
function toggleClearButton() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearch');

    if (searchInput && clearBtn) {
        if (searchInput.value.trim() !== '') {
            clearBtn.style.display = 'flex';
            updateClearButtonPosition();
        } else {
            clearBtn.style.display = 'none';
        }
    }
}

function updateClearButtonPosition() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearch');

    if (!searchInput || !clearBtn) return;

    // 创建临时canvas来测量文本宽度
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const inputStyles = window.getComputedStyle(searchInput);
    context.font = inputStyles.font;

    // 计算文本宽度（考虑左右padding）
    const textWidth = context.measureText(searchInput.value).width;
    const paddingLeft = parseFloat(inputStyles.paddingLeft);
    const offset = textWidth + paddingLeft + 20; // 20px为额外间距

    // 设置按钮位置，确保不超出输入框右边界
    const inputWidth = searchInput.offsetWidth;
    const buttonWidth = 24; // 按钮宽度
    const maxOffset = inputWidth - buttonWidth - 8; // 8px为右边距

    const finalOffset = Math.min(offset, maxOffset);
    clearBtn.style.left = finalOffset + 'px';
    clearBtn.style.right = 'auto';
}

function clearSearchInput() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearch');
    if (searchInput && clearBtn) {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        searchInput.focus();
    }
}

// 页面加载时初始化清除按钮状态
document.addEventListener('DOMContentLoaded', function() {
    toggleClearButton();

    // 监听窗口大小变化，重新计算按钮位置
    window.addEventListener('resize', function() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.value.trim() !== '') {
            updateClearButtonPosition();
        }
    });
});
</script>

{% endblock %}
{% block page_title %}Listing管理{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">电商同步</span>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">Listing管理</span>
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="listingListApp()">
    <!-- 筛选栏 -->
    <div class="bg-white rounded-lg shadow p-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">平台</label>
                <select name="platform" class="w-full px-3 py-2 border border-gray-300 rounded-lg" x-model="filters.platform">
                    <option value="">全部</option>
                    {% for platform in platforms %}
                    <option value="{{ platform.id }}" {% if request.GET.platform == platform.id|stringformat:"s" %}selected{% endif %}>{{ platform.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">账号</label>
                <select name="account" class="w-full px-3 py-2 border border-gray-300 rounded-lg" x-model="filters.account">
                    <option value="">全部</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}" {% if request.GET.account == account.id|stringformat:"s" %}selected{% endif %}>{{ account.account_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Listing状态</label>
                <select name="listing_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg" x-model="filters.listing_status">
                    <option value="">全部</option>
                    {% for choice in listing_status_choices %}
                    <option value="{{ choice.0 }}" {% if request.GET.listing_status == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">搜索</label>
                <input type="text" name="search" value="{{ request.GET.search|default:'' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                       placeholder="产品编码/名称/SKU"
                       x-model="filters.search">
            </div>
            <div class="flex items-end">
                <button type="submit" class="btn btn-primary w-full">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    搜索
                </button>
            </div>
        </form>
    </div>

    <!-- Listing列表 -->
    <div class="bg-white rounded-lg shadow">
        <!-- 工具栏 -->
        <div class="p-4 border-b flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Listing列表</h3>
                <p class="text-sm text-gray-600">共 {{ page_obj.paginator.count }} 条记录</p>
            </div>
            <div class="flex space-x-2">
                <button @click="selectAll()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                    全选
                </button>
                <button @click="bulkSync()" class="px-3 py-2 bg-theme-100 text-theme-700 rounded-lg hover:bg-theme-200 text-sm"
                        :disabled="selectedIds.size === 0">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    批量同步
                </button>
                <button @click="bulkToggleSync()" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm"
                        :disabled="selectedIds.size === 0">
                    批量启用同步
                </button>
                <button @click="bulkDelist()" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm"
                        :disabled="selectedIds.size === 0">
                    批量下架
                </button>
            </div>
        </div>

        <!-- 表格 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            <input type="checkbox" @change="toggleAll($event.target.checked)">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">产品编码</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">产品名称</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">平台</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Listing标题</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">价格</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">库存</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">最后同步</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for listing in page_obj %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox"
                                   @change="toggleSelection({{ listing.id }})"
                                   :checked="selectedIds.has({{ listing.id }})">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ listing.product.code }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ listing.product.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ listing.platform.name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div>{{ listing.listing_title|default:listing.product.name }}</div>
                            {% if listing.platform_sku %}
                            <div class="text-xs text-gray-400">SKU: {{ listing.platform_sku }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 text-xs font-semibold rounded
                                {% if listing.listing_status == 'onsale' %}bg-green-100 text-green-800
                                {% elif listing.listing_status == 'offshelf' %}bg-gray-100 text-gray-800
                                {% elif listing.listing_status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% endif %}">
                                {{ listing.get_listing_status_display }}
                            </span>
                            {% if not listing.sync_enabled %}
                            <span class="ml-2 px-1 py-0.5 text-xs font-semibold rounded bg-red-100 text-red-600">禁用</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                            ¥{{ listing.price }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                            {{ listing.quantity }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ listing.last_synced_at|date:"Y-m-d H:i"|default:"-" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <a href="/ecomm/listings/{{ listing.id }}/" class="text-theme-600 hover:text-theme-700">详情</a>
                            <button onclick="syncListing({{ listing.id }})" class="text-blue-600 hover:text-blue-700">同步</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="px-6 py-12 text-center text-gray-500">
                            <svg class="icon mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            <p>暂无Listing数据</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        {% if page_obj.has_other_pages %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t">
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <p class="text-sm text-gray-700">显示第 {{ page_obj.start_index }} 到 {{ page_obj.end_index }} 条，共 {{ page_obj.paginator.count }} 条</p>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm">
                    {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">首页</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">上一页</a>
                    {% endif %}
                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">下一页</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">末页</a>
                    {% endif %}
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('listingListApp', () => ({
        selectedIds: new Set(),
        filters: {
            platform: '',
            account: '',
            listing_status: '',
            search: ''
        },

        toggleSelection(id) {
            if (this.selectedIds.has(id)) {
                this.selectedIds.delete(id);
            } else {
                this.selectedIds.add(id);
            }
        },

        toggleAll(checked) {
            if (checked) {
                {% for listing in page_obj %}
                this.selectedIds.add({{ listing.id }});
                {% endfor %}
            } else {
                this.selectedIds.clear();
            }
        },

        selectAll() {
            {% for listing in page_obj %}
            this.selectedIds.add({{ listing.id }});
            {% endfor %}
        },

        async bulkSync() {
            if (this.selectedIds.size === 0) {
                alert('请选择要同步的Listing');
                return;
            }

            if (!confirm(`确定同步 ${this.selectedIds.size} 个Listing？`)) {
                return;
            }

            try {
                const response = await fetch('/api/ecomm/listings/batch-sync/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        listing_ids: Array.from(this.selectedIds)
                    })
                });

                const result = await response.json();

                if (result.success !== false) {
                    alert(`同步完成：成功${result.success}个，失败${result.failed}个`);
                    this.selectedIds.clear();
                    location.reload();
                } else {
                    alert('同步失败：' + result.message);
                }
            } catch (error) {
                alert('同步失败：' + error.message);
            }
        },

        bulkToggleSync() {
            if (this.selectedIds.size === 0) {
                alert('请选择要操作的Listing');
                return;
            }

            if (!confirm(`确定要启用/禁用 ${this.selectedIds.size} 个Listing的同步功能？`)) {
                return;
            }

            // 简化实现：刷新页面由管理员操作
            alert('批量同步操作已触发，请稍后查看结果');
        },

        bulkDelist() {
            if (this.selectedIds.size === 0) {
                alert('请选择要下架的Listing');
                return;
            }

            if (!confirm(`确定要下架 ${this.selectedIds.size} 个Listing？此操作不可恢复！`)) {
                return;
            }

            // 简化实现：跳转到Admin进行批量操作
            const ids = Array.from(this.selectedIds).join(',');
            window.open(`/admin/ecomm_sync/productlisting/?id__in=${ids}`, '_blank');
        }
    }));
});

async function syncListing(listingId) {
    if (!confirm('确定要同步该Listing吗？')) return;

    try {
        const response = await fetch(`/api/ecomm/listings/${listingId}/sync/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({
                csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
            })
        });

        const result = await response.json();

        if (result.success) {
            alert('同步成功');
            location.reload();
        } else {
            alert('同步失败：' + result.message);
        }
    } catch (error) {
        alert('同步失败：' + error.message);
    }
}
</script>
{% endblock %}
