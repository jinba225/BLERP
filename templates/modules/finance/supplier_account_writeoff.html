{% extends 'layouts/base.html' %}

{% block title %}应付核销 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'finance:dashboard' %}" class="text-gray-500 hover:text-gray-700">往来款项</a>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'finance:supplier_account_list' %}" class="text-gray-500 hover:text-gray-700">应付账款</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">核销</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Account Summary -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">{% if writeoff_type == 'supplier' %}供应商信息{% else %}账款信息{% endif %}</h4>
        </div>
        <div class="p-6">
            {% if writeoff_type == 'supplier' %}
                <!-- 供应商统一核销 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-600">供应商</p>
                        <p class="text-lg font-semibold text-gray-900">{{ supplier.name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">应付余额（累计）</p>
                        <p class="text-lg font-semibold text-red-600">¥{{ total_balance|floatformat:2|default:"0.00" }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            该供应商共 {{ accounts|length }} 个应付账户
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">预付款余额</p>
                        <p class="text-lg font-semibold text-green-600">¥{{ total_prepay_balance|floatformat:2|default:"0.00" }}</p>
                    </div>
                </div>
                
                <!-- 应付账款列表 -->
                <div class="mt-6">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">未付应付账款</h5>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">单据号</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">应付金额</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">已付金额</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">未付余额</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for account in accounts %}
                                <tr>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">{{ account.invoice_number|default:"-" }}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">¥{{ account.invoice_amount|floatformat:2 }}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right">¥{{ account.paid_amount|floatformat:2 }}</td>
                                    <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 text-right font-medium">¥{{ account.balance|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <!-- 单个应付账款核销 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <p class="text-sm text-gray-600">{% if account.supplier %}供应商{% else %}客户（退款）{% endif %}</p>
                        <p class="text-lg font-semibold text-gray-900">
                            {% if account.supplier %}
                            {{ account.supplier.name }}
                            {% elif account.customer %}
                            {{ account.customer.name }}
                            {% else %}
                            -
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">应付余额（供应商累计）</p>
                        <p class="text-lg font-semibold text-red-600">¥{{ supplier_summary.total_balance|floatformat:2|default:"0.00" }}</p>
                        {% if supplier_summary and supplier_summary.account_count > 1 %}
                        <p class="text-xs text-gray-500 mt-1">
                            该供应商共 {{ supplier_summary.account_count }} 个应付账户，
                            当前账户余额 ¥{{ account.balance|floatformat:2 }}
                        </p>
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">单据号</p>
                        <p class="text-lg font-semibold text-gray-900">{{ account.invoice_number|default:"-" }}</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div> <!-- Write-off Form -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">核销信息</h4>
        </div>
        <form method="post">
            {% csrf_token %}
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">核销金额</label>
                        <input type="number" name="amount" step="0.01" min="0" max="{% if writeoff_type == 'supplier' %}{{ total_balance }}{% else %}{{ supplier_summary.total_balance|default:account.balance }}{% endif %}"
                            placeholder="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <p class="text-xs text-gray-500 mt-1">如选择预付款，总核销 = 预付款 + 核销金额。可填0仅使用预付款。</p>
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款日期 <span
                                class="text-red-500">*</span></label>
                        <input type="date" name="payment_date" required value="{% now 'Y-m-d' %}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
                        <select name="payment_method"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="bank_transfer" selected>电汇</option>
                            <option value="acceptance_draft">承兑汇票</option>
                            <option value="cash">现金</option>
                            <option value="other">其它</option>
                        </select>
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">发票号</label>
                        <input type="text" name="invoice_number"
                            {% if not writeoff_type == 'supplier' and account.invoice_number and account.invoice_number|slice:":3" == "INV" %}value="{{ account.invoice_number }}"{% endif %}
                            placeholder="请输入发票号（可选）"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <p class="text-xs text-gray-500 mt-1">填写发票号后，对应的订单状态将更新为"已开票"</p>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">使用预付款（可选）</label>
                            <a href="{% if writeoff_type == 'supplier' %}{% url 'finance:supplier_prepayment_create' %}?supplier_id={{ supplier.id }}{% else %}{% url 'finance:supplier_prepayment_create' %}?supplier_id={{ account.supplier_id }}{% endif %}&next={{ request.path }}&from_prepayment_create=1"
                               class="text-sm text-theme-600 hover:text-theme-700 font-medium">
                                + 创建预付款
                            </a>
                        </div>

                        <select name="prepayment" id="prepaymentSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">不使用预付款</option>
                            {% if prepays|length > 0 %}
                            <option value="ALL_PREPAY" class="font-semibold text-theme-600">
                                预付款 - ¥{{ total_prepay_balance|floatformat:2 }}
                            </option>
                            {% endif %}
                        </select>
                    </div>
                </div> <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="notes" rows="3" placeholder="可选填写核销备注信息"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 "></textarea>
                </div>
            </div> <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <a href="{% url 'finance:supplier_account_list' %}" class="h-10 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center">
                    取消
                </a>
                <button class="btn btn-primary h-10 px-4" type="submit">
                    确认核销
                </button>
            </div>
        </form>
    </div>
</div>


{% endblock %}
