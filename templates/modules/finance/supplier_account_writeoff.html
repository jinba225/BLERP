{% extends 'base.html' %}

{% block title %}应付核销 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'finance:dashboard' %}" class="text-gray-500 hover:text-gray-700">往来款项</a>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'finance:supplier_account_list' %}" class="text-gray-500 hover:text-gray-700">应付账款</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">核销</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Account Summary -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">账款信息</h4>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <p class="text-sm text-gray-600">{% if account.supplier %}供应商{% else %}客户（退款）{% endif %}</p>
                    <p class="text-lg font-semibold text-gray-900">
                        {% if account.supplier %}
                        {{ account.supplier.name }}
                        {% elif account.customer %}
                        {{ account.customer.name }}
                        {% else %}
                        -
                        {% endif %}
                    </p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">应付余额（供应商累计）</p>
                    <p class="text-lg font-semibold text-red-600">¥{{ supplier_summary.total_balance|floatformat:2|default:"0.00" }}</p>
                    {% if supplier_summary and supplier_summary.account_count > 1 %}
                    <p class="text-xs text-gray-500 mt-1">
                        该供应商共 {{ supplier_summary.account_count }} 个应付账户，
                        当前账户余额 ¥{{ account.balance|floatformat:2 }}
                    </p>
                    {% endif %}
                </div>
                <div>
                    <p class="text-sm text-gray-600">单据号</p>
                    <p class="text-lg font-semibold text-gray-900">{{ account.invoice_number|default:"-" }}</p>
                </div>
            </div>
        </div>
    </div> <!-- Write-off Form -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">核销信息</h4>
        </div>
        <form method="post">
            {% csrf_token %}
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">核销金额</label>
                        <input type="number" name="amount" step="0.01" min="0" max="{{ supplier_summary.total_balance|default:account.balance }}"
                            placeholder="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <p class="text-xs text-gray-500 mt-1">如选择预付款，总核销 = 预付款 + 核销金额。可填0仅使用预付款。</p>
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款日期 <span
                                class="text-red-500">*</span></label>
                        <input type="date" name="payment_date" required value="{% now 'Y-m-d' %}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
                        <select name="payment_method"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                            <option value="bank_transfer" selected>电汇</option>
                            <option value="acceptance_draft">承兑汇票</option>
                            <option value="cash">现金</option>
                            <option value="other">其它</option>
                        </select>
                    </div> <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">发票号</label>
                        <input type="text" name="invoice_number"
                            {% if account.invoice_number and account.invoice_number|slice:":3" == "INV" %}value="{{ account.invoice_number }}"{% endif %}
                            placeholder="请输入发票号（可选）"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                        <p class="text-xs text-gray-500 mt-1">填写发票号后，对应的订单状态将更新为"已开票"</p>
                    </div> <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">使用预付款（可选）</label>
                            <a href="{% url 'finance:supplier_prepayment_create' %}?supplier_id={{ account.supplier_id }}&next={{ request.path }}"
                               class="text-sm text-theme-600 hover:text-theme-700 font-medium">
                                + 创建预付款
                            </a>
                        </div>
                        <select name="prepayment"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 ">
                            <option value="">不使用预付款</option>
                            {% for p in prepays %}
                            <option value="{{ p.id }}">{{ p.paid_date }} - 余额 ¥{{ p.balance|floatformat:2 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div> <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="notes" rows="3" placeholder="可选填写核销备注信息"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 "></textarea>
                </div>
            </div> <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <a href="{% url 'finance:supplier_account_list' %}"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    取消
                </a>
                <button class="btn btn-primary" type="submit">
                    确认核销
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    console.log('=== 预付款自动刷新脚本已加载 ===');
    console.log('当前URL:', window.location.href);

    // 检查是否从预付款创建页面返回
    const urlParams = new URLSearchParams(window.location.search);
    const fromPrepaymentCreate = urlParams.get('from_prepayment_create');
    console.log('from_prepayment_create 参数:', fromPrepaymentCreate);

    if (fromPrepaymentCreate === '1') {
        console.log('✓ 检测到从预付款创建返回，开始刷新预付款下拉框');

        // 延迟一小段时间确保页面完全加载
        setTimeout(() => {
            refreshPrepaymentDropdown();

            // 清除URL参数（避免重复刷新）
            const cleanUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
            console.log('✓ 已清除URL参数');
        }, 100);
    }

    function refreshPrepaymentDropdown() {
        const select = document.querySelector('select[name="prepayment"]');
        if (!select) {
            console.error('✗ 未找到预付款下拉框');
            return;
        }

        console.log('✓ 开始刷新预付款下拉框');
        const selectedValue = select.value;

        // 显示加载提示
        select.disabled = true;

        const apiUrl = `{% url 'finance:api_supplier_account_available_prepays' account.pk %}";
        console.log('✓ API URL:', apiUrl);

        // 添加时间戳防止缓存
        const cacheBusterUrl = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
        console.log('✓ 实际请求URL:', cacheBusterUrl);

        fetch(cacheBusterUrl)
            .then(response => {
                console.log('✓ API响应状态:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('✓ API返回数据:', data);

                // 清空并重新填充选项
                select.innerHTML = '<option value="">不使用预付款</option>';

                // 添加新的预付款选项
                if (data.prepayments && data.prepayments.length > 0) {
                    console.log(`✓ 找到 ${data.prepayments.length} 个预付款`);
                    data.prepayments.forEach(prepay => {
                        const option = document.createElement('option');
                        option.value = prepay.id;
                        option.textContent = `${prepay.paid_date} - 余额 ¥${parseFloat(prepay.balance).toFixed(2)}`;
                        select.appendChild(option);
                        console.log(`  - ${option.textContent}`);
                    });
                } else {
                    console.log('✗ 没有找到预付款');
                }

                // 恢复之前选中的值（如果还存在）
                if (selectedValue) {
                    const optionExists = Array.from(select.options).some(opt => opt.value === selectedValue);
                    if (optionExists) {
                        select.value = selectedValue;
                    }
                }

                // 显示成功提示
                if (data.newly_added) {
                    showToast('✓ 预付款已添加并自动刷新列表', 'success');
                }

                select.disabled = false;
                console.log('✓ 预付款下拉框刷新完成');
            })
            .catch(error => {
                console.error('✗ 刷新预付款列表失败:', error);
                select.disabled = false;
                showToast('刷新预付款列表失败，请刷新页面', 'error');
            });
    }

    function showToast(message, type = 'info') {
        // 简单的提示消息实现
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
</script>
{% endblock %}