{% extends "layouts/base.html" %}

{% block title %}合并供应商预付款 - {{ supplier.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="fas fa-compress-arrows-alt text-success"></i>
                        合并供应商预付款 - {{ supplier.name }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 汇总信息 -->
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> 预付款汇总</h5>
                        <ul class="mb-0">
                            <li>供应商：<strong>{{ supplier.name }}</strong></li>
                            <li>预付款笔数：<strong>{{ total_count }}</strong> 笔</li>
                            <li>总余额：<strong class="text-success">¥{{ total_balance }}</strong></li>
                        </ul>
                    </div>

                    <!-- 说明 -->
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle"></i> 合并说明</h5>
                        <ul class="mb-0">
                            <li>勾选需要合并的预付款记录（至少2笔）</li>
                            <li>合并后将生成一条新的预付款记录，余额为所有选中记录的余额之和</li>
                            <li>原记录将被标记为"已合并"，不再在列表中显示</li>
                            <li>合并后的预付款可直接用于核销应付账款</li>
                        </ul>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="50"><input type="checkbox" id="selectAll" /></th>
                                        <th>预付日期</th>
                                        <th>预付金额</th>
                                        <th>剩余余额</th>
                                        <th>备注</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prepay in prepayments %}
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   name="prepayments"
                                                   value="{{ prepay.id }}"
                                                   class="prepay-checkbox"
                                                   data-balance="{{ prepay.balance }}" />
                                        </td>
                                        <td>{{ prepay.paid_date|date:"Y-m-d" }}</td>
                                        <td>¥{{ prepay.amount }}</td>
                                        <td><strong class="text-success">¥{{ prepay.balance }}</strong></td>
                                        <td>{{ prepay.notes|default:"-" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            暂无预付款记录
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- 实时统计 -->
                        <div class="alert alert-secondary mb-3" id="selectionInfo" style="display: none;">
                            <h5><i class="fas fa-calculator"></i> 选中统计</h5>
                            <p class="mb-0">
                                已选择 <strong id="selectedCount">0</strong> 笔，
                                合并余额：<strong class="text-success" id="selectedBalance">¥0</strong>
                            </p>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'finance:supplier_prepayment_list' %}"
                               class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </a>
                            <button type="submit"
                                    class="btn btn-success"
                                    id="submitBtn"
                                    disabled>
                                <i class="fas fa-compress-arrows-alt"></i> 合并预付款
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const prepayCheckboxes = document.querySelectorAll('.prepay-checkbox');
    const submitBtn = document.getElementById('submitBtn');
    const selectionInfo = document.getElementById('selectionInfo');
    const selectedCount = document.getElementById('selectedCount');
    const selectedBalance = document.getElementById('selectedBalance');

    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', function() {
        prepayCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelection();
    });

    // 单个复选框变化
    prepayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelection);
    });

    // 更新选中统计
    function updateSelection() {
        const selected = Array.from(prepayCheckboxes).filter(cb => cb.checked);
        const count = selected.length;
        const total = selected.reduce((sum, cb) => {
            return sum + parseFloat(cb.dataset.balance);
        }, 0);

        selectedCount.textContent = count;
        selectedBalance.textContent = '¥' + total.toFixed(2);

        // 显示/隐藏统计信息
        selectionInfo.style.display = count > 0 ? 'block' : 'none';

        // 启用/禁用提交按钮（至少选择2笔）
        submitBtn.disabled = count < 2;

        // 更新全选复选框状态
        const allChecked = count === prepayCheckboxes.length;
        selectAllCheckbox.checked = allChecked && count > 0;
        selectAllCheckbox.indeterminate = count > 0 && !allChecked;
    }
});
</script>
{% endblock %}
