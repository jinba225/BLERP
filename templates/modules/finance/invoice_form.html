{% extends 'layouts/base.html' %}

{% block title %}{% if invoice %}编辑发票{% else %}新建发票{% endif %} - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">财务管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'finance:invoice_list' %}" class="text-gray-500 hover:text-gray-700">发票管理</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{% if invoice %}编辑发票{% else %}新建发票{% endif %}</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="invoiceForm()">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-2xl font-bold text-gray-900">{% if invoice %}编辑发票{% else %}新建发票{% endif %}</h3>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'finance:invoice_list' %}"
                   class="btn btn-outline">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>取消
                </a>
                <button type="submit"
                        class="btn btn-primary">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存
                </button>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发票类型 <span class="text-red-500">*</span></label>
                    <select name="invoice_type" required x-model="invoiceType"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        {% for value, label in invoice_type_choices %}
                        <option value="{{ value }}" {% if invoice and invoice.invoice_type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发票代码</label>
                    <input type="text" name="invoice_code" value="{% if invoice %}{{ invoice.invoice_code }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500"
                           placeholder="发票代码">
                </div>

                <div x-show="invoiceType === 'purchase'">
                    <label class="block text-sm font-medium text-gray-700 mb-2">供应商 <span class="text-red-500">*</span></label>
                    <select name="supplier"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        <option value="">请选择供应商</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if invoice and invoice.supplier_id == supplier.id %}selected{% elif initial_supplier and initial_supplier.id == supplier.id %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div x-show="invoiceType === 'sales'">
                    <label class="block text-sm font-medium text-gray-700 mb-2">客户 <span class="text-red-500">*</span></label>
                    <select name="customer"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        <option value="">请选择客户</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}" {% if invoice and invoice.customer_id == customer.id %}selected{% elif initial_customer and initial_customer.id == customer.id %}selected{% endif %}>
                            {{ customer.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">开票日期 <span class="text-red-500">*</span></label>
                    <input type="date" name="invoice_date" required
                           value="{% if invoice %}{{ invoice.invoice_date|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">税务日期</label>
                    <input type="date" name="tax_date"
                           value="{% if invoice and invoice.tax_date %}{{ invoice.tax_date|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">税率 (%) <span class="text-red-500">*</span></label>
                    <input type="number" name="tax_rate" step="0.01" min="0" max="100" required x-model="taxRate"
                           value="{% if invoice %}{{ invoice.tax_rate }}{% else %}{{ default_tax_rate }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发票状态</label>
                    <select name="status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if invoice and invoice.status == value %}selected{% elif not invoice and value == 'draft' %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">关联单据号</label>
                <input type="text" name="reference_number"
                       value="{% if invoice %}{{ invoice.reference_number }}{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500"
                       placeholder="关联的采购订单号或销售订单号">
                <input type="hidden" name="reference_type" value="">
                <input type="hidden" name="reference_id" value="">
            </div>
        </div>

        <!-- Invoice Items -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                <h4 class="text-lg font-semibold text-gray-900">发票明细</h4>
                <button type="button" @click="addItem()"
                        class="btn btn-primary text-sm px-3 py-1.5">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
</svg>添加明细
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">品名 *</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">规格型号</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">单位</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">数量 *</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">单价 *</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">金额</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">税率(%)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">税额</th>
                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in items" :key="index">
                            <tr class="border-b">
                                <td class="px-4 py-2">
                                    <input type="text" :name="'item_' + index + '_description'" x-model="item.description" required
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-theme-500">
                                    <input type="hidden" :name="'item_' + index + '_product'" x-model="item.product_id">
                                </td>
                                <td class="px-4 py-2">
                                    <input type="text" :name="'item_' + index + '_specification'" x-model="item.specification"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500 transition-colors">
                                </td>
                                <td class="px-4 py-2">
                                    <input type="text" :name="'item_' + index + '_unit'" x-model="item.unit"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500 transition-colors">
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" :name="'item_' + index + '_quantity'" x-model="item.quantity" required
                                           step="0.0001" min="0" @input="calculateItem(index)"
                                           class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" :name="'item_' + index + '_unit_price'" x-model="item.unit_price" required
                                           step="0.01" min="0" @input="calculateItem(index)"
                                           class="w-24 px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
                                </td>
                                <td class="px-4 py-2 text-right text-sm" x-text="'¥' + item.amount.toFixed(2)"></td>
                                <td class="px-4 py-2">
                                    <input type="number" :name="'item_' + index + '_tax_rate'" x-model="item.tax_rate"
                                           step="0.01" min="0" max="100" @input="calculateItem(index)"
                                           class="w-20 px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
                                </td>
                                <td class="px-4 py-2 text-right text-sm" x-text="'¥' + item.tax_amount.toFixed(2)"></td>
                                <td class="px-4 py-2 text-center">
                                    <button type="button" @click="removeItem(index)"
                                            class="text-red-600 hover:text-red-800">
                                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                    <tfoot class="bg-gray-50 font-medium">
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-right">合计：</td>
                            <td class="px-4 py-3 text-right" x-text="'¥' + totalAmount.toFixed(2)"></td>
                            <td class="px-4 py-3"></td>
                            <td class="px-4 py-3 text-right" x-text="'¥' + totalTaxAmount.toFixed(2)"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-right text-theme-600">价税合计：</td>
                            <td colspan="4" class="px-4 py-3 text-right text-theme-600 text-lg" x-text="'¥' + grandTotal.toFixed(2)"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <input type="hidden" name="item_count" x-model="items.length">
        </div>

        <!-- Attachment and Remark -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b">附件和备注</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">发票附件 (PDF/图片)</label>
                    <input type="file" name="attachment" accept=".pdf,.jpg,.jpeg,.png"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                    {% if invoice and invoice.attachment %}
                    <p class="mt-1 text-sm text-gray-500">
                        当前文件: <a href="{{ invoice.attachment.url }}" target="_blank" class="text-theme-600 hover:text-theme-700">查看</a>
                    </p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="remark" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500"
                              placeholder="请输入备注信息...">{% if invoice %}{{ invoice.remark }}{% endif %}</textarea>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function invoiceForm() {
    return {
        invoiceType: '{% if invoice %}{{ invoice.invoice_type }}{% elif initial_invoice_type %}{{ initial_invoice_type }}{% else %}purchase{% endif %}',
        taxRate: {% if invoice %}{{ invoice.tax_rate }}{% else %}{{ default_tax_rate }}{% endif %},
        items: {% if invoice and invoice.items.all %}[
            {% for item in invoice.items.all %}
            {
                product_id: '{% if item.product %}{{ item.product.id }}{% endif %}',
                description: '{{ item.description|escapejs }}',
                specification: '{{ item.specification|escapejs }}',
                unit: '{{ item.unit|escapejs }}',
                quantity: {{ item.quantity }},
                unit_price: {{ item.unit_price }},
                amount: {{ item.amount }},
                tax_rate: {{ item.tax_rate }},
                tax_amount: {{ item.tax_amount }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% elif initial_items %}[
            {% for item in initial_items %}
            {
                product_id: '{{ item.product_id }}',
                description: '{{ item.description|escapejs }}',
                specification: '{{ item.specification|escapejs }}',
                unit: '{{ item.unit|escapejs }}',
                quantity: {{ item.quantity }},
                unit_price: {{ item.unit_price }},
                amount: {{ item.amount }},
                tax_rate: {{ item.tax_rate }},
                tax_amount: {{ item.tax_amount }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]{% else %}[]{% endif %},

        get totalAmount() {
            return this.items.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
        },

        get totalTaxAmount() {
            return this.items.reduce((sum, item) => sum + parseFloat(item.tax_amount || 0), 0);
        },

        get grandTotal() {
            return this.totalAmount + this.totalTaxAmount;
        },

        addItem() {
            this.items.push({
                product_id: '',
                description: '',
                specification: '',
                unit: '',
                quantity: 1,
                unit_price: 0,
                amount: 0,
                tax_rate: this.taxRate,
                tax_amount: 0
            });
        },

        removeItem(index) {
            this.items.splice(index, 1);
        },

        calculateItem(index) {
            const item = this.items[index];
            const qty = parseFloat(item.quantity) || 0;
            const price = parseFloat(item.unit_price) || 0;
            const taxRate = parseFloat(item.tax_rate) || 0;

            item.amount = qty * price;
            item.tax_amount = item.amount * (taxRate / 100);
        }
    }
}
</script>
{% endblock %}