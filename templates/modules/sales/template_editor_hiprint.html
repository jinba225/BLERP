{% extends 'base.html' %}
{% block title %}æ‰“å°æ¨¡æ¿è®¾è®¡å™¨ - {{ template.name }} - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">åŸºç¡€è®¾ç½®</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'core:print_template_list' %}" class="text-gray-500 hover:text-gray-700">æ‰“å°æ¨¡æ¿</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{{ template.name }}</span>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">ç¼–è¾‘å™¨</span>
{% endblock %}

{% block extra_head %}
{% load static %}

<!-- æ‰€æœ‰ä¾èµ–åº“ - æœ¬åœ°æ–‡ä»¶ -->
<script src="{% static 'js/libs/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/libs/jsbarcode.min.js' %}"></script>
<script src="{% static 'js/libs/socket.io.min.js' %}"></script>
<script src="{% static 'js/libs/jspdf.umd.min.js' %}"></script>
<script src="{% static 'js/libs/html2canvas.min.js' %}"></script>
<script src="{% static 'js/libs/canvg.umd.min.js' %}"></script>

<!-- HiPrint CSS -->
<link rel="stylesheet" href="{% static 'js/libs/print-lock.css' %}">

<!-- HiPrint JS -->
<script src="{% static 'js/libs/vue-plugin-hiprint.js' %}"></script>

<!-- âš ï¸ å…³é”®ï¼å¿…é¡»åœ¨åŠ è½½ hiprint åç«‹å³åˆå§‹åŒ– i18nï¼Œå¦åˆ™è¡¨æ ¼å…ƒç´ ä¼šæŠ¥é”™ -->
<script>
// æ³¨æ„ï¼šä¸ä½¿ç”¨ IIFEï¼Œç¡®ä¿ i18n åœ¨å…¨å±€ä½œç”¨åŸŸ
console.log('ğŸ”§ ç´§æ€¥åˆå§‹åŒ– i18nï¼ˆåœ¨ hiprint åŠ è½½åç«‹å³æ‰§è¡Œï¼‰');

// åˆ›å»º i18n ç¿»è¯‘å‡½æ•°
var i18nTranslations = {
    'field': 'å­—æ®µ',
    'title': 'æ ‡é¢˜',
    'text': 'æ–‡æœ¬',
    'table': 'è¡¨æ ¼',
    'barcode': 'æ¡å½¢ç ',
    'qrcode': 'äºŒç»´ç ',
    'image': 'å›¾ç‰‡',
    'line': 'çº¿æ¡',
    'width': 'å®½åº¦',
    'height': 'é«˜åº¦',
    'left': 'å·¦è¾¹è·',
    'top': 'ä¸Šè¾¹è·',
    'fontSize': 'å­—ä½“å¤§å°',
    'fontWeight': 'å­—ä½“ç²—ç»†',
    'textAlign': 'å¯¹é½æ–¹å¼',
    'color': 'é¢œè‰²',
    'columns': 'åˆ—',
    'rows': 'è¡Œ',
    'header': 'è¡¨å¤´',
    'footer': 'è¡¨å°¾',
    'body': 'å†…å®¹',
    'index': 'åºå·',
    'name': 'åç§°',
    'code': 'ç¼–ç ',
    'quantity': 'æ•°é‡',
    'price': 'å•ä»·',
    'amount': 'é‡‘é¢'
};

var i18nFunc = function(key) {
    console.log('ğŸŒ i18n._("' + key + '") è¢«è°ƒç”¨ï¼Œè°ƒç”¨æ ˆ:', new Error().stack);
    return i18nTranslations[key] || key;
};

// åˆ›å»º i18n å¯¹è±¡
var i18nObj = {
    _: i18nFunc,
    __: i18nFunc  // æœ‰äº›åº“å¯èƒ½ä½¿ç”¨ __
};

// âš ï¸ æ–¹æ³•1ï¼šä½¿ç”¨ Object.defineProperty å¼ºåˆ¶å®šä¹‰å…¨å±€ i18nï¼ˆä¸å¯åˆ é™¤ã€ä¸å¯é‡å†™ï¼‰
Object.defineProperty(window, 'i18n', {
    value: i18nObj,
    writable: false,     // ä¸å¯é‡å†™
    configurable: false, // ä¸å¯åˆ é™¤
    enumerable: true
});

console.log('âœ… window.i18n å·²å¼ºåˆ¶å®šä¹‰ï¼ˆä¸å¯åˆ é™¤ã€ä¸å¯é‡å†™ï¼‰');
console.log('âœ… window.i18n:', window.i18n);
console.log('âœ… window.i18n._:', window.i18n._);

// åŒæ—¶ä¹Ÿè®¾ç½®åˆ° hiprint
if (typeof hiprint !== 'undefined') {
    hiprint.i18n = i18nObj;
    console.log('âœ… hiprint.i18n å·²è®¾ç½®');

    // æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„è®¿é—®æ–¹å¼
    try {
        console.log('âœ… æµ‹è¯• window.i18n._("table") =', window.i18n._('table'));
        console.log('âœ… æµ‹è¯• hiprint.i18n._("table") =', hiprint.i18n._('table'));

        // æµ‹è¯•åœ¨å…¨å±€ä½œç”¨åŸŸè®¿é—®ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
        console.log('âœ… æµ‹è¯• eval("i18n._(\\"table\\")") =', eval('i18n._("table")'));
    } catch (e) {
        console.error('âŒ i18n æµ‹è¯•å¤±è´¥:', e);
    }
} else {
    console.error('âŒ hiprint æœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ– i18n');
}

// é¢å¤–ä¿æŠ¤ï¼šæ¯100msæ£€æŸ¥ä¸€æ¬¡ i18n æ˜¯å¦è¢«è¦†ç›–
setInterval(function() {
    if (!window.i18n || typeof window.i18n._ !== 'function') {
        console.warn('âš ï¸ i18n è¢«è¦†ç›–ï¼Œé‡æ–°è®¾ç½®...');
        try {
            Object.defineProperty(window, 'i18n', {
                value: i18nObj,
                writable: false,
                configurable: false,
                enumerable: true
            });
        } catch (e) {
            console.error('âŒ æ— æ³•é‡æ–°è®¾ç½® i18n:', e);
        }
    }
}, 100);
</script>

<!-- HiPrint å…ƒç´ æä¾›å™¨ -->
<script src="{% static 'js/components/hiprint-provider.js' %}"></script>

<script>
    // æ£€æŸ¥æ‰€æœ‰ä¾èµ–åŠ è½½çŠ¶æ€
    console.log('=== åº“åŠ è½½çŠ¶æ€æ£€æŸ¥ï¼ˆæœ¬åœ°ï¼‰ ===');
    console.log('jQuery:', typeof jQuery !== 'undefined' ? 'âœ… ' + jQuery.fn.jquery : 'âŒ');
    console.log('JsBarcode:', typeof JsBarcode !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('socket.io:', typeof io !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('jsPDF:', typeof jspdf !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('html2canvas:', typeof html2canvas !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('canvg:', typeof canvg !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('hiprint:', typeof hiprint !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('QuoteProvider:', typeof QuoteElementProvider !== 'undefined' ? 'âœ…' : 'âŒ');
    console.log('========================');

    if (typeof jQuery !== 'undefined') {
        window.$ = window.jQuery;
    }

// ç¡®ä¿ i18n å›½é™…åŒ–å§‹ç»ˆå¯ç”¨çš„å‡½æ•°
function ensureI18nInitialized() {
    if (typeof hiprint === 'undefined') {
        console.warn('âš ï¸ hiprint æœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ– i18n');
        return false;
    }

    console.log('>>> æ­£åœ¨åˆå§‹åŒ– i18n...');
    console.log('>>> åˆå§‹åŒ–å‰ hiprint.i18n:', hiprint.i18n);

    // å§‹ç»ˆé‡æ–°åˆå§‹åŒ– i18nï¼Œç¡®ä¿å®ƒå­˜åœ¨ä¸”åŠŸèƒ½æ­£å¸¸
    hiprint.i18n = {
        _: function(key) {
            // ç®€å•çš„ä¸­æ–‡ç¿»è¯‘æ˜ å°„
            var translations = {
                'field': 'å­—æ®µ',
                'title': 'æ ‡é¢˜',
                'text': 'æ–‡æœ¬',
                'table': 'è¡¨æ ¼',
                'barcode': 'æ¡å½¢ç ',
                'qrcode': 'äºŒç»´ç ',
                'image': 'å›¾ç‰‡',
                'line': 'çº¿æ¡',
                'width': 'å®½åº¦',
                'height': 'é«˜åº¦',
                'left': 'å·¦è¾¹è·',
                'top': 'ä¸Šè¾¹è·',
                'fontSize': 'å­—ä½“å¤§å°',
                'fontWeight': 'å­—ä½“ç²—ç»†',
                'textAlign': 'å¯¹é½æ–¹å¼',
                'color': 'é¢œè‰²',
                'columns': 'åˆ—',
                'rows': 'è¡Œ',
                'header': 'è¡¨å¤´',
                'footer': 'è¡¨å°¾',
                'body': 'å†…å®¹',
                'index': 'åºå·',
                'name': 'åç§°',
                'code': 'ç¼–ç ',
                'quantity': 'æ•°é‡',
                'price': 'å•ä»·',
                'amount': 'é‡‘é¢'
            };
            var result = translations[key] || key;
            console.log('>>> i18n._("' + key + '") = "' + result + '"');
            return result;
        }
    };

    console.log('>>> åˆå§‹åŒ–å hiprint.i18n:', hiprint.i18n);
    console.log('>>> åˆå§‹åŒ–å hiprint.i18n._:', hiprint.i18n._);
    console.log('>>> i18n._ å‡½æ•°ç±»å‹:', typeof hiprint.i18n._);

    // æµ‹è¯• i18n å‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œ
    try {
        var testResult = hiprint.i18n._('table');
        console.log('>>> i18n æµ‹è¯•: i18n._("table") = "' + testResult + '"');
    } catch (e) {
        console.error('>>> i18n æµ‹è¯•å¤±è´¥:', e);
    }

    console.log('âœ… i18n å·²åˆå§‹åŒ–/æ›´æ–°');
    return true;
}
</script>

<style>
    body {
        overflow-x: hidden;
    }

    #design-container {
        min-height: calc(100vh - 250px);
        min-width: 900px;  /* ç¡®ä¿èƒ½å®¹çº³å¸¸è§çº¸å¼ å°ºå¯¸ï¼ˆå¦‚ A3 æ¨ªå‘ï¼‰ */
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        overflow: auto;
        padding: 20px;
    }

    #param-container {
        height: calc(100vh - 250px);
        border: 1px solid #e5e7eb;
        background: white;
        overflow-y: auto;
        padding: 15px;
    }

    /* HiPrinté¢æ¿æ ·å¼ */
    .hiprint-printPanel {
        margin: 0 auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background: white !important;
    }

    /* HiPrintå…ƒç´ æ ·å¼ */
    .hiprint-printElement-text,
    .hiprint-printElement-image,
    .hiprint-printElement-longText,
    .hiprint-printElement-table,
    .hiprint-printElement-barcode,
    .hiprint-printElement-qrcode,
    .hiprint-printElement-hline,
    .hiprint-printElement-vline {
        cursor: move;
        user-select: none;
    }

    /* é€‰ä¸­å…ƒç´ çš„è¾¹æ¡† */
    .hiprint-printElement.hiprint-printElement-selected {
        border: 2px dashed #3b82f6 !important;
    }

    /* å·¥å…·æ æ ·å¼ */
    .btn-toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .btn-toolbar button,
    .btn-toolbar a {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background: white;
        transition: all 0.2s;
    }

    .btn-toolbar button:hover,
    .btn-toolbar a:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #3b82f6 !important;
    }

    .btn-primary:hover {
        background: #2563eb !important;
    }

    .btn-success {
        background: #10b981 !important;
        color: white !important;
        border-color: #10b981 !important;
    }

    .btn-success:hover {
        background: #059669 !important;
    }

    .btn-danger {
        background: #ef4444 !important;
        color: white !important;
        border-color: #ef4444 !important;
    }

    .btn-danger:hover {
        background: #dc2626 !important;
    }

    .no-print {
        display: none !important;
    }

    /* åŠ è½½æç¤º */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>æ‰“å°æ¨¡æ¿è®¾è®¡å™¨ - {{ template.name }}
            </h3>
            <p class="text-sm text-gray-500 mt-1">æ‹–æ‹½å…ƒç´ åˆ°ç”»å¸ƒï¼Œè®¾è®¡ä½ çš„æ‰“å°æ¨¡æ¿</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'core:print_template_list' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>å–æ¶ˆ
            </a>
            <button type="button" onclick="saveTemplate()" class="px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>ä¿å­˜æ¨¡æ¿
            </button>
        </div>
    </div>

    <!-- Django Messages -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="rounded-lg p-4 {% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border border-red-200 text-red-800{% elif message.tags == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-800{% else %}bg-theme-50 border border-theme-200 text-theme-800{% endif %}"
             x-data="{ show: true }"
             x-show="show"
             x-transition>
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="icon {% if message.tags == 'success' %}text-green-600{% elif message.tags == 'error' %}text-red-600{% elif message.tags == 'warning' %}text-yellow-600{% else %}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                    <span class="text-sm font-medium">{{ message }}</span>
                </div>
                <button @click="show = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Toolbar -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
        <div class="btn-toolbar">
            <button onclick="previewPrint()" class="btn-primary">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
</svg> é¢„è§ˆ
            </button>
            <button onclick="testPrint()" class="btn-success">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
</svg> æµ‹è¯•æ‰“å°
            </button>
            <button onclick="showCanvasSizePanel()" class="btn-info" style="background: #f59e0b !important;">
                <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg> ç”»å¸ƒå°ºå¯¸
            </button>
            <button onclick="clearDesign()" class="btn-danger">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg> æ¸…ç©º
            </button>
        </div>
    </div>

    <!-- Canvas Size Settings Panel (Hidden by default) -->
    <div id="canvasSizePanel" class="bg-white rounded-lg shadow p-4 mb-4" style="display: none;">
        <div class="flex items-center justify-between mb-4">
            <h4 class="font-semibold text-gray-900">
                <svg class="icon mr-2" text-orange-500 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>ç”»å¸ƒå°ºå¯¸è®¾ç½®
            </h4>
            <button onclick="hideCanvasSizePanel()" class="text-gray-400 hover:text-gray-600">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>
            </button>
        </div>

        <div class="grid grid-cols-12 gap-4">
            <!-- çº¸å¼ é¢„è®¾ -->
            <div class="col-span-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
</svg>çº¸å¼ å°ºå¯¸
                </label>
                <select id="paperSizeSelect" onchange="applyPaperSize()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                    <optgroup label="ğŸ“„ Aç³»åˆ—çº¸å¼ ">
                        <option value="a3">A3 (297Ã—420mm)</option>
                        <option value="a4" selected>A4 (210Ã—297mm)</option>
                        <option value="a5">A5 (148Ã—210mm)</option>
                        <option value="a6">A6 (105Ã—148mm)</option>
                        <option value="a7">A7 (74Ã—105mm)</option>
                    </optgroup>
                    <optgroup label="ğŸ“‹ Bç³»åˆ—çº¸å¼ ">
                        <option value="b4">B4 (250Ã—353mm)</option>
                        <option value="b5">B5 (176Ã—250mm)</option>
                        <option value="b6">B6 (125Ã—176mm)</option>
                    </optgroup>
                    <optgroup label="ğŸŒ åŒ—ç¾æ ‡å‡†">
                        <option value="letter">Letter (216Ã—279mm)</option>
                        <option value="legal">Legal (216Ã—356mm)</option>
                        <option value="tabloid">Tabloid (279Ã—432mm)</option>
                    </optgroup>
                    <optgroup label="ğŸ“– ä¸­å›½æ ‡å‡†å¼€æœ¬">
                        <option value="16k">16å¼€ (185Ã—260mm)</option>
                        <option value="8k">8å¼€ (270Ã—390mm)</option>
                        <option value="4k">4å¼€ (390Ã—540mm)</option>
                    </optgroup>
                    <optgroup label="ğŸ§¾ çƒ­æ•æ‰“å°">
                        <option value="thermal_58">58mmå°ç¥¨ (58Ã—210mm)</option>
                        <option value="thermal_80">80mmå°ç¥¨ (80Ã—210mm)</option>
                        <option value="thermal_110">110mmå®½å¹… (110Ã—210mm)</option>
                    </optgroup>
                    <optgroup label="ğŸ·ï¸ æ ‡ç­¾å°ºå¯¸">
                        <option value="label_40x30">æ ‡ç­¾40Ã—30mm</option>
                        <option value="label_50x30">æ ‡ç­¾50Ã—30mm</option>
                        <option value="label_60x40">æ ‡ç­¾60Ã—40mm</option>
                        <option value="label_80x50">æ ‡ç­¾80Ã—50mm</option>
                        <option value="label_100x60">æ ‡ç­¾100Ã—60mm</option>
                        <option value="label_100x100">æ ‡ç­¾100Ã—100mm</option>
                    </optgroup>
                    <optgroup label="ğŸ“¦ ç‰©æµå¿«é€’å•">
                        <option value="express_100x100">å¿«é€’å•100Ã—100mm</option>
                        <option value="express_100x150">å¿«é€’å•100Ã—150mm</option>
                        <option value="express_100x180">å¿«é€’å•100Ã—180mm</option>
                    </optgroup>
                    <optgroup label="âœï¸ è‡ªå®šä¹‰">
                        <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                    </optgroup>
                </select>
            </div>

            <!-- æ–¹å‘ -->
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>æ–¹å‘
                </label>
                <select id="orientationSelect" onchange="applyPaperSize()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                    <option value="portrait">çºµå‘ â†•</option>
                    <option value="landscape">æ¨ªå‘ â†”</option>
                </select>
            </div>

            <!-- å®½åº¦ -->
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>å®½åº¦ (mm)
                </label>
                <input type="number" id="canvasWidth" value="210" min="50" max="1000"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
            </div>

            <!-- é«˜åº¦ -->
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>é«˜åº¦ (mm)
                </label>
                <input type="number" id="canvasHeight" value="297" min="50" max="1000"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
            </div>

            <!-- åº”ç”¨æŒ‰é’® -->
            <div class="col-span-2 flex items-end">
                <button onclick="applyCustomSize()" class="w-full px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700 transition">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>åº”ç”¨
                </button>
            </div>
        </div>

        <!-- é¡µè¾¹è·è®¾ç½® -->
        <div class="mt-4 pt-4 border-t border-gray-200">
            <h5 class="text-sm font-medium text-gray-700 mb-3">
                <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>é¡µè¾¹è·è®¾ç½®
            </h5>
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ä¸Šè¾¹è· (mm)</label>
                    <input type="number" id="marginTop" value="10" min="0" max="50"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ä¸‹è¾¹è· (mm)</label>
                    <input type="number" id="marginBottom" value="10" min="0" max="50"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">å·¦è¾¹è· (mm)</label>
                    <input type="number" id="marginLeft" value="10" min="0" max="50"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">å³è¾¹è· (mm)</label>
                    <input type="number" id="marginRight" value="10" min="0" max="50"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
            </div>
        </div>

        <!-- å½“å‰ç”»å¸ƒä¿¡æ¯ -->
        <div class="mt-3 p-3 bg-theme-50 border border-theme-200 rounded-lg">
            <div class="flex items-center text-sm text-theme-800">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                <span id="canvasSizeInfo">å½“å‰ç”»å¸ƒ: 210mm Ã— 297mm (A4 çºµå‘)</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-12 gap-4">
        <!-- Element Library Panel (Left) -->
        <div class="col-span-2">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 border-b bg-gray-50">
                    <h4 class="font-semibold text-gray-900 text-sm">
                        <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>å…ƒç´ åº“
                    </h4>
                </div>
                <div id="PrintElementTypeManager" class="hiprint-printElement-type" style="max-height: calc(100vh - 300px); overflow-y: auto; padding: 10px;">
                    <p class="text-xs text-gray-500 text-center mt-4">æ­£åœ¨åŠ è½½...</p>
                </div>
            </div>
        </div>

        <!-- Design Canvas (Middle) -->
        <div class="col-span-8">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 border-b bg-gray-50">
                    <h4 class="font-semibold text-gray-900">
                        <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>è®¾è®¡ç”»å¸ƒ
                    </h4>
                    <div id="debug-info" style="font-size: 10px; color: #9ca3af; margin-top: 5px;"></div>
                </div>
                <div id="design-container">
                    <div class="loading-overlay">
                        <div style="text-align: center;">
                            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                            <p style="color: #6b7280; font-size: 14px;">æ­£åœ¨åŠ è½½è®¾è®¡å™¨...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Panel (Right) -->
        <div class="col-span-2">
            <div class="bg-white rounded-lg shadow">
                <div class="p-3 border-b bg-gray-50">
                    <h4 class="font-semibold text-gray-900">
                        <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>å±æ€§è®¾ç½®
                    </h4>
                </div>
                <div id="param-container">
                    <p class="text-sm text-gray-500 text-center mt-10">
                        <svg class="icon text-gray-400 text-3xl mb-3 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg><br>
                        é€‰æ‹©ä¸€ä¸ªå…ƒç´ æŸ¥çœ‹å…¶å±æ€§
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for saving -->
    <form id="saveForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="layout_config" id="layout_config_input">
        <input type="hidden" name="name" value="{{ template.name }}">
        <input type="hidden" name="template_type" value="{{ template.template_type }}">
        <input type="hidden" name="is_default" value="{% if template.is_default %}on{% endif %}">
        <input type="hidden" name="is_active" value="{% if template.is_active %}on{% endif %}">
        <input type="hidden" name="company_name" value="{{ template.company_name }}">
        <input type="hidden" name="company_address" value="{{ template.company_address }}">
        <input type="hidden" name="company_phone" value="{{ template.company_phone }}">
        <input type="hidden" name="company_email" value="{{ template.company_email }}">
        <input type="hidden" name="custom_css" value="{{ template.custom_css|default:'' }}">
        <input type="hidden" name="notes" value="{{ template.notes|default:'' }}">
    </form>
</div>

<script>
let hiprintTemplate = null;

// ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆ
window.addEventListener('load', function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–HiPrint');
    updateDebugInfo('é¡µé¢åŠ è½½å®Œæˆ');

    // æ£€æŸ¥jQuery
    if (typeof $ === 'undefined') {
        console.error('jQueryæœªåŠ è½½ï¼');
        updateDebugInfo('é”™è¯¯: jQueryæœªåŠ è½½');
        showError('jQueryæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        return;
    }
    console.log('jQueryå·²åŠ è½½:', $.fn.jquery);
    updateDebugInfo('jQueryç‰ˆæœ¬: ' + $.fn.jquery);

    // æ£€æŸ¥HiPrint
    if (typeof hiprint === 'undefined') {
        console.error('HiPrintæœªåŠ è½½ï¼');
        updateDebugInfo('é”™è¯¯: HiPrintæœªåŠ è½½');
        showError('HiPrintåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        return;
    }
    console.log('HiPrintå·²åŠ è½½:', hiprint);
    updateDebugInfo('HiPrintå·²åŠ è½½ï¼Œå‡†å¤‡åˆå§‹åŒ–...');

    // ç«‹å³åˆå§‹åŒ– i18nï¼ˆåœ¨åˆ›å»ºä»»ä½•æ¨¡æ¿å®ä¾‹ä¹‹å‰ï¼‰
    console.log('æ­£åœ¨åˆå§‹åŒ– i18n...');
    if (ensureI18nInitialized()) {
        console.log('âœ… i18n åˆå§‹åŒ–æˆåŠŸ');
    } else {
        console.error('âŒ i18n åˆå§‹åŒ–å¤±è´¥');
    }

    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
    setTimeout(initHiPrint, 100);
});

function updateDebugInfo(message) {
    const debugDiv = document.getElementById('debug-info');
    if (debugDiv) {
        const time = new Date().toLocaleTimeString();
        debugDiv.innerHTML = `[${time}] ${message}`;
    }
}

function initHiPrint() {
    try {
        console.log('å¼€å§‹åˆå§‹åŒ–HiPrintè®¾è®¡å™¨...');
        updateDebugInfo('æ­£åœ¨åˆå§‹åŒ–è®¾è®¡å™¨...');

        // ========================================
        // é‡è¦ï¼šåœ¨åˆ›å»ºä»»ä½•æ¨¡æ¿å®ä¾‹ä¹‹å‰ï¼Œç¡®ä¿ i18n å·²æ­£ç¡®åˆå§‹åŒ–
        // ========================================
        ensureI18nInitialized();

        // è·å–æ¨¡æ¿æ•°æ®
        const templateJsonStr = '{{ layout_config_json|escapejs }}';
        console.log('æ¨¡æ¿JSONå­—ç¬¦ä¸²:', templateJsonStr);

        let templateData = null;
        if (templateJsonStr && templateJsonStr.trim() !== '' && templateJsonStr !== '{}') {
            try {
                templateData = JSON.parse(templateJsonStr);
                console.log('è§£æçš„æ¨¡æ¿æ•°æ®:', templateData);

                // âš ï¸ ä¸´æ—¶æ–¹æ¡ˆï¼šç§»é™¤è¡¨æ ¼å…ƒç´ ï¼ˆå› ä¸º hiprint i18n é—®é¢˜ï¼‰
                if (templateData.panels && templateData.panels.length > 0) {
                    templateData.panels.forEach(function(panel) {
                        if (panel.printElements) {
                            var originalCount = panel.printElements.length;
                            panel.printElements = panel.printElements.filter(function(elem) {
                                var isTable = elem.printElementType && elem.printElementType.type === 'table';
                                if (isTable) {
                                    console.warn('âš ï¸ è·³è¿‡è¡¨æ ¼å…ƒç´ ï¼ˆhiprint i18n å…¼å®¹æ€§é—®é¢˜ï¼‰:', elem);
                                }
                                return !isTable;
                            });
                            var removedCount = originalCount - panel.printElements.length;
                            if (removedCount > 0) {
                                console.log(`å·²ä¸´æ—¶ç§»é™¤ ${removedCount} ä¸ªè¡¨æ ¼å…ƒç´ `);
                                updateDebugInfo(`å·²ç§»é™¤ ${removedCount} ä¸ªè¡¨æ ¼å…ƒç´ ï¼ˆi18nå…¼å®¹æ€§é—®é¢˜ï¼‰`);
                            }
                        }
                    });
                }

                updateDebugInfo('æ¨¡æ¿æ•°æ®å·²è§£æ');
            } catch (e) {
                console.warn('æ¨¡æ¿JSONè§£æå¤±è´¥ï¼Œå°†åˆ›å»ºç©ºæ¨¡æ¿:', e);
                updateDebugInfo('åˆ›å»ºç©ºæ¨¡æ¿');
            }
        } else {
            updateDebugInfo('åˆ›å»ºæ–°æ¨¡æ¿');
        }

        // æ¸…ç©ºå®¹å™¨å‡†å¤‡åŠ è½½
        $('#design-container').empty();
        updateDebugInfo('å®¹å™¨å·²æ¸…ç©º');

        // åˆ›å»ºHiPrintæ¨¡æ¿å®ä¾‹
        console.log('åˆ›å»ºPrintTemplateå®ä¾‹...');

        // å¦‚æœæœ‰å·²ä¿å­˜çš„æ¨¡æ¿ï¼ŒåŠ è½½å®ƒ
        if (templateData && templateData.panels && templateData.panels.length > 0) {
            console.log('åŠ è½½å·²æœ‰æ¨¡æ¿...');
            updateDebugInfo('åŠ è½½å·²æœ‰æ¨¡æ¿...');
            hiprintTemplate = new hiprint.PrintTemplate({
                template: templateData,
                settingContainer: '#param-container'
            });
        } else {
            console.log('åˆ›å»ºæ–°æ¨¡æ¿ï¼Œæ·»åŠ é»˜è®¤é¢æ¿...');
            updateDebugInfo('åˆ›å»ºç©ºæ¨¡æ¿å®ä¾‹...');
            hiprintTemplate = new hiprint.PrintTemplate({
                settingContainer: '#param-container'
            });

            updateDebugInfo('æ·»åŠ é»˜è®¤A4é¢æ¿...');
            // æ·»åŠ é»˜è®¤çš„A4æ‰“å°é¢æ¿
            hiprintTemplate.addPrintPanel({
                width: 210,   // A4å®½åº¦(mm)
                height: 297,  // A4é«˜åº¦(mm)
                paperHeader: 10,
                paperFooter: 10
            });
        }

        console.log('PrintTemplateå®ä¾‹åˆ›å»ºæˆåŠŸ:', hiprintTemplate);
        updateDebugInfo('æ¨¡æ¿å®ä¾‹åˆ›å»ºæˆåŠŸ');

        // ========================================
        // å…³é”®ï¼åœ¨è°ƒç”¨ design() ä¹‹å‰å†æ¬¡ç¡®ä¿ i18n å­˜åœ¨
        // å› ä¸º new PrintTemplate() å¯èƒ½ä¼šé‡ç½® hiprint çš„å†…éƒ¨çŠ¶æ€
        // ========================================
        console.log('æ£€æŸ¥ i18n çŠ¶æ€...');
        console.log('hiprint.i18n:', hiprint.i18n);
        console.log('hiprint.i18n._:', typeof hiprint.i18n?._);

        ensureI18nInitialized();

        console.log('é‡æ–°æ£€æŸ¥ i18n çŠ¶æ€...');
        console.log('hiprint.i18n:', hiprint.i18n);
        console.log('hiprint.i18n._:', typeof hiprint.i18n?._);

        // åˆå§‹åŒ–è®¾è®¡å™¨
        console.log('åˆå§‹åŒ–è®¾è®¡å™¨åˆ°å®¹å™¨...');
        updateDebugInfo('åˆå§‹åŒ–è®¾è®¡å™¨ç•Œé¢...');
        hiprintTemplate.design('#design-container');

        console.log('âœ… HiPrintè®¾è®¡å™¨åˆå§‹åŒ–æˆåŠŸï¼');
        updateDebugInfo('âœ… è®¾è®¡å™¨åˆå§‹åŒ–æˆåŠŸï¼');

        // HiPrintä¼šè‡ªåŠ¨å¤„ç†æ‹–æ‹½ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¯ç”¨

        // åˆå§‹åŒ–å…ƒç´ æä¾›å™¨
        setTimeout(function() {
            console.log('=== å‡†å¤‡åˆå§‹åŒ–å…ƒç´ åº“ ===');
            updateDebugInfo('å‡†å¤‡åŠ è½½å…ƒç´ åº“...');

            try {
                console.log('è°ƒç”¨ initElementProvider()...');
                initElementProvider();
                console.log('initElementProvider() æ‰§è¡Œå®Œæˆ');
                updateDebugInfo('âœ… å…ƒç´ åº“å·²åŠ è½½');
            } catch (e) {
                console.error('âŒ å…ƒç´ åº“åŠ è½½å¤±è´¥:', e);
                console.error('é”™è¯¯å †æ ˆ:', e.stack);
                updateDebugInfo('âŒ å…ƒç´ åº“åŠ è½½å¤±è´¥');
                $('#PrintElementTypeManager').html(`
                    <div style="padding: 20px; text-align: center; color: #ef4444;">
                        <p style="font-size: 12px;">âŒ å…ƒç´ åº“åŠ è½½å¤±è´¥</p>
                        <p style="font-size: 11px; margin-top: 10px; color: #6b7280;">
                            é”™è¯¯: ${e.message}
                        </p>
                    </div>
                `);
            }
        }, 500);

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showSuccess('è®¾è®¡å™¨å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹è®¾è®¡äº†ï¼');

    } catch (error) {
        console.error('âŒ HiPrintåˆå§‹åŒ–å¤±è´¥:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        updateDebugInfo('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        showError('è®¾è®¡å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
}

function showError(message) {
    $('#design-container').html(`
        <div style="padding: 40px; text-align: center; color: #ef4444;">
            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
</svg>
            <h3 style="margin-bottom: 10px;">åˆå§‹åŒ–å¤±è´¥</h3>
            <p style="margin-bottom: 20px; color: #374151;">${message}</p>

            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 600px; text-align: left;">
                <h4 style="color: #dc2626; margin-bottom: 10px;">
                    <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548 5.478a1 1 0 01-.994.909H8.626a1 1 0 01-.994-.909l-.548-5.478z" /></svg> å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š
                </h4>
                <ol style="color: #374151; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                    <li><strong>åˆ·æ–°é¡µé¢</strong>ï¼šæŒ‰Ctrl+F5å¼ºåˆ¶åˆ·æ–°</li>
                    <li><strong>æ¸…é™¤ç¼“å­˜</strong>ï¼šæ¸…ç©ºæµè§ˆå™¨ç¼“å­˜åé‡è¯•</li>
                    <li><strong>è”ç³»ç®¡ç†å‘˜</strong>ï¼šæŠ¥å‘Šæ­¤é—®é¢˜ä»¥è·å–å¸®åŠ©</li>
                </ol>
            </div>

            <div style="margin-top: 20px;">
                <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
</svg> é‡æ–°åŠ è½½é¡µé¢
                </button>
                <a href="{% url 'core:print_template_list' %}" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block;">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg> è¿”å›åˆ—è¡¨
                </a>
            </div>

            <div style="margin-top: 30px; padding: 15px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #6b7280;">
                <strong>æŠ€æœ¯ä¿¡æ¯ï¼š</strong><br>
                jQueryçŠ¶æ€: ${typeof jQuery !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}<br>
                HiPrintçŠ¶æ€: ${typeof hiprint !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}<br>
                æµè§ˆå™¨: ${navigator.userAgent.split(')')[0] + ')'}
            </div>
        </div>
    `);
}

function showSuccess(message) {
    // å¯ä»¥æ·»åŠ æˆåŠŸæç¤ºï¼Œè¿™é‡Œæš‚æ—¶åªåœ¨æ§åˆ¶å°è¾“å‡º
    console.log('âœ…', message);
}

// æµ‹è¯•æ·»åŠ å…ƒç´ 
function testAddElement() {
    console.log('=== æµ‹è¯•æ·»åŠ å…ƒç´  ===');

    if (!hiprintTemplate) {
        alert('æ¨¡æ¿æœªåˆå§‹åŒ–');
        return;
    }

    var panel = hiprintTemplate.printPanels[0];
    if (!panel) {
        alert('ç”»å¸ƒé¢æ¿æœªæ‰¾åˆ°');
        return;
    }

    console.log('>>> å½“å‰é¢æ¿:', panel);
    console.log('>>> é¢æ¿æ–¹æ³•:', Object.keys(panel));

    // æµ‹è¯•æ·»åŠ ä¸€ä¸ªç®€å•çš„æ–‡æœ¬å…ƒç´ 
    var testOptions = {
        left: 50,
        top: 50,
        width: 150,
        height: 30,
        fontSize: 14,
        text: 'æµ‹è¯•æ–‡æœ¬',
        title: 'æµ‹è¯•å…ƒç´ ',
        fontWeight: 'bold'
    };

    console.log('>>> æ·»åŠ æµ‹è¯•å…ƒç´ ï¼Œé…ç½®:', testOptions);

    try {
        var result = panel.addPrintText(testOptions);
        console.log('>>> addPrintText è¿”å›å€¼:', result);
        console.log('>>> é¢æ¿å…ƒç´ åˆ—è¡¨:', panel.printElements);

        // æ£€æŸ¥ DOM
        var panelDom = $('#design-container .hiprint-printPanel');
        console.log('>>> ç”»å¸ƒ DOM:', panelDom);
        console.log('>>> ç”»å¸ƒå­å…ƒç´ æ•°é‡:', panelDom.find('.hiprint-printElement').length);

        alert('æµ‹è¯•å…ƒç´ å·²æ·»åŠ ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
    } catch (error) {
        console.error('>>> æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥: ' + error.message);
    }
}

// é¢„è§ˆæ‰“å°ï¼ˆå¢å¼ºç‰ˆ - æ”¯æŒæ˜ç»†é¡¹å¾ªç¯ï¼‰
function previewPrint() {
    console.log('=== å¼€å§‹é¢„è§ˆæ‰“å° ===');

    if (!hiprintTemplate) {
        alert('æ¨¡æ¿æœªåˆå§‹åŒ–ï¼Œæ— æ³•é¢„è§ˆ');
        return;
    }

    // è·å–æµ‹è¯•æ•°æ®
    const data = getSampleData();
    console.log('é¢„è§ˆæ•°æ®:', data);
    console.log('æ˜ç»†é¡¹æ•°é‡:', data.items ? data.items.length : 0);

    if (data.items && data.items.length > 0) {
        console.log('æ˜ç»†é¡¹æ•°æ®é¢„è§ˆ:');
        data.items.forEach(function(item, index) {
            console.log('  ç¬¬' + (index + 1) + 'é¡¹:', item.product_name, 'Ã—', item.quantity, item.unit);
        });
    } else {
        console.warn('âš ï¸ è­¦å‘Šï¼šæ˜ç»†é¡¹æ•°æ®ä¸ºç©ºï¼');
    }

    try {
        // âš ï¸ æ–¹æ¡ˆ A: å°è¯•æ ‡å‡† print() æ–¹æ³•
        console.log('æ–¹æ¡ˆ A: ä½¿ç”¨æ ‡å‡† print() æ–¹æ³•...');

        hiprintTemplate.print(data, {
            // æ‰“å°è®¾ç½® - æ˜ç»†é¡¹å¾ªç¯ç›¸å…³
        }, {
            callback: function() {
                console.log('âœ… é¢„è§ˆçª—å£å·²æ‰“å¼€ï¼ˆæ ‡å‡†æ–¹æ³•ï¼‰');
                console.log('å¦‚æœçœ‹ä¸åˆ°æ˜ç»†æ•°æ®ï¼Œè¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š');
                console.log('1. æ£€æŸ¥é¢„è§ˆçª—å£æ˜¯å¦æœ‰æ»šåŠ¨æ¡');
                console.log('2. åœ¨ Console è¿è¡Œè¯Šæ–­è„šæœ¬');
                console.log('3. ä½¿ç”¨"æµ‹è¯•æ‰“å°"æŒ‰é’®ï¼ˆprint2 æ–¹æ³•ï¼‰');
            }
        });

    } catch (error) {
        console.error('âŒ é¢„è§ˆå¤±è´¥:', error);

        // âš ï¸ æ–¹æ¡ˆ B: å¦‚æœæ ‡å‡†æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ
        console.log('æ–¹æ¡ˆ B: å°è¯•å¤‡ç”¨é¢„è§ˆæ–¹æ³•...');
        try {
            // ä½¿ç”¨ print2 ä½œä¸ºå¤‡ç”¨
            hiprintTemplate.print2(data);
            console.log('âœ… ä½¿ç”¨å¤‡ç”¨æ–¹æ³•æ‰“å¼€é¢„è§ˆ');
        } catch (error2) {
            console.error('âŒ å¤‡ç”¨æ–¹æ³•ä¹Ÿå¤±è´¥:', error2);
            alert('é¢„è§ˆå¤±è´¥: ' + error.message + '\n\nè¯·å°è¯•ä½¿ç”¨"æµ‹è¯•æ‰“å°"æŒ‰é’®');
        }
    }
}

// æµ‹è¯•æ‰“å°
function testPrint() {
    console.log('=== å¼€å§‹æµ‹è¯•æ‰“å° ===');

    if (!hiprintTemplate) {
        alert('æ¨¡æ¿æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ‰“å°');
        return;
    }

    const data = getSampleData();
    console.log('æ‰“å°æ•°æ®:', data);
    console.log('æ˜ç»†é¡¹æ•°é‡:', data.items ? data.items.length : 0);

    try {
        hiprintTemplate.print2(data, {}, {
            callback: function() {
                console.log('âœ… æ‰“å°å¯¹è¯æ¡†å·²æ‰“å¼€');
            }
        });
    } catch (error) {
        console.error('âŒ æ‰“å°å¤±è´¥:', error);
        alert('æ‰“å°å¤±è´¥: ' + error.message);
    }
}

// æ¸…ç©ºè®¾è®¡
function clearDesign() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰è®¾è®¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        hiprintTemplate.clear();
    }
}

// ä¿å­˜æ¨¡æ¿
function saveTemplate() {
    try {
        // ä¼˜å…ˆä½¿ç”¨å¾…ä¿å­˜çš„æ¨¡æ¿æ•°æ®ï¼ˆå¦‚æœæœ‰æ‹–æ‹½å…ƒç´ ä½†æœªæ¸²æŸ“ï¼‰
        let jsonData;
        if (window.pendingTemplateJson) {
            console.log('ä½¿ç”¨å¾…ä¿å­˜çš„æ¨¡æ¿æ•°æ® (åŒ…å«æœªæ¸²æŸ“çš„å…ƒç´ )');
            jsonData = window.pendingTemplateJson;
            // æ¸…é™¤å¾…ä¿å­˜çŠ¶æ€
            window.pendingTemplateJson = null;
        } else {
            console.log('ä½¿ç”¨å½“å‰æ¨¡æ¿çš„æ•°æ®');
            jsonData = hiprintTemplate.getJson();
        }

        console.log('ä¿å­˜çš„æ¨¡æ¿æ•°æ®:', jsonData);
        console.log('å…ƒç´ æ•°é‡:', jsonData.panels[0]?.printElements?.length || 0);

        $('#layout_config_input').val(JSON.stringify(jsonData));

        // æ˜¾ç¤ºä¿å­˜ä¸­çš„æç¤º
        showTemporaryMessage('æ­£åœ¨ä¿å­˜æ¨¡æ¿...', 'info');

        // æäº¤è¡¨å•
        $('#saveForm').submit();

        // æ³¨æ„ï¼šè¡¨å•æäº¤åä¼šè‡ªåŠ¨è·³è½¬ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä»£ç å¯èƒ½ä¸ä¼šæ‰§è¡Œ
        // å¦‚æœéœ€è¦åœ¨å½“å‰é¡µé¢çœ‹åˆ°æ•ˆæœï¼Œéœ€è¦æ”¹ç”¨ AJAX æäº¤
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

// åˆå§‹åŒ–å…ƒç´ æä¾›å™¨ï¼ˆä½¿ç”¨å®˜æ–¹APIï¼‰
function initElementProvider() {
    console.log('>>> 1. initElementProvider å¼€å§‹æ‰§è¡Œ [ç‰ˆæœ¬: v3.0-å®˜æ–¹æ ‡å‡†æ–¹å¼]');

    try {
        // æ£€æŸ¥ QuoteElementProvider æ˜¯å¦å·²åŠ è½½
        if (typeof QuoteElementProvider === 'undefined') {
            console.error('âš ï¸ QuoteElementProvider æœªåŠ è½½ï¼');
            updateDebugInfo('é”™è¯¯: å…ƒç´ æä¾›å™¨æœªåŠ è½½');
            $('#PrintElementTypeManager').html(`
                <div style="padding: 20px; text-align: center; color: #ef4444;">
                    <p style="font-size: 12px;">âŒ å…ƒç´ æä¾›å™¨æœªåŠ è½½</p>
                    <p style="font-size: 11px; margin-top: 10px; color: #6b7280;">
                        è¯·æ£€æŸ¥ hiprint-provider.js æ–‡ä»¶
                    </p>
                </div>
            `);
            return;
        }

        console.log('>>> 2. åˆ›å»ºå…ƒç´ æä¾›å™¨å®ä¾‹');
        var provider = new QuoteElementProvider();
        console.log('>>> Provider å¯¹è±¡:', provider);
        console.log('>>> Provider.addElementTypes:', typeof provider.addElementTypes);

        console.log('>>> 3. ä½¿ç”¨å®˜æ–¹APIåˆå§‹åŒ– hiprint');
        // ä½¿ç”¨å®˜æ–¹ API åˆå§‹åŒ– hiprint
        hiprint.init({
            providers: [provider]
        });
        console.log('âœ… hiprint.init() å®Œæˆ');

        // ä¿å­˜ provider åˆ°å…¨å±€
        window.QuoteProviderInstance = provider;

        console.log('>>> 4. æ¸²æŸ“å…ƒç´ åº“HTML');
        // å¿…é¡»æ‰‹åŠ¨æ¸²æŸ“HTMLï¼Œå› ä¸ºbuild()æ˜¯Vueç»„ä»¶æ–¹æ³•
        renderElementLibraryHTML();

        console.log('>>> 5. ä½¿ç”¨buildByHtmlæ¿€æ´»æ‹–æ‹½');
        // ä½¿ç”¨å®˜æ–¹ buildByHtml æ¿€æ´»æ‹–æ‹½åŠŸèƒ½
        hiprint.PrintElementTypeManager.buildByHtml($('.ep-draggable-item'));
        console.log('âœ… buildByHtml() å®Œæˆ');

        console.log('âœ… å…ƒç´ æä¾›å™¨åˆå§‹åŒ–æˆåŠŸ');
        updateDebugInfo('âœ… å…ƒç´ åº“å·²åŠ è½½');
    } catch (e) {
        console.error('âŒ å…ƒç´ æä¾›å™¨åˆå§‹åŒ–å¤±è´¥:', e);
        console.error('é”™è¯¯å †æ ˆ:', e.stack);
        updateDebugInfo('âŒ å…ƒç´ åº“åŠ è½½å¤±è´¥: ' + e.message);
        $('#PrintElementTypeManager').html(`
            <div style="padding: 20px; text-align: center; color: #ef4444;">
                <p style="font-size: 12px;">âŒ å…ƒç´ åº“åŠ è½½å¤±è´¥</p>
                <p style="font-size: 11px; margin-top: 10px; color: #6b7280;">
                    é”™è¯¯: ${e.message}
                </p>
                <button onclick="initElementProvider()" style="margin-top: 10px; padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    é‡è¯•
                </button>
            </div>
        `);
    }
}

// æ¸²æŸ“å…ƒç´ åº“HTML
// æ³¨æ„ï¼šå¿…é¡»æ‰‹åŠ¨æ¸²æŸ“HTMLï¼Œå› ä¸ºåœ¨éVueç¯å¢ƒä¸‹build()ä¸å¯ç”¨
function renderElementLibraryHTML() {
    console.log('>>> å¼€å§‹æ¸²æŸ“å…ƒç´ åº“HTML');

    var $container = $('#PrintElementTypeManager');
    $container.empty();

    // è·å–å·²æ³¨å†Œçš„å…ƒç´ ç±»å‹
    // HiPrintå†…éƒ¨å·²é€šè¿‡addElementTypesæ³¨å†Œäº†æ‰€æœ‰å…ƒç´ 
    // æˆ‘ä»¬éœ€è¦è¯»å–è¿™äº›å…ƒç´ å¹¶æ¸²æŸ“æˆHTML

    var html = '';

    // å®šä¹‰æ‰€æœ‰åˆ†ç»„åŠå…¶å…ƒç´ ï¼ˆä¸Providerä¸­å®šä¹‰ä¸€è‡´ï¼‰
    var elementGroups = [
        {
            title: 'ğŸ“ åŸºç¡€å…ƒç´ ',
            elements: [
                { tid: 'QuoteProvider.text', title: 'æ–‡æœ¬' },
                { tid: 'QuoteProvider.title', title: 'æ ‡é¢˜' },
                { tid: 'QuoteProvider.image', title: 'å›¾ç‰‡' }
            ]
        },
        {
            title: 'â” çº¿æ¡å…ƒç´ ',
            elements: [
                { tid: 'QuoteProvider.hline', title: 'æ¨ªçº¿' },
                { tid: 'QuoteProvider.vline', title: 'ç«–çº¿' }
            ]
        },
        {
            title: 'â–¦ æ¡ç å…ƒç´ ',
            elements: [
                { tid: 'QuoteProvider.barcode', title: 'æ¡å½¢ç ' },
                { tid: 'QuoteProvider.qrcode', title: 'äºŒç»´ç ' }
            ]
        },
        {
            title: 'ğŸ”– åŸºæœ¬ä¿¡æ¯',
            elements: [
                { tid: 'QuoteProvider.field.quote_number', title: 'æŠ¥ä»·å•å·' },
                { tid: 'QuoteProvider.field.quote_date', title: 'æŠ¥ä»·æ—¥æœŸ' },
                { tid: 'QuoteProvider.field.valid_until', title: 'æœ‰æ•ˆæœŸè‡³' },
                { tid: 'QuoteProvider.field.quote_type', title: 'æŠ¥ä»·ç±»å‹' },
                { tid: 'QuoteProvider.field.reference_number', title: 'å‚è€ƒç¼–å·' },
                { tid: 'QuoteProvider.field.sales_rep', title: 'é”€å”®ä»£è¡¨' },
                { tid: 'QuoteProvider.field.print_date', title: 'æ‰“å°æ—¥æœŸ' }
            ]
        },
        {
            title: 'å®¢æˆ·ä¿¡æ¯',
            elements: [
                { tid: 'QuoteProvider.field.customer_name', title: 'å®¢æˆ·åç§°' },
                { tid: 'QuoteProvider.field.customer_phone', title: 'å®¢æˆ·ç”µè¯' },
                { tid: 'QuoteProvider.field.customer_address', title: 'å®¢æˆ·åœ°å€' },
                { tid: 'QuoteProvider.field.contact_person', title: 'è”ç³»äºº' },
                { tid: 'QuoteProvider.field.contact_phone', title: 'è”ç³»ç”µè¯' },
                { tid: 'QuoteProvider.field.contact_email', title: 'è”ç³»é‚®ç®±' }
            ]
        },
        {
            title: 'ğŸ’° é‡‘é¢ä¿¡æ¯',
            elements: [
                { tid: 'QuoteProvider.field.currency', title: 'å¸ç§' },
                { tid: 'QuoteProvider.field.exchange_rate', title: 'æ±‡ç‡' },
                { tid: 'QuoteProvider.field.subtotal', title: 'å°è®¡é‡‘é¢' },
                { tid: 'QuoteProvider.field.discount_amount', title: 'æŠ˜æ‰£é‡‘é¢' },
                { tid: 'QuoteProvider.field.tax_amount', title: 'ç¨é¢' },
                { tid: 'QuoteProvider.field.total_amount', title: 'æ€»é‡‘é¢' }
            ]
        },
        {
            title: 'ğŸ“‹ æ¡æ¬¾ä¿¡æ¯',
            elements: [
                { tid: 'QuoteProvider.field.payment_terms', title: 'ä»˜æ¬¾æ¡æ¬¾' },
                { tid: 'QuoteProvider.field.delivery_terms', title: 'äº¤ä»˜æ¡æ¬¾' },
                { tid: 'QuoteProvider.field.warranty_terms', title: 'è´¨ä¿æ¡æ¬¾' },
                { tid: 'QuoteProvider.field.notes', title: 'å¤‡æ³¨' }
            ]
        },
        {
            title: 'ğŸ¢ å…¬å¸ä¿¡æ¯',
            elements: [
                { tid: 'QuoteProvider.field.company_name', title: 'å…¬å¸åç§°' },
                { tid: 'QuoteProvider.field.company_address', title: 'å…¬å¸åœ°å€' },
                { tid: 'QuoteProvider.field.company_phone', title: 'å…¬å¸ç”µè¯' },
                { tid: 'QuoteProvider.field.company_email', title: 'å…¬å¸é‚®ç®±' }
            ]
        },
        {
            title: 'ğŸ“¦ æ˜ç»†é¡¹å­—æ®µ',
            elements: [
                { tid: 'QuoteProvider.itemField.index', title: 'åºå·' },
                { tid: 'QuoteProvider.itemField.product_code', title: 'äº§å“ç¼–ç ' },
                { tid: 'QuoteProvider.itemField.product_name', title: 'äº§å“åç§°' },
                { tid: 'QuoteProvider.itemField.specification', title: 'è§„æ ¼å‹å·' },
                { tid: 'QuoteProvider.itemField.quantity', title: 'æ•°é‡' },
                { tid: 'QuoteProvider.itemField.unit', title: 'å•ä½' },
                { tid: 'QuoteProvider.itemField.unit_price', title: 'å•ä»·' },
                { tid: 'QuoteProvider.itemField.discount_rate', title: 'æŠ˜æ‰£ç‡' },
                { tid: 'QuoteProvider.itemField.tax_rate', title: 'ç¨ç‡' },
                { tid: 'QuoteProvider.itemField.subtotal', title: 'å°è®¡' },
                { tid: 'QuoteProvider.itemField.lead_time', title: 'äº¤è´§æœŸ' },
                { tid: 'QuoteProvider.itemField.notes', title: 'å¤‡æ³¨' }
            ]
        }
    ];

    // æ¸²æŸ“æ¯ä¸ªåˆ†ç»„
    elementGroups.forEach(function(group) {
        html += `
            <div class="ep-category" style="margin-bottom: 15px;">
                <h5 style="font-size: 11px; color: #374151; margin-bottom: 8px; font-weight: bold; padding: 5px; background: #f3f4f6; border-radius: 4px;">
                    ${group.title}
                </h5>
                <div class="ep-category-elements">
        `;

        // æ¸²æŸ“è¯¥åˆ†ç»„ä¸‹çš„å…ƒç´ 
        group.elements.forEach(function(element) {
            html += `
                <div class="ep-draggable-item"
                     tid="${element.tid}"
                     title="${element.title}"
                     style="padding: 6px 10px; margin-bottom: 4px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: move; font-size: 11px; transition: all 0.2s;">
                    <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg>
                    ${element.title}
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    $container.html(html);

    // æ·»åŠ æ ·å¼
    if (!$('#ep-element-styles').length) {
        $('<style id="ep-element-styles">')
            .text(`
                .ep-draggable-item:hover {
                    background: #f3f4f6 !important;
                    border-color: #3b82f6 !important;
                    transform: translateX(2px);
                }
                .ep-draggable-item:active {
                    opacity: 0.6;
                }
            `)
            .appendTo('head');
    }

    console.log('>>> å…ƒç´ åº“HTMLæ¸²æŸ“å®Œæˆï¼Œå…±', elementGroups.length, 'ä¸ªåˆ†ç»„');
}

// æ˜¾ç¤ºä¸´æ—¶æç¤ºæ¶ˆæ¯
function showTemporaryMessage(message, type) {
    // ç§»é™¤æ—§çš„æç¤º
    $('.temp-message').remove();

    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼å’Œå›¾æ ‡
    type = type || 'success';  // é»˜è®¤ä¸º success
    var styles = {
        success: { bg: '#10b981', svg: '<svg class="w-5 h-5 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
        info: { bg: '#3b82f6', svg: '<svg class="w-5 h-5 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' },
        warning: { bg: '#f59e0b', svg: '<svg class="w-5 h-5 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' },
        error: { bg: '#ef4444', svg: '<svg class="w-5 h-5 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' }
    };
    var style = styles[type] || styles.success;

    // åˆ›å»ºæ–°æç¤º
    var $message = $('<div class="temp-message" style="position: fixed; top: 80px; right: 20px; background: ' + style.bg + '; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; animation: slideIn 0.3s ease-out;">' +
        style.svg + message +
        '</div>');

    $('body').append($message);

    // æ ¹æ®ç±»å‹è®¾ç½®æ¶ˆå¤±æ—¶é—´
    var duration = type === 'error' ? 5000 : 3000;
    setTimeout(function() {
        $message.fadeOut(300, function() {
            $(this).remove();
        });
    }, duration);
}

// æ·»åŠ åŠ¨ç”»æ ·å¼
$('<style>').text(`
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
`).appendTo('head');

// ==================== ç”»å¸ƒå°ºå¯¸ç®¡ç†åŠŸèƒ½ ====================

// çº¸å¼ å°ºå¯¸é¢„è®¾ (mm)
const paperSizes = {
    // Aç³»åˆ—
    a3: { width: 297, height: 420, name: 'A3' },
    a4: { width: 210, height: 297, name: 'A4' },
    a5: { width: 148, height: 210, name: 'A5' },
    a6: { width: 105, height: 148, name: 'A6' },
    a7: { width: 74, height: 105, name: 'A7' },

    // Bç³»åˆ—
    b4: { width: 250, height: 353, name: 'B4' },
    b5: { width: 176, height: 250, name: 'B5' },
    b6: { width: 125, height: 176, name: 'B6' },

    // åŒ—ç¾æ ‡å‡†
    letter: { width: 216, height: 279, name: 'Letter' },
    legal: { width: 216, height: 356, name: 'Legal' },
    tabloid: { width: 279, height: 432, name: 'Tabloid' },

    // ä¸­å›½æ ‡å‡†å¼€æœ¬
    '16k': { width: 185, height: 260, name: '16å¼€' },
    '8k': { width: 270, height: 390, name: '8å¼€' },
    '4k': { width: 390, height: 540, name: '4å¼€' },

    // çƒ­æ•æ‰“å°ï¼ˆå°ç¥¨ï¼‰
    thermal_58: { width: 58, height: 210, name: '58mmå°ç¥¨' },
    thermal_80: { width: 80, height: 210, name: '80mmå°ç¥¨' },
    thermal_110: { width: 110, height: 210, name: '110mmå®½å¹…' },

    // æ ‡ç­¾å°ºå¯¸
    label_40x30: { width: 40, height: 30, name: 'æ ‡ç­¾40Ã—30' },
    label_50x30: { width: 50, height: 30, name: 'æ ‡ç­¾50Ã—30' },
    label_60x40: { width: 60, height: 40, name: 'æ ‡ç­¾60Ã—40' },
    label_80x50: { width: 80, height: 50, name: 'æ ‡ç­¾80Ã—50' },
    label_100x60: { width: 100, height: 60, name: 'æ ‡ç­¾100Ã—60' },
    label_100x100: { width: 100, height: 100, name: 'æ ‡ç­¾100Ã—100' },

    // ç‰©æµå¿«é€’å•
    express_100x100: { width: 100, height: 100, name: 'å¿«é€’å•100Ã—100' },
    express_100x150: { width: 100, height: 150, name: 'å¿«é€’å•100Ã—150' },
    express_100x180: { width: 100, height: 180, name: 'å¿«é€’å•100Ã—180' }
};

// æ˜¾ç¤ºç”»å¸ƒå°ºå¯¸è®¾ç½®é¢æ¿
function showCanvasSizePanel() {
    var $panel = $('#canvasSizePanel');

    if ($panel.is(':visible')) {
        $panel.slideUp(300);
    } else {
        // è¯»å–å½“å‰ç”»å¸ƒå°ºå¯¸
        if (hiprintTemplate && hiprintTemplate.printPanels && hiprintTemplate.printPanels[0]) {
            var currentPanel = hiprintTemplate.printPanels[0];
            var panelOptions = currentPanel.options || {};

            $('#canvasWidth').val(panelOptions.width || 210);
            $('#canvasHeight').val(panelOptions.height || 297);
            $('#marginTop').val(panelOptions.paperHeader || 10);
            $('#marginBottom').val(panelOptions.paperFooter || 10);
            $('#marginLeft').val(panelOptions.leftOffset || 10);
            $('#marginRight').val(panelOptions.rightOffset || 10);

            updateCanvasSizeInfo();
        }

        $panel.slideDown(300);
    }
}

// éšè—ç”»å¸ƒå°ºå¯¸è®¾ç½®é¢æ¿
function hideCanvasSizePanel() {
    $('#canvasSizePanel').slideUp(300);
}

// åº”ç”¨é¢„è®¾çº¸å¼ å°ºå¯¸
function applyPaperSize() {
    var paperType = $('#paperSizeSelect').val();
    var orientation = $('#orientationSelect').val();

    if (paperType === 'custom') {
        // è‡ªå®šä¹‰å°ºå¯¸ - ä¸åšä»»ä½•æ“ä½œ
        $('#canvasWidth').prop('disabled', false);
        $('#canvasHeight').prop('disabled', false);
        return;
    }

    // ç¦ç”¨è‡ªå®šä¹‰è¾“å…¥
    $('#canvasWidth').prop('disabled', true);
    $('#canvasHeight').prop('disabled', true);

    var size = paperSizes[paperType];
    if (!size) {
        console.error('æœªçŸ¥çš„çº¸å¼ ç±»å‹:', paperType);
        return;
    }

    var width = size.width;
    var height = size.height;

    // æ¨ªå‘åˆ™äº¤æ¢å®½é«˜
    if (orientation === 'landscape') {
        [width, height] = [height, width];
    }

    $('#canvasWidth').val(width);
    $('#canvasHeight').val(height);

    // æ™ºèƒ½è®¾ç½®é¡µè¾¹è·
    autoSetMargins(paperType, width, height);

    // è‡ªåŠ¨åº”ç”¨
    applyCustomSize();
}

// æ ¹æ®çº¸å¼ ç±»å‹æ™ºèƒ½è®¾ç½®é¡µè¾¹è·
function autoSetMargins(paperType, width, height) {
    var margin = { top: 10, bottom: 10, left: 10, right: 10 };

    // çƒ­æ•æ‰“å°å°ç¥¨ - å°é¡µè¾¹è·
    if (paperType.startsWith('thermal_')) {
        margin = { top: 2, bottom: 2, left: 2, right: 2 };
    }
    // æ ‡ç­¾ - æœ€å°é¡µè¾¹è·
    else if (paperType.startsWith('label_')) {
        margin = { top: 1, bottom: 1, left: 1, right: 1 };
    }
    // å¿«é€’å• - å°é¡µè¾¹è·
    else if (paperType.startsWith('express_')) {
        margin = { top: 3, bottom: 3, left: 3, right: 3 };
    }
    // A7, B6 ç­‰å°å°ºå¯¸ - è¾ƒå°é¡µè¾¹è·
    else if (width < 120 || height < 120) {
        margin = { top: 5, bottom: 5, left: 5, right: 5 };
    }
    // A3, B4, Tabloid ç­‰å¤§å°ºå¯¸ - è¾ƒå¤§é¡µè¾¹è·
    else if (width > 250 || height > 350) {
        margin = { top: 15, bottom: 15, left: 15, right: 15 };
    }
    // æ ‡å‡†å°ºå¯¸ - é»˜è®¤10mm
    else {
        margin = { top: 10, bottom: 10, left: 10, right: 10 };
    }

    $('#marginTop').val(margin.top);
    $('#marginBottom').val(margin.bottom);
    $('#marginLeft').val(margin.left);
    $('#marginRight').val(margin.right);

    console.log('è‡ªåŠ¨è®¾ç½®é¡µè¾¹è·:', margin);
}

// åº”ç”¨è‡ªå®šä¹‰å°ºå¯¸
function applyCustomSize() {
    var width = parseFloat($('#canvasWidth').val());
    var height = parseFloat($('#canvasHeight').val());
    var marginTop = parseFloat($('#marginTop').val());
    var marginBottom = parseFloat($('#marginBottom').val());
    var marginLeft = parseFloat($('#marginLeft').val());
    var marginRight = parseFloat($('#marginRight').val());

    // éªŒè¯è¾“å…¥
    if (!width || !height || width < 50 || height < 50) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”»å¸ƒå°ºå¯¸ï¼ˆè‡³å°‘50mmï¼‰');
        return;
    }

    console.log('åº”ç”¨æ–°ç”»å¸ƒå°ºå¯¸:', width, 'x', height);

    try {
        if (!hiprintTemplate) {
            alert('æ¨¡æ¿æœªåˆå§‹åŒ–');
            return;
        }

        // è·å–å½“å‰æ‰€æœ‰å…ƒç´ 
        var currentJson = hiprintTemplate.getJson();
        var elements = [];

        if (currentJson.panels && currentJson.panels[0] && currentJson.panels[0].printElements) {
            elements = currentJson.panels[0].printElements;
            console.log('ä¿å­˜äº†', elements.length, 'ä¸ªå…ƒç´ ');
        }

        // æ¸…ç©ºå®¹å™¨ï¼ˆé˜²æ­¢å‡ºç°å¤šä¸ªç”»å¸ƒï¼‰
        $('#design-container').empty();

        // åˆ›å»ºæ–°çš„æ¨¡æ¿ JSONï¼ŒåŒ…å«æ–°çš„ç”»å¸ƒå°ºå¯¸å’Œæ—§çš„å…ƒç´ 
        var newTemplateJson = {
            panels: [
                {
                    index: 0,
                    width: width,
                    height: height,
                    paperHeader: marginTop || 10,
                    paperFooter: marginBottom || 10,
                    leftOffset: marginLeft || 10,
                    rightOffset: marginRight || 10,
                    printElements: elements  // ä¿ç•™åŸæœ‰å…ƒç´ 
                }
            ]
        };

        console.log('åˆ›å»ºæ–°æ¨¡æ¿ï¼Œç”»å¸ƒå°ºå¯¸:', width, 'x', height, 'å…ƒç´ æ•°é‡:', elements.length);

        // é‡æ–°åˆ›å»ºæ¨¡æ¿å®ä¾‹
        hiprintTemplate = new hiprint.PrintTemplate({
            template: newTemplateJson,
            settingContainer: '#param-container'
        });

        // æ¸²æŸ“åˆ°å®¹å™¨
        hiprintTemplate.design('#design-container');

        console.log('âœ… ç”»å¸ƒå°ºå¯¸å·²æ›´æ–°å¹¶é‡æ–°æ¸²æŸ“');

        // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
        updateCanvasSizeInfo();

        showTemporaryMessage('ç”»å¸ƒå°ºå¯¸å·²æ›´æ–°ï¼', 'success');

    } catch (error) {
        console.error('æ›´æ–°ç”»å¸ƒå°ºå¯¸å¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
        alert('æ›´æ–°å¤±è´¥: ' + error.message);
    }
}

// æ›´æ–°ç”»å¸ƒå°ºå¯¸ä¿¡æ¯æ˜¾ç¤º
function updateCanvasSizeInfo() {
    var width = $('#canvasWidth').val();
    var height = $('#canvasHeight').val();
    var paperType = $('#paperSizeSelect').val();
    var orientation = $('#orientationSelect').val();

    var orientationText = orientation === 'portrait' ? 'çºµå‘' : 'æ¨ªå‘';
    var paperName = paperType === 'custom' ? 'è‡ªå®šä¹‰' : (paperSizes[paperType]?.name || paperType.toUpperCase());

    $('#canvasSizeInfo').text(`å½“å‰ç”»å¸ƒ: ${width}mm Ã— ${height}mm (${paperName} ${orientationText})`);
}

// ==================== ç”»å¸ƒå°ºå¯¸ç®¡ç†åŠŸèƒ½ç»“æŸ ====================

// è·å–ç¤ºä¾‹æ•°æ®ï¼ˆç”¨äºé¢„è§ˆå’Œæµ‹è¯•ï¼‰
function getSampleData() {
    return {
        // åŸºæœ¬ä¿¡æ¯
        quote_number: 'BL-Q-20250107-001',
        quote_date: '2025-01-07',
        valid_until: '2025-02-07',
        quote_type: 'å›½å†…æŠ¥ä»·',
        reference_number: 'REF-2025-001',
        sales_rep: 'å¼ ä¸‰',
        print_date: '2025-01-07 14:30',

        // å®¢æˆ·ä¿¡æ¯
        customer_name: 'ç¤ºä¾‹å®¢æˆ·æœ‰é™å…¬å¸',
        customer_phone: '0755-12345678',
        customer_address: 'å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­å—è·¯1å·',
        contact_person: 'æç»ç†',
        contact_phone: '13800138000',
        contact_email: 'li@example.com',

        // é‡‘é¢ä¿¡æ¯
        currency: 'CNY',
        exchange_rate: '1.00',
        subtotal: '15000.00',
        discount_amount: '500.00',
        tax_amount: '1935.00',
        total_amount: '16435.00',

        // æ¡æ¬¾ä¿¡æ¯
        payment_terms: 'é¢„ä»˜30%ï¼Œå‘è´§å‰ä»˜æ¸…ä½™æ¬¾',
        delivery_terms: 'å‘è´§å5-7ä¸ªå·¥ä½œæ—¥é€è¾¾',
        warranty_terms: 'è´¨ä¿æœŸ12ä¸ªæœˆ',
        notes: 'æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼',

        // å…¬å¸ä¿¡æ¯
        company_name: '{{ template.company_name }}',
        company_address: '{{ template.company_address }}',
        company_phone: '{{ template.company_phone }}',
        company_email: '{{ template.company_email }}',

        // â­ æ˜ç»†é¡¹æ•°æ® - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
        items: [
            {
                index: 1,
                product_code: 'BL-LS-1000',
                product_name: 'å…‰çº¤æ¿€å…‰å™¨ 1000W',
                specification: 'IPG YLR-1000',
                quantity: '2',
                unit: 'å°',
                unit_price: '35000.00',
                discount_rate: '5%',
                tax_rate: '13%',
                subtotal: '70000.00',
                lead_time: '30å¤©',
                notes: 'å«é…ä»¶'
            },
            {
                index: 2,
                product_code: 'BL-CUT-3015',
                product_name: 'æ¿€å…‰åˆ‡å‰²æœº 3015',
                specification: 'å·¥ä½œå° 3000Ã—1500mm',
                quantity: '1',
                unit: 'å°',
                unit_price: '280000.00',
                discount_rate: '8%',
                tax_rate: '13%',
                subtotal: '280000.00',
                lead_time: '45å¤©',
                notes: 'å«åŸ¹è®­'
            },
            {
                index: 3,
                product_code: 'BL-ACC-001',
                product_name: 'æ¿€å…‰é˜²æŠ¤çœ¼é•œ',
                specification: 'OD5+ é˜²æŠ¤çº§åˆ«',
                quantity: '10',
                unit: 'å‰¯',
                unit_price: '150.00',
                discount_rate: '0%',
                tax_rate: '13%',
                subtotal: '1500.00',
                lead_time: '7å¤©',
                notes: 'æ ‡é…'
            },
            {
                index: 4,
                product_code: 'BL-SRV-001',
                product_name: 'å®‰è£…è°ƒè¯•æœåŠ¡',
                specification: 'ç°åœºå®‰è£…ã€è°ƒè¯•åŠéªŒæ”¶',
                quantity: '1',
                unit: 'é¡¹',
                unit_price: '8000.00',
                discount_rate: '0%',
                tax_rate: '6%',
                subtotal: '8000.00',
                lead_time: 'éšæœºå‘è´§',
                notes: 'å«å·®æ—…è´¹'
            }
        ]
    };
}
</script>
{% endblock %}
