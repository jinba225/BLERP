<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å°æŠ¥ä»·å• - {{ quote.quote_number }}</title>

    {% load static %}

    <!-- æ‰€æœ‰ä¾èµ–åº“ - æœ¬åœ°æ–‡ä»¶ -->
    <script src="{% static 'js/libs/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/libs/jsbarcode.min.js' %}"></script>
    <script src="{% static 'js/libs/socket.io.min.js' %}"></script>

    <!-- âœ¨ å…³é”®ï¼å¿…é¡»åœ¨ socket.io åŠ è½½åã€HiPrint åŠ è½½å‰ç¦ç”¨è¿æ¥ -->
    <script>
        console.log('ğŸ”§ é…ç½® socket.io ä¸ºç¦ç”¨æ¨¡å¼ï¼ˆåœ¨ HiPrint åŠ è½½å‰ï¼‰');
        if (typeof io !== 'undefined') {
            // ä¿å­˜åŸå§‹æ–¹æ³•
            var originalConnect = io.connect || io;
            var originalManager = io.Manager;

            // åˆ›å»ºç©ºå¯¹è±¡ï¼Œé¿å…è¿æ¥
            var dummySocket = {
                on: function() { return this; },
                once: function() { return this; },
                off: function() { return this; },
                emit: function() { return this; },
                close: function() { return this; },
                disconnect: function() { return this; },
                connect: function() { return this; },
                send: function() { return this; }
            };

            // é‡å†™ io æ–¹æ³•
            io.connect = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io è¿æ¥å°è¯•');
                return dummySocket;
            };

            io.Manager = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io Manager åˆå§‹åŒ–');
                return dummySocket;
            };

            // ç›´æ¥è°ƒç”¨ io() çš„æƒ…å†µ
            window.io = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io ç›´æ¥è°ƒç”¨');
                return dummySocket;
            };
            window.io.connect = io.connect;
            window.io.Manager = io.Manager;

            console.log('âœ… socket.io å·²å®Œå…¨ç¦ç”¨');
        } else {
            console.warn('âš ï¸ socket.io æœªæ‰¾åˆ°');
        }
    </script>

    <script src="{% static 'js/libs/jspdf.umd.min.js' %}"></script>
    <script src="{% static 'js/libs/html2canvas.min.js' %}"></script>
    <script src="{% static 'js/libs/canvg.umd.min.js' %}"></script>

    <!-- HiPrint CSS -->
    <link rel="stylesheet" href="{% static 'js/libs/print-lock.css' %}">

    <!-- âœ¨ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ Object.defineProperty é”å®š autoConnect ä¸º falseï¼ˆä¸å¯è¢« HiPrint è¦†ç›–ï¼‰ -->
    <script>
        console.log('ğŸ”§ [æ ¸å¿ƒä¿®å¤] é”å®š window.autoConnect = falseï¼ˆä¸å¯å†™ã€ä¸å¯åˆ é™¤ï¼‰');

        // ä½¿ç”¨ Object.defineProperty å¼ºåˆ¶é”å®š autoConnect å±æ€§
        // HiPrint åŠ è½½æ—¶ä¼šå°è¯•è®¾ç½® window.autoConnect = trueï¼Œä½†ä¼šè¢«æ‹¦æˆª
        Object.defineProperty(window, 'autoConnect', {
            get: function() {
                // å§‹ç»ˆè¿”å› false
                return false;
            },
            set: function(value) {
                // æ‹¦æˆªæ‰€æœ‰è®¾ç½®å°è¯•
                console.warn('âš ï¸ æ‹¦æˆªè®¾ç½® window.autoConnect =', value, 'ï¼ˆå¼ºåˆ¶ä¿æŒ falseï¼‰');
            },
            configurable: false,  // ä¸å¯åˆ é™¤
            enumerable: true
        });

        console.log('âœ… window.autoConnect å·²é”å®šä¸º falseï¼ŒHiPrint æ— æ³•è¦†ç›–');

        // âœ¨ æ”¹è¿›çš„ alert æ‹¦æˆªå™¨ï¼šæ‹¦æˆªå®¢æˆ·ç«¯è¿æ¥è­¦å‘Šå¹¶è§¦å‘æµè§ˆå™¨æ‰“å°
        var originalAlert = window.alert;
        var isPrintingTriggered = false;  // é˜²æ­¢é‡å¤è§¦å‘

        window.alert = function(message) {
            console.log('ğŸš¨ [ALERT æ‹¦æˆª] å¼¹çª—å†…å®¹:', message);

            // å¦‚æœæ˜¯å®¢æˆ·ç«¯è¿æ¥ç›¸å…³çš„è­¦å‘Šï¼Œæ‹¦æˆªå¹¶è§¦å‘æµè§ˆå™¨æ‰“å°
            if (message && message.includes &&
                (message.includes('è¿æ¥') || message.includes('å®¢æˆ·ç«¯') || message.includes('å¤±è´¥'))) {
                console.warn('âš ï¸ å·²æ‹¦æˆªå®¢æˆ·ç«¯è¿æ¥è­¦å‘Šå¼¹çª—');

                // âœ¨ å…³é”®ï¼šåœ¨æ‹¦æˆªåï¼Œä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ‰“å°
                if (!isPrintingTriggered) {
                    isPrintingTriggered = true;
                    console.log('ğŸ–¨ï¸ è§¦å‘æµè§ˆå™¨åŸç”Ÿæ‰“å°...');

                    setTimeout(function() {
                        window.print();  // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ‰“å°
                        isPrintingTriggered = false;  // é‡ç½®æ ‡å¿—
                    }, 100);
                }

                return;  // ä¸æ˜¾ç¤ºå¼¹çª—
            }

            // å…¶ä»–è­¦å‘Šæ­£å¸¸æ˜¾ç¤º
            return originalAlert.call(window, message);
        };
        console.log('âœ… alert æ‹¦æˆªå™¨å·²å¯ç”¨ï¼ˆæ‹¦æˆªåè§¦å‘æµè§ˆå™¨æ‰“å°ï¼‰');
</script>

    <!-- HiPrint JS -->
    <script src="{% static 'js/libs/vue-plugin-hiprint.js' %}"></script>

    <script>
        // éªŒè¯ autoConnect é”å®šæ˜¯å¦ç”Ÿæ•ˆ
        console.log('âœ… HiPrint å·²åŠ è½½');
        console.log('   window.autoConnect =', window.autoConnect, 'ï¼ˆåº”è¯¥æ˜¯ falseï¼‰');
        console.log('   typeof hiprint:', typeof hiprint);

        // âœ¨âœ¨âœ¨ å…³é”®ï¼šä¸æ›¿æ¢ print2 æ–¹æ³•ï¼Œä½¿ç”¨åŸå§‹æ–¹æ³•
        // å› ä¸ºåŸå§‹æ–¹æ³•æ”¯æŒæ˜ç»†é¡¹ï¼ˆtableï¼‰çš„å¾ªç¯æ¸²æŸ“
        // æˆ‘ä»¬å·²ç»é€šè¿‡ autoConnect = false å’Œ alert æ‹¦æˆªå™¨ç¦ç”¨äº†å®¢æˆ·ç«¯è¿æ¥
        console.log('ğŸ”§ ä½¿ç”¨ HiPrint åŸå§‹ print2 æ–¹æ³•ï¼ˆæ”¯æŒæ˜ç»†é¡¹å¾ªç¯æ¸²æŸ“ï¼‰');
        console.log('   å·²é€šè¿‡ autoConnect=false å’Œ alert æ‹¦æˆªå™¨ç¦ç”¨å®¢æˆ·ç«¯è¿æ¥');
</script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @media print {
            .no-print { display: none !important; }
            @page {
                size: A4 portrait;
                margin: 0;  /* ç§»é™¤é¡µé¢å¤–éƒ¨è¾¹è· */
            }
            body {
                margin: 0;
                padding: 1cm;  /* åœ¨bodyå†…éƒ¨æ·»åŠ è¾¹è· */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                box-sizing: border-box;
            }
            #print-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                max-height: calc(297mm - 2cm);  /* A4é«˜åº¦å‡å»ä¸Šä¸‹å†…è¾¹è· */
                overflow: hidden;
            }
        }

        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .toolbar {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar button,
        .toolbar a {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(107, 114, 128, 0.3);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }

        #print-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 400px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .template-info {
            font-size: 12px;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* âœ¨ æ¨¡æ¿é€‰æ‹©å™¨æ ·å¼ */
        .template-selector {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #374151;
            background: white;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.2s;
        }

        .template-selector:hover {
            border-color: #3b82f6;
        }

        .template-selector:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* âœ¨ è®¾ä¸ºé»˜è®¤æŒ‰é’®æ ·å¼ */
        .btn-set-default {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-set-default:hover {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #f59e0b;
            transform: scale(1.05);
        }

        .btn-set-default.is-default {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .btn-set-default i {
            transition: all 0.2s;
        }

        .btn-set-default.is-default i {
            color: #f59e0b;
        }

        /* HiPrintç”»å¸ƒæ ·å¼ */
        .hiprint-printPanel {
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white !important;
            position: relative;
        }

        /* âœ¨ å…³é”®ä¿®å¤ï¼šæ‰“å°æ ·å¼ä¼˜åŒ– */
        @media print {
            /* ä¸è¦†ç›– JavaScript è®¾ç½®çš„é«˜åº¦ï¼Œè®©å†…å®¹å†³å®šé«˜åº¦ */
            .hiprint-printPanel {
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                box-shadow: none !important;
                border: none !important;
                /* é‡è¦ï¼šä¸è®¾ç½® heightï¼Œä¿æŒ JavaScript è®¾ç½®çš„å€¼ */
            }
        }

        /* HiPrintå…ƒç´ æ ·å¼ */
        .hiprint-printElement {
            user-select: none;
            pointer-events: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            border-radius: 8px;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            padding: 40px;
            text-align: center;
        }

        .error-icon {
            font-size: 48px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .info-icon {
            font-size: 48px;
            color: #f59e0b;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="no-print toolbar">
        <div class="template-info">
            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
</svg>
            <span>æ‰“å°æ¨¡æ¿:</span>
            <!-- âœ¨ æ¨¡æ¿é€‰æ‹©å™¨ä¸‹æ‹‰èœå• -->
            <select id="template-selector" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="{{ template.id }}" selected>{{ template.name }}</option>
            </select>
            <!-- âœ¨ è®¾ä¸ºé»˜è®¤æŒ‰é’® -->
            <button onclick="setAsDefaultTemplate()" class="btn-set-default" title="è®¾ä¸ºé»˜è®¤æ¨¡æ¿">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
</svg>
            </button>
        </div>
        <div>
            <button onclick="printDoc()" class="btn-success">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
</svg> æ‰“å°
            </button>
            <button onclick="exportPDF()" class="btn-warning">
                <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg> å¯¼å‡ºPDF
            </button>
            <button onclick="window.close()" class="btn-secondary">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg> å…³é—­
            </button>
        </div>
    </div>

    <div id="print-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div style="text-align: center;">
                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                <p style="color: #6b7280; font-size: 14px;">æ­£åœ¨åŠ è½½æ‰“å°æ¨¡æ¿...</p>
            </div>
        </div>
    </div>

    <script>
    let hiprintTemplate;
    let quoteData;

    // ç­‰å¾…æ‰€æœ‰åº“åŠ è½½å®Œæˆ
    window.addEventListener('load', function() {
        console.log('âœ… [DEBUG 5/5] é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
        console.log('   window.autoConnect =', window.autoConnect);
        console.log('=== é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ– ===');

        // âœ¨ æ£€æŸ¥æ‰€æœ‰ä¾èµ–åº“æ˜¯å¦åŠ è½½æˆåŠŸ
        console.log('=== åº“åŠ è½½çŠ¶æ€æ£€æŸ¥ ===');
        console.log('jQuery:', typeof jQuery !== 'undefined' ? 'âœ… ' + jQuery.fn.jquery : 'âŒ');
        console.log('JsBarcode:', typeof JsBarcode !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('socket.io:', typeof io !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('jsPDF:', typeof jspdf !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('html2canvas:', typeof html2canvas !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('canvg:', typeof canvg !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('hiprint:', typeof hiprint !== 'undefined' ? 'âœ…' : 'âŒ');
        console.log('========================');

        // æ£€æŸ¥ HiPrint æ˜¯å¦åŠ è½½
        if (typeof hiprint === 'undefined') {
            console.error('âŒ HiPrint æœªåŠ è½½ï¼');
            console.error('é™æ€æ–‡ä»¶è·¯å¾„æ£€æŸ¥: {% static "libs/vue-plugin-hiprint.js" %}');

            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }

            showError('HiPrint æ‰“å°ç»„ä»¶æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
            return;
        }

        // æ£€æŸ¥ jQuery
        if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
            console.error('âŒ jQuery æœªåŠ è½½ï¼');
            var loadingOverlay2 = document.getElementById('loadingOverlay');
            if (loadingOverlay2) {
                loadingOverlay2.style.display = 'none';
            }
            alert('jQuery æœªåŠ è½½ï¼Œé¡µé¢æ— æ³•æ­£å¸¸å·¥ä½œ');
            return;
        }

        console.log('âœ… æ‰€æœ‰ä¾èµ–åº“åŠ è½½æˆåŠŸ');

        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿ DOM å®Œå…¨å‡†å¤‡å¥½
        setTimeout(initPrintPage, 100);
    });

    function initPrintPage() {
        console.log('=== æ‰“å°é¡µé¢åˆå§‹åŒ– ===');

        // è·å–æ¨¡æ¿JSON
        const templateJson = {{ layout_config_json|safe }};
        console.log('æ¨¡æ¿JSON:', templateJson);

        // è·å–æŠ¥ä»·å•æ•°æ®
        quoteData = {
            quote_number: '{{ quote.quote_number }}',
            quote_date: '{{ quote.quote_date }}',
            valid_until: '{{ quote.valid_until }}',
            quote_type: '{{ quote.get_quote_type_display }}',
            customer_name: '{{ quote.customer.name }}',
            customer_phone: '{{ quote.customer.phone|default:"" }}',
            customer_address: '{{ quote.customer.address|default:"" }}',
            contact_person: '{% if quote.contact_person %}{{ quote.contact_person.name }}{% endif %}',
            contact_phone: '{% if quote.contact_person %}{{ quote.contact_person.phone|default:"" }}{% endif %}',
            contact_email: '{% if quote.contact_person %}{{ quote.contact_person.email|default:"" }}{% endif %}',
            sales_rep: '{{ quote.sales_rep.username|default:"" }}',
            currency: '{{ quote.currency }}',
            exchange_rate: '{{ quote.exchange_rate }}',
            subtotal: '{{ quote.subtotal }}',
            discount_amount: '{{ quote.discount_amount }}',
            tax_amount: '{{ quote.tax_amount }}',
            total_amount: '{{ quote.total_amount }}',
            payment_terms: '{{ quote.payment_terms|default:"" }}',
            delivery_terms: '{{ quote.delivery_terms|default:"" }}',
            warranty_terms: '{{ quote.warranty_terms|default:"" }}',
            notes: '{{ quote.notes|default:"" }}',
            company_name: '{{ template.company_name }}',
            company_address: '{{ template.company_address }}',
            company_phone: '{{ template.company_phone }}',
            company_email: '{{ template.company_email }}',
            items: [
                {% for item in items %}
                {
                    index: {{ forloop.counter }},
                    product_code: '{{ item.product.code }}',
                    product_name: '{{ item.product.name }}',
                    specifications: '{{ item.specifications|default:"-" }}',
                    quantity: '{{ item.quantity }}',
                    unit: '{{ item.unit|default:"ä¸ª" }}',
                    unit_price: '{{ item.unit_price }}',
                    discount_rate: '{{ item.discount_rate }}',
                    discount_amount: '{{ item.discount_amount }}',
                    tax_rate: '{% if item.tax_rate %}{{ item.tax_rate }}{% else %}0{% endif %}',
                    line_total: '{{ item.line_total }}',
                    lead_time: '{% if item.lead_time %}{{ item.lead_time }}å¤©{% else %}-{% endif %}',
                    notes: '{{ item.notes|default:"" }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            print_date: '{{ print_date|date:"Yå¹´mæœˆdæ—¥ H:i" }}'
        };

        console.log('ğŸ“Š [è¯Šæ–­] æŠ¥ä»·å•æ•°æ®:', quoteData);
        console.log('ğŸ” [è¯Šæ–­] æŠ¥ä»·å•å·:', quoteData.quote_number);
        console.log('ğŸ” [è¯Šæ–­] å®¢æˆ·åç§°:', quoteData.customer_name);
        console.log('ğŸ” [è¯Šæ–­] æ˜ç»†æ•°é‡:', quoteData.items.length);
        console.log('ğŸ” [è¯Šæ–­] æ˜ç»†æ•°æ®:', quoteData.items);

        // âœ¨ å…³é”®è¯Šæ–­ï¼šæ£€æŸ¥ Django æ¨¡æ¿å˜é‡æ˜¯å¦æ­£ç¡®æ¸²æŸ“
        console.log('ğŸ”§ [Djangoæ¨¡æ¿] quote.quote_number = "{{ quote.quote_number }}"');
        console.log('ğŸ”§ [Djangoæ¨¡æ¿] quote.customer.name = "{{ quote.customer.name }}"');

        // âœ¨ è¯Šæ–­æ˜ç»†é¡¹æ•°æ®
        if (quoteData.items && quoteData.items.length > 0) {
            console.log('ğŸ” [æ˜ç»†è¯Šæ–­] ç¬¬ä¸€æ¡æ˜ç»†æ•°æ®:', quoteData.items[0]);
            console.log('ğŸ” [æ˜ç»†è¯Šæ–­] å­—æ®µæ¸…å•:', Object.keys(quoteData.items[0]));
        }

        // åˆå§‹åŒ–HiPrintæ¨¡æ¿ï¼ˆå‚è€ƒtemplate_preview.htmlçš„æˆåŠŸæ–¹æ¡ˆï¼‰
        if (templateJson && Object.keys(templateJson).length > 0) {
            try {
                console.log('åˆ›å»º HiPrint æ¨¡æ¿å®ä¾‹...');

                // âœ¨ ä»æ¨¡æ¿JSONè·å–ç”»å¸ƒå°ºå¯¸é…ç½®
                let canvasWidth = 210;  // é»˜è®¤A4çº¸å®½åº¦(mm)
                let canvasHeight = 297; // é»˜è®¤A4çº¸é«˜åº¦(mm)

                if (templateJson.panels && templateJson.panels.length > 0) {
                    const panel = templateJson.panels[0];
                    if (panel.width) canvasWidth = panel.width;
                    if (panel.height) canvasHeight = panel.height;

                    console.log('ğŸ“ ç”»å¸ƒå°ºå¯¸é…ç½®:', {
                        width: canvasWidth + 'mm',
                        height: canvasHeight + 'mm',
                        paperType: panel.paperType || 'A4',
                        orientation: panel.orientation || 'portrait'
                    });
                }

                // è½¬æ¢mmåˆ°px (96 DPI: 1mm â‰ˆ 3.7795px)
                const MM_TO_PX = 3.7795275591;
                const canvasWidthPx = canvasWidth * MM_TO_PX;
                const canvasHeightPx = canvasHeight * MM_TO_PX;

                console.log('ğŸ“ ç”»å¸ƒåƒç´ å°ºå¯¸:', {
                    width: canvasWidthPx.toFixed(2) + 'px',
                    height: canvasHeightPx.toFixed(2) + 'px'
                });

                // âœ¨ å…³é”®è¯Šæ–­ï¼šæ£€æŸ¥å…ƒç´ å®é™…é«˜åº¦
                console.log('ğŸ” [è¯Šæ–­] æ¨¡æ¿é…ç½®é«˜åº¦:', canvasHeight + 'mm');

                // æ‰¾å‡ºæœ€ä½å…ƒç´ 
                if (templateJson.panels && templateJson.panels[0].printElements) {
                    let maxBottom = 0;
                    templateJson.panels[0].printElements.forEach(elem => {
                        if (elem.options) {
                            const bottom = (elem.options.top || 0) + (elem.options.height || 0);
                            maxBottom = Math.max(maxBottom, bottom);
                        }
                    });
                    const maxBottomMm = maxBottom * 0.3527;  // ptè½¬mm
                    console.log('ğŸ” [è¯Šæ–­] å†…å®¹å®é™…é«˜åº¦:', maxBottomMm.toFixed(2) + 'mm (çº¦' + maxBottom + 'pt)');
                    console.log('ğŸ” [è¯Šæ–­] å‰©ä½™ç©ºç™½:', (canvasHeight - maxBottomMm).toFixed(2) + 'mm');
                }

                // åˆ›å»ºæ¨¡æ¿å®ä¾‹
                hiprintTemplate = new hiprint.PrintTemplate({
                    template: templateJson
                });

                // å…ˆéšè—åŠ è½½åŠ¨ç”»
                $('#loadingOverlay').fadeOut(300);

                // âœ¨ é¡µé¢é¢„è§ˆç­–ç•¥ï¼šå¼ºåˆ¶è®¾ç½®ä¸ºæ¨¡æ¿è®¾è®¡çš„å®Œæ•´ç”»å¸ƒå°ºå¯¸ï¼ˆ297mmï¼‰
                // è·å–æ¸²æŸ“åçš„HTMLï¼ˆåŒ…å«çœŸå®æ•°æ®ï¼‰
                var $renderedContent = hiprintTemplate.getHtml(quoteData);

                // âœ¨ å¼ºåˆ¶è®¾ç½®ç”»å¸ƒé«˜åº¦ä¸ºæ¨¡æ¿é…ç½®çš„é«˜åº¦
                const $panel = $renderedContent.find('.hiprint-printPanel');
                if ($panel.length > 0) {
                    const originalHeight = $panel.outerHeight();
                    const originalHeightMm = originalHeight / MM_TO_PX;

                    console.log('ğŸ“„ [é¡µé¢é¢„è§ˆ] åŸå§‹ç”»å¸ƒé«˜åº¦:', originalHeight + 'px (çº¦' + originalHeightMm.toFixed(2) + 'mm)');
                    console.log('ğŸ“„ [é¡µé¢é¢„è§ˆ] æ¨¡æ¿é…ç½®é«˜åº¦:', canvasHeightPx.toFixed(2) + 'px (' + canvasHeight + 'mm)');

                    // âœ¨ æ ¸å¿ƒï¼šå¼ºåˆ¶è®¾ç½®ä¸ºæ¨¡æ¿é…ç½®çš„é«˜åº¦
                    $panel.css({
                        'height': canvasHeightPx + 'px',
                        'min-height': canvasHeightPx + 'px',
                        'max-height': canvasHeightPx + 'px'
                    });

                    console.log('âœ… [é¡µé¢é¢„è§ˆ] å·²è®¾ç½®ç”»å¸ƒé«˜åº¦ä¸ºæ¨¡æ¿è®¾è®¡å°ºå¯¸:', canvasHeight + 'mm');
                    console.log('   ï¼ˆæ‰“å°é¢„è§ˆä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸ºå®é™…å†…å®¹é«˜åº¦ï¼‰');
                }

                // å°†æ¸²æŸ“å†…å®¹æ’å…¥å®¹å™¨ï¼ˆæ˜¾ç¤ºå®Œæ•´ç”»å¸ƒï¼‰
                $('#print-container').html($renderedContent);

                // ç¦ç”¨ç¼–è¾‘åŠŸèƒ½ï¼ˆåªæ˜¾ç¤ºé¢„è§ˆï¼‰
                setTimeout(function() {
                    $('.hiprint-printElement').css({
                        'cursor': 'default',
                        'pointer-events': 'none'
                    });

                    console.log('âœ… é¡µé¢é¢„è§ˆæ¸²æŸ“å®Œæˆ - æ˜¾ç¤ºå®Œæ•´ç”»å¸ƒå°ºå¯¸ (' + canvasHeight + 'mm)');
                    console.log('   æç¤ºï¼šç‚¹å‡»"æ‰“å°"æŒ‰é’®æ—¶ï¼Œå°†è‡ªåŠ¨ä¼˜åŒ–ä¸ºå®é™…å†…å®¹é«˜åº¦ï¼ˆ1é¡µï¼‰');
                }, 200);

            } catch (error) {
                console.error('âŒ HiPrintåˆå§‹åŒ–å¤±è´¥:', error);
                $('#loadingOverlay').hide();
                showError('æ¨¡æ¿åŠ è½½å¤±è´¥: ' + error.message);
            }
        } else {
            $('#loadingOverlay').hide();
            showWarning('æ¨¡æ¿å°šæœªè®¾è®¡ï¼Œè¯·å…ˆè®¾è®¡æ¨¡æ¿');
        }
    }

    // æ‰“å°æ–‡æ¡£
    function printDoc() {
        console.log('ğŸ–¨ï¸ printDoc() è¢«è°ƒç”¨');
        console.log('   hiprintTemplate å­˜åœ¨å—?', !!hiprintTemplate);
        console.log('   quoteData å­˜åœ¨å—?', !!quoteData);

        if (!hiprintTemplate) {
            alert('æ¨¡æ¿æœªåŠ è½½ï¼Œæ— æ³•æ‰“å°');
            return;
        }
        try {
            console.log('=== å¼€å§‹æ‰“å°ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰===');

            // âœ¨âœ¨âœ¨ æ–°ç­–ç•¥ï¼šä»æ¨¡æ¿ JSON ä¸­æ‰¾åˆ°æ˜ç»†é¡¹å…ƒç´ 
            const templateJson = {{ layout_config_json|safe }};
            const elements = templateJson.panels[0].printElements || [];

            // æ‰¾å‡ºæ‰€æœ‰æ˜ç»†é¡¹å­—æ®µ
            const itemFieldElements = elements.filter(elem => {
                const field = elem.options && elem.options.field;
                return field && field.includes('items.#');
            });

            console.log('ğŸ“Š ä»æ¨¡æ¿ JSON æ‰¾åˆ°æ˜ç»†é¡¹å…ƒç´ :', itemFieldElements.length);
            itemFieldElements.forEach(elem => {
                const field = elem.options.field;
                const title = elem.printElementType && elem.printElementType.title || 'æœªçŸ¥';
                console.log(`   - ${title}: ${field}`);
            });

            // 1. æ¸…ç©ºå®¹å™¨
            $('#print-container').empty();

            // 2. ä½¿ç”¨ getHtml() æ¸²æŸ“çœŸå®æ•°æ®ï¼ˆåŸºæœ¬å­—æ®µï¼‰
            var $renderedContent = hiprintTemplate.getHtml(quoteData);

            // 3. æ‰‹åŠ¨å¤„ç†æ˜ç»†é¡¹çš„å¾ªç¯æ¸²æŸ“
            console.log('ğŸ”„ å¼€å§‹æ‰‹åŠ¨æ¸²æŸ“æ˜ç»†é¡¹:', quoteData.items.length, 'æ¡');

            if (itemFieldElements.length > 0 && quoteData.items && quoteData.items.length > 0) {
                // æŒ‰å­—æ®µåˆ†ç»„ï¼ˆé¿å…é‡å¤å…‹éš†åŒä¸€ä¸ªå…ƒç´ ï¼‰
                const fieldMap = new Map();
                itemFieldElements.forEach(elem => {
                    const field = elem.options.field;
                    const top = elem.options.top;
                    const left = elem.options.left;

                    if (!fieldMap.has(field)) {
                        fieldMap.set(field, {
                            field: field,
                            fieldName: field.replace('items.#.', ''),
                            top: top,
                            left: left,
                            elem: elem
                        });
                    }
                });

                console.log('   å»é‡åçš„å­—æ®µæ•°:', fieldMap.size);

                // æ‰¾åˆ°å¯¹åº”çš„ DOM å…ƒç´ ï¼ˆæ ¹æ®ä½ç½®åŒ¹é…ï¼‰
                const $printPanel = $renderedContent.find('.hiprint-printPanel');
                const $allElements = $printPanel.find('.hiprint-printElement');

                console.log('   é¡µé¢ä¸­çš„å…ƒç´ æ€»æ•°:', $allElements.length);

                // ä¸ºæ¯ä¸ªæ•°æ®è¡Œåˆ›å»ºå…ƒç´ 
                quoteData.items.forEach((item, rowIndex) => {
                    console.log(`   å¤„ç†ç¬¬ ${rowIndex + 1} è¡Œæ•°æ®`);

                    fieldMap.forEach((info, field) => {
                        // æ ¹æ® top å’Œ left ä½ç½®æ‰¾åˆ°å¯¹åº”çš„ DOM å…ƒç´ 
                        const targetTop = info.top + 'pt';
                        const targetLeft = info.left + 'pt';

                        let $targetElem = null;

                        // éå†æŸ¥æ‰¾åŒ¹é…ä½ç½®çš„å…ƒç´ 
                        $allElements.each(function() {
                            const $elem = $(this);
                            const elemTop = $elem.css('top');
                            const elemLeft = $elem.css('left');

                            if (elemTop === targetTop && elemLeft === targetLeft) {
                                $targetElem = $elem;
                                return false; // è·³å‡ºå¾ªç¯
                            }
                        });

                        if ($targetElem) {
                            if (rowIndex === 0) {
                                // ç¬¬ä¸€è¡Œï¼šç›´æ¥æ›´æ–°å†…å®¹
                                const value = item[info.fieldName] || '';
                                $targetElem.find('.hiprint-printElement-text-content').text(value);
                                console.log(`     æ›´æ–°å­—æ®µ ${info.fieldName}: ${value}`);
                            } else {
                                // åç»­è¡Œï¼šå…‹éš†å…ƒç´ 
                                const $clone = $targetElem.clone();
                                const lineHeight = 20; // è¡Œé«˜ 20pt
                                const newTop = info.top + (lineHeight * rowIndex);
                                $clone.css('top', newTop + 'pt');

                                // æ›´æ–°å†…å®¹
                                const value = item[info.fieldName] || '';
                                $clone.find('.hiprint-printElement-text-content').text(value);

                                // æ’å…¥åˆ°é¡µé¢
                                $targetElem.parent().append($clone);
                                console.log(`     å…‹éš†å­—æ®µ ${info.fieldName}: ${value} (top: ${newTop}pt)`);
                            }
                        } else {
                            console.warn(`     æœªæ‰¾åˆ°ä½ç½®åŒ¹é…çš„å…ƒç´ : top=${targetTop}, left=${targetLeft}`);
                        }
                    });
                });
            }

            // 4. å°†æ¸²æŸ“åçš„å†…å®¹æ’å…¥å®¹å™¨
            $('#print-container').html($renderedContent);

            // âœ¨ å…³é”®ä¿®å¤ï¼šè°ƒæ•´ç”»å¸ƒé«˜åº¦ä¸ºå®é™…å†…å®¹é«˜åº¦
            setTimeout(function() {
                const $panel = $('.hiprint-printPanel');
                if ($panel.length > 0) {
                    // åŠ¨æ€è®¡ç®—å®é™…å†…å®¹é«˜åº¦
                    let maxBottom = 0;
                    $panel.find('.hiprint-printElement').each(function() {
                        const $elem = $(this);
                        const top = parseFloat($elem.css('top')) || 0;
                        const height = $elem.outerHeight() || 0;
                        const bottom = top + height;
                        maxBottom = Math.max(maxBottom, bottom);
                    });

                    const MM_TO_PX = 3.7795275591;
                    const contentHeightPx = maxBottom + 40; // åŠ 40pxåº•éƒ¨é—´è·
                    const contentHeightMm = contentHeightPx / MM_TO_PX;
                    const originalHeightMm = $panel.outerHeight() / MM_TO_PX;

                    console.log('ğŸ” [æ‰“å°å‰è°ƒæ•´] ç”»å¸ƒåŸå§‹é«˜åº¦:', originalHeightMm.toFixed(2) + 'mm');
                    console.log('ğŸ” [æ‰“å°å‰è°ƒæ•´] å†…å®¹å®é™…é«˜åº¦:', contentHeightMm.toFixed(2) + 'mm');
                    console.log('ğŸ” [æ‰“å°å‰è°ƒæ•´] ç”»å¸ƒåŸå§‹æ ·å¼:', $panel.attr('style'));

                    // âœ¨ æ ¸å¿ƒä¿®å¤ï¼šç§»é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é«˜åº¦å›ºå®šçš„æ ·å¼
                    // 1. ç§»é™¤å†…è”æ ·å¼ä¸­çš„ height
                    let inlineStyle = $panel.attr('style') || '';
                    inlineStyle = inlineStyle
                        .replace(/height:\s*[^;]+;?/gi, '')
                        .replace(/min-height:\s*[^;]+;?/gi, '')
                        .replace(/max-height:\s*[^;]+;?/gi, '');

                    // 2. æ·»åŠ æ–°çš„é«˜åº¦æ ·å¼
                    inlineStyle += `height: ${contentHeightPx}px !important;`;

                    $panel.attr('style', inlineStyle);

                    // 3. é€šè¿‡ CSS å†æ¬¡å¼ºåˆ¶
                    $panel.css({
                        'height': contentHeightPx + 'px',
                        'min-height': contentHeightPx + 'px',
                        'max-height': contentHeightPx + 'px'
                    });

                    console.log('âœ… [æ‰“å°å‰è°ƒæ•´] å·²ä¼˜åŒ–ç”»å¸ƒé«˜åº¦:', originalHeightMm.toFixed(2) + 'mm â†’ ' + contentHeightMm.toFixed(2) + 'mm');
                    console.log('   èŠ‚çœç©ºé—´:', (originalHeightMm - contentHeightMm).toFixed(2) + 'mm');
                    console.log('ğŸ” [æ‰“å°å‰è°ƒæ•´] ç”»å¸ƒæ–°æ ·å¼:', $panel.attr('style'));
                }
            }, 100);

            console.log('âœ… çœŸå®æ•°æ®æ¸²æŸ“å®Œæˆ');

            // 5. å»¶è¿Ÿè§¦å‘æ‰“å°ï¼ˆç¡®ä¿é«˜åº¦è°ƒæ•´å®Œæˆï¼‰
            setTimeout(function() {
                console.log('ğŸ–¨ï¸ è§¦å‘æ‰“å°å¯¹è¯æ¡†');
                window.print();
            }, 300);

        } catch (error) {
            console.error('âŒ æ‰“å°å¤±è´¥:', error);
            console.error('   é”™è¯¯è¯¦æƒ…:', error.stack);
            alert('æ‰“å°å¤±è´¥: ' + error.message);
        }
    }

    // å¯¼å‡ºPDF
    function exportPDF() {
        console.log('ğŸ“„ exportPDF() è¢«è°ƒç”¨');
        console.log('   hiprintTemplate å­˜åœ¨å—?', !!hiprintTemplate);
        console.log('   quoteData å­˜åœ¨å—?', !!quoteData);

        if (!hiprintTemplate) {
            alert('æ¨¡æ¿æœªåŠ è½½ï¼Œæ— æ³•å¯¼å‡º');
            return;
        }
        try {
            console.log('=== å¼€å§‹å¯¼å‡º PDFï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰===');

            // âœ¨âœ¨âœ¨ å…³é”®ä¿®å¤ï¼šæ‰‹åŠ¨å®ç°æ˜ç»†é¡¹å¾ªç¯æ¸²æŸ“åå†å¯¼å‡º PDF
            // 1. è·å–æ¸²æŸ“åçš„ HTMLï¼ˆåŒ…å«çœŸå®æ•°æ®å’Œæ˜ç»†é¡¹ï¼‰
            var $renderedContent = hiprintTemplate.getHtml(quoteData);

            // 2. æ‰‹åŠ¨å¤„ç†æ˜ç»†é¡¹çš„å¾ªç¯æ¸²æŸ“ï¼ˆä¸ printDoc ç›¸åŒçš„é€»è¾‘ï¼‰
            console.log('ğŸ”„ æ‰‹åŠ¨æ¸²æŸ“æ˜ç»†é¡¹:', quoteData.items.length, 'æ¡');

            var $itemElements = $renderedContent.find('[data-field*="items.#"]');
            console.log('   æ‰¾åˆ°æ˜ç»†é¡¹å…ƒç´ :', $itemElements.length);

            if ($itemElements.length > 0 && quoteData.items && quoteData.items.length > 0) {
                var $firstItem = $itemElements.first().closest('.hiprint-printElement');

                quoteData.items.forEach(function(item, index) {
                    if (index === 0) {
                        $itemElements.each(function() {
                            var $elem = $(this);
                            var field = $elem.attr('data-field') || '';
                            var fieldName = field.replace('items.#.', '');

                            if (item[fieldName] !== undefined) {
                                $elem.find('.hiprint-printElement-text-content').text(item[fieldName]);
                            }
                        });
                    } else {
                        $itemElements.each(function() {
                            var $elem = $(this).closest('.hiprint-printElement');
                            var $clone = $elem.clone();

                            var currentTop = parseFloat($elem.css('top') || 0);
                            var lineHeight = 20;
                            $clone.css('top', (currentTop + lineHeight * index) + 'pt');

                            var field = $elem.find('[data-field]').attr('data-field') || '';
                            var fieldName = field.replace('items.#.', '');

                            if (item[fieldName] !== undefined) {
                                $clone.find('.hiprint-printElement-text-content').text(item[fieldName]);
                            }

                            $elem.parent().append($clone);
                        });
                    }
                });
            }

            console.log('âœ… çœŸå®æ•°æ®æ¸²æŸ“å®Œæˆï¼Œå¼€å§‹ç”Ÿæˆ PDF');

            // 3. ä½¿ç”¨ html2canvas + jsPDF å¯¼å‡ºï¼ˆHiPrint å†…éƒ¨ä½¿ç”¨çš„æ–¹æ³•ï¼‰
            const filename = `{{ quote.quote_number }}_{{ quote.customer.name }}.pdf`;

            // ä¸´æ—¶å°†æ¸²æŸ“å†…å®¹æ˜¾ç¤ºåœ¨éšè—å®¹å™¨ä¸­
            var $tempContainer = $('<div id="temp-pdf-container"></div>').appendTo('body').hide();
            $tempContainer.html($renderedContent);

            // ä½¿ç”¨ html2canvas æˆªå›¾å¹¶ç”Ÿæˆ PDF
            html2canvas($tempContainer[0], {
                scale: 2,
                useCORS: true,
                logging: false,
                windowWidth: 794,  // A4å®½åº¦ (210mm * 3.7795px/mm)
                windowHeight: 1123 // A4é«˜åº¦ (297mm * 3.7795px/mm)
            }).then(function(canvas) {
                var imgData = canvas.toDataURL('image/png');
                var pdf = new jspdf.jsPDF('p', 'mm', 'a4');

                // A4çº¸å°ºå¯¸ (mm)
                var pdfWidth = 210;
                var pdfHeight = 297;

                // è®¡ç®—å›¾ç‰‡å°ºå¯¸
                var imgWidth = pdfWidth;
                var imgHeight = canvas.height * imgWidth / canvas.width;

                // âœ¨ å…³é”®ä¿®å¤ï¼šå¦‚æœé«˜åº¦è¶…è¿‡ä¸€é¡µ,ç­‰æ¯”ä¾‹ç¼©å°ä»¥é€‚åº”å•é¡µ
                if (imgHeight > pdfHeight) {
                    console.warn('âš ï¸ å†…å®¹é«˜åº¦è¶…å‡ºä¸€é¡µ,è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”');
                    imgHeight = pdfHeight;
                    imgWidth = canvas.width * imgHeight / canvas.height;

                    // å±…ä¸­æ˜¾ç¤º
                    var xOffset = (pdfWidth - imgWidth) / 2;
                    pdf.addImage(imgData, 'PNG', xOffset, 0, imgWidth, imgHeight);
                } else {
                    // å†…å®¹æœªè¶…å‡º,æ­£å¸¸æ˜¾ç¤º
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                }

                pdf.save(filename);

                // æ¸…ç†ä¸´æ—¶å®¹å™¨
                $tempContainer.remove();

                console.log('âœ… PDF å¯¼å‡ºå®Œæˆ:', filename);
            }).catch(function(error) {
                console.error('âŒ PDF ç”Ÿæˆå¤±è´¥:', error);
                $tempContainer.remove();
                alert('PDF ç”Ÿæˆå¤±è´¥: ' + error.message);
            });

        } catch (error) {
            console.error('âŒ å¯¼å‡ºPDFå¤±è´¥:', error);
            console.error('   é”™è¯¯è¯¦æƒ…:', error.stack);
            alert('å¯¼å‡ºPDFå¤±è´¥: ' + error.message);
        }
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
        var container = document.getElementById('print-container');
        if (!container) return;

        container.innerHTML = `
            <div class="error-container">
                <svg class="icon error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
</svg>
                <h3 style="margin-bottom: 10px; color: #111827;">æ¨¡æ¿åŠ è½½å¤±è´¥</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">${message}</p>
                <p style="color: #9ca3af; font-size: 14px; margin-bottom: 20px;">
                    å¯èƒ½çš„åŸå› ï¼š<br>
                    1. HiPrint æ‰“å°ç»„ä»¶åº“æ–‡ä»¶åŠ è½½å¤±è´¥<br>
                    2. ç½‘ç»œè¿æ¥é—®é¢˜<br>
                    3. é™æ€æ–‡ä»¶é…ç½®é”™è¯¯<br><br>
                    è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
                </p>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
</svg> é‡æ–°åŠ è½½
                </button>
                <a href="/sales/templates/" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block;">
                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
</svg> æ¨¡æ¿ç®¡ç†
                </a>
            </div>
        `;
    }

    // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
    function showWarning(message) {
        var container = document.getElementById('print-container');
        if (!container) return;

        container.innerHTML = `
            <div class="error-container">
                <svg info-icon fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                <h3 style="margin-bottom: 10px; color: #111827;">æ¨¡æ¿å°šæœªè®¾è®¡</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">${message}</p>
                <a href="/sales/templates/" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block;">
                    <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg> æ¨¡æ¿ç®¡ç†
                </a>
            </div>
        `;
    }

    // ============================================
    // âœ¨ æ¨¡æ¿é€‰æ‹©å™¨åŠŸèƒ½
    // ============================================

    // å½“å‰å•æ®ä¿¡æ¯ï¼ˆä»Djangoæ¨¡æ¿ä¼ é€’ï¼‰
    const documentType = 'quote';  // å•æ®ç±»å‹
    const quoteType = '{{ quote.quote_type }}';  // æŠ¥ä»·å•ç±»å‹ï¼ˆDOMESTIC/OVERSEASï¼‰
    const quoteId = {{ quote.id }};  // æŠ¥ä»·å•ID
    const documentTypeFull = quoteType.toUpperCase() === 'DOMESTIC' ? 'quote_domestic' : 'quote_overseas';

    // é¡µé¢åŠ è½½æ—¶è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨
    window.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”„ åŠ è½½å¯ç”¨æ¨¡æ¿åˆ—è¡¨...');
        loadAvailableTemplates();
    });

    // è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨
    function loadAvailableTemplates() {
        $.ajax({
            url: '/sales/api/templates/available/',
            method: 'GET',
            data: {
                document_type: documentType,
                quote_type: quoteType
            },
            success: function(response) {
                if (response.success) {
                    console.log('âœ… å·²åŠ è½½', response.templates.length, 'ä¸ªå¯ç”¨æ¨¡æ¿');

                    // æ›´æ–°ä¸‹æ‹‰é€‰æ‹©å™¨
                    const $selector = $('#template-selector');
                    $selector.empty();

                    response.templates.forEach(function(template) {
                        const isDefault = template.is_default ? ' â­' : '';
                        const option = $('<option>')
                            .val(template.id)
                            .text(template.name + isDefault)
                            .data('is-default', template.is_default);

                        $selector.append(option);
                    });

                    // è®¾ç½®å½“å‰é€‰ä¸­çš„æ¨¡æ¿
                    const currentTemplateId = {{ template.id }};
                    $selector.val(currentTemplateId);

                    // æ›´æ–°"è®¾ä¸ºé»˜è®¤"æŒ‰é’®çŠ¶æ€
                    updateDefaultButtonState($selector.find(':selected').data('is-default'));
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
            }
        });
    }

    // æ¨¡æ¿é€‰æ‹©æ”¹å˜æ—¶é‡æ–°åŠ è½½é¡µé¢
    $('#template-selector').on('change', function() {
        const selectedTemplateId = $(this).val();
        const isDefault = $(this).find(':selected').data('is-default');

        console.log('ğŸ”„ åˆ‡æ¢åˆ°æ¨¡æ¿:', selectedTemplateId);

        // æ›´æ–°"è®¾ä¸ºé»˜è®¤"æŒ‰é’®çŠ¶æ€
        updateDefaultButtonState(isDefault);

        // é‡æ–°åŠ è½½é¡µé¢ï¼Œä½¿ç”¨æ–°çš„æ¨¡æ¿ID
        const newUrl = window.location.pathname + '?template_id=' + selectedTemplateId;
        window.location.href = newUrl;
    });

    // è®¾ä¸ºé»˜è®¤æ¨¡æ¿
    function setAsDefaultTemplate() {
        const selectedTemplateId = $('#template-selector').val();
        const selectedTemplateName = $('#template-selector option:selected').text().replace(' â­', '');

        console.log('â­ è®¾ç½®é»˜è®¤æ¨¡æ¿:', selectedTemplateId, selectedTemplateName);

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        if (!confirm(`ç¡®å®šè¦å°†"${selectedTemplateName}"è®¾ä¸ºé»˜è®¤æ‰“å°æ¨¡æ¿å—ï¼Ÿ`)) {
            return;
        }

        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: '/sales/api/templates/set-default/',
            method: 'POST',
            data: {
                template_id: selectedTemplateId,
                document_type: documentTypeFull,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    console.log('âœ… å·²è®¾ä¸ºé»˜è®¤æ¨¡æ¿');
                    alert('âœ… ' + response.message);

                    // é‡æ–°åŠ è½½æ¨¡æ¿åˆ—è¡¨ï¼ˆæ›´æ–°æ˜Ÿæ ‡ï¼‰
                    loadAvailableTemplates();
                } else {
                    alert('âŒ è®¾ç½®å¤±è´¥: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ è®¾ç½®é»˜è®¤æ¨¡æ¿å¤±è´¥:', error);
                alert('âŒ è®¾ç½®å¤±è´¥: ' + error);
            }
        });
    }

    // æ›´æ–°"è®¾ä¸ºé»˜è®¤"æŒ‰é’®çŠ¶æ€
    function updateDefaultButtonState(isDefault) {
        const $btn = $('.btn-set-default');

        if (isDefault) {
            $btn.addClass('is-default');
            $btn.attr('title', 'å½“å‰ä¸ºé»˜è®¤æ¨¡æ¿');
        } else {
            $btn.removeClass('is-default');
            $btn.attr('title', 'è®¾ä¸ºé»˜è®¤æ¨¡æ¿');
        }
    }
    </script>
</body>
</html>
