{% extends 'layouts/base.html' %}
{% block title %}{% if action == 'create' %}新建打印模板{% else %}编辑打印模板{% endif %} - BetterLaser ERP{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto" x-data="templateEditor()">
    <form method="post" @submit.prevent="submitForm">
        {% csrf_token %}
        <input type="hidden" name="layout_config" x-model="layoutConfigJSON">

        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建打印模板{% else %}编辑打印模板{% endif %}</h3>
            <div class="flex space-x-3">
                <a href="{% url 'core:print_template_list' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>取消
                </a>
                <button type="button" @click="showPreview = true" class="px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
</svg>预览
                </button>
                <button type="submit" class="px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存
                </button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Left Panel: Basic Info -->
            <div class="col-span-1 space-y-6">
                <!-- 基本信息 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">模板名称 *</label>
                            <input type="text" name="name" value="{{ template.name|default:'' }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">模板类型 *</label>
                            <select name="template_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" {% if action == 'edit' %}disabled{% endif %}>
                                <option value="">请选择类型</option>
                                {% for value, label in template_types %}
                                <option value="{{ value }}" {% if template.template_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            {% if action == 'edit' %}
                            <input type="hidden" name="template_type" value="{{ template.template_type }}">
                            {% endif %}
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="is_default" id="is_default" {% if template.is_default %}checked{% endif %} class="h-4 w-4 text-theme-600 rounded">
                            <label for="is_default" class="ml-2 text-sm text-gray-700">设为默认模板</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="is_active" id="is_active" {% if template.is_active or action == 'create' %}checked{% endif %} class="h-4 w-4 text-theme-600 rounded">
                            <label for="is_active" class="ml-2 text-sm text-gray-700">启用模板</label>
                        </div>
                    </div>
                </div>

                <!-- 公司信息 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">公司信息</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">公司名称</label>
                            <input type="text" name="company_name" value="{{ template.company_name|default:'BetterLaser 激光科技有限公司' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">公司地址</label>
                            <input type="text" name="company_address" value="{{ template.company_address|default:'' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                            <input type="text" name="company_phone" value="{{ template.company_phone|default:'' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">电子邮箱</label>
                            <input type="email" name="company_email" value="{{ template.company_email|default:'' }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <!-- 自定义样式 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">自定义样式</h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CSS 代码</label>
                        <textarea name="custom_css" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-xs" placeholder="/* 自定义CSS样式 */">{{ template.custom_css|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Layout Configuration -->
            <div class="col-span-2 bg-white rounded-lg shadow p-6">
                <h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">布局配置</h4>

                <div class="space-y-3">
                    <template x-for="(section, sIndex) in sections" :key="sIndex">
                        <div class="border border-gray-200 rounded-lg">
                            <!-- Section Header -->
                            <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox"
                                           x-model="section.visible"
                                           class="h-4 w-4 text-theme-600 rounded">
                                    <span class="font-medium text-gray-900" x-text="section.name"></span>
                                    <span class="text-xs text-gray-500" x-text="'(' + section.fields.length + ' 个字段)'"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button type="button" @click="moveSectionUp(sIndex)" :disabled="sIndex === 0"
                                            class="p-1 text-gray-600 hover:text-gray-900 disabled:opacity-30">
                                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
</svg>
                                    </button>
                                    <button type="button" @click="moveSectionDown(sIndex)" :disabled="sIndex === sections.length - 1"
                                            class="p-1 text-gray-600 hover:text-gray-900 disabled:opacity-30">
                                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
</svg>
                                    </button>
                                    <button type="button" @click="section.expanded = !section.expanded" class="p-1 text-gray-600 hover:text-gray-900">
                                        <svg class="w-5 h-5 transition-transform duration-200" :class="{ 'rotate-180': section.expanded }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Section Fields -->
                            <div x-show="section.expanded" class="p-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <template x-for="(field, fIndex) in section.fields" :key="fIndex">
                                        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                                            <input type="checkbox"
                                                   x-model="field.visible"
                                                   class="h-4 w-4 text-theme-600 rounded">
                                            <span class="text-sm text-gray-700" x-text="field.label"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- 备注 -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">备注</h4>
            <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="模板说明或备注信息...">{{ template.notes|default:'' }}</textarea>
        </div>
    </form>

    <!-- Preview Modal -->
    <div x-show="showPreview"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showPreview = false"></div>
            <div class="relative bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">模板预览</h3>
                    <button type="button" @click="showPreview = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>
                    </button>
                </div>
                <div class="p-6">
                    <div class="text-sm text-gray-600 mb-4">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                        这是根据当前配置生成的模板预览，实际打印时会显示真实数据。
                    </div>
                    <div class="border border-gray-300 rounded p-4 bg-white" style="font-size: 12px;">
                        <div x-html="generatePreview()"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function templateEditor() {
    return {
        sections: {% if layout_config_json %}{{ layout_config_json|safe }}.sections{% else %}[]{% endif %},
        showPreview: false,
        layoutConfigJSON: '',

        init() {
            // Ensure all sections have expanded property
            this.sections.forEach(section => {
                if (section.expanded === undefined) {
                    section.expanded = false;
                }
            });

            // Initialize with default layout if empty
            if (this.sections.length === 0) {
                this.sections = this.getDefaultLayout();
            }

            this.updateLayoutJSON();
        },

        getDefaultLayout() {
            return [
                {
                    id: "header",
                    name: "页眉",
                    visible: true,
                    order: 1,
                    expanded: true,
                    fields: [
                        {id: "company_name", label: "公司名称", visible: true},
                        {id: "company_info", label: "公司信息", visible: true},
                    ]
                },
                {
                    id: "quote_info",
                    name: "报价单信息",
                    visible: true,
                    order: 2,
                    expanded: false,
                    fields: [
                        {id: "quote_number", label: "报价单号", visible: true},
                        {id: "quote_date", label: "报价日期", visible: true},
                        {id: "valid_until", label: "有效期至", visible: true},
                        {id: "sales_rep", label: "销售代表", visible: true},
                    ]
                },
                {
                    id: "customer_info",
                    name: "客户信息",
                    visible: true,
                    order: 3,
                    expanded: false,
                    fields: [
                        {id: "customer_name", label: "客户名称", visible: true},
                        {id: "customer_phone", label: "联系电话", visible: true},
                        {id: "contact_person", label: "联系人", visible: true},
                    ]
                },
                {
                    id: "items",
                    name: "产品明细",
                    visible: true,
                    order: 4,
                    expanded: false,
                    fields: [
                        {id: "product_name", label: "产品名称", visible: true},
                        {id: "quantity", label: "数量", visible: true},
                        {id: "unit_price", label: "单价", visible: true},
                        {id: "subtotal", label: "小计", visible: true},
                    ]
                },
                {
                    id: "summary",
                    name: "金额汇总",
                    visible: true,
                    order: 5,
                    expanded: false,
                    fields: [
                        {id: "subtotal", label: "含税小计", visible: true},
                        {id: "discount_amount", label: "折扣金额", visible: true},
                        {id: "tax_amount", label: "税额", visible: true},
                        {id: "total_amount", label: "含税总计", visible: true},
                    ]
                },
            ];
        },

        moveSectionUp(index) {
            if (index > 0) {
                [this.sections[index], this.sections[index - 1]] = [this.sections[index - 1], this.sections[index]];
                this.updateLayoutJSON();
            }
        },

        moveSectionDown(index) {
            if (index < this.sections.length - 1) {
                [this.sections[index], this.sections[index + 1]] = [this.sections[index + 1], this.sections[index]];
                this.updateLayoutJSON();
            }
        },

        updateLayoutJSON() {
            const config = {
                sections: this.sections,
                page_settings: {
                    size: "A4",
                    orientation: "portrait",
                    margin: {"top": "1cm", "right": "1cm", "bottom": "1cm", "left": "1cm"}
                }
            };
            this.layoutConfigJSON = JSON.stringify(config);
        },

        generatePreview() {
            let html = '<div style="font-family: Microsoft YaHei, Arial, sans-serif;">';

            this.sections.forEach(section => {
                if (!section.visible) return;

                html += `<div style="margin-bottom: 20px; border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px;">`;
                html += `<h4 style="margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 2px solid #666; font-size: 14px;">${section.name}</h4>`;

                if (section.id === 'items') {
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 11px;">';
                    html += '<thead><tr style="background: #f3f4f6;">';
                    section.fields.forEach(field => {
                        if (field.visible) {
                            html += `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${field.label}</th>`;
                        }
                    });
                    html += '</tr></thead>';
                    html += '<tbody><tr>';
                    section.fields.forEach(field => {
                        if (field.visible) {
                            html += `<td style="padding: 8px; border: 1px solid #ddd;">示例数据</td>`;
                        }
                    });
                    html += '</tr></tbody></table>';
                } else {
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">';
                    section.fields.forEach(field => {
                        if (field.visible) {
                            html += `<div style="display: flex;"><span style="font-weight: 500; min-width: 100px; color: #6b7280;">${field.label}：</span><span>示例数据</span></div>`;
                        }
                    });
                    html += '</div>';
                }

                html += '</div>';
            });

            html += '</div>';
            return html;
        },

        submitForm(e) {
            this.updateLayoutJSON();
            e.target.submit();
        }
    }
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}
