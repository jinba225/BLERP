{% extends 'layouts/base.html' %}

{% block title %}{% if is_edit %}编辑{% else %}新建{% endif %}借用单 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">销售管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'sales:loan_list' %}" class="text-gray-500 hover:text-gray-700">销售借用</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{% if is_edit %}编辑{% else %}新建{% endif %}</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">
            {% if is_edit %}编辑借用单{% else %}新建借用单{% endif %}
        </h3> <form method="post" id="loanForm" class="space-y-6">
            {% csrf_token %} <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="customer" class="block text-sm font-medium text-gray-700 mb-2">
                        客户 <span class="text-red-500">*</span>
                    </label>
                    <select id="customer" name="customer" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        <option value="">请选择客户</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}"
                                {% if is_edit and loan.customer.id == customer.id %}selected{% endif %}>
                            {{ customer.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div> <div>
                    <label for="salesperson" class="block text-sm font-medium text-gray-700 mb-2">销售员</label>
                    <select id="salesperson" name="salesperson"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                        <option value="">当前用户</option>
                        {% for person in salespersons %}
                        <option value="{{ person.id }}"
                                {% if is_edit and loan.salesperson.id == person.id %}selected{% endif %}>
                            {{ person.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div> <div>
                    <label for="loan_date" class="block text-sm font-medium text-gray-700 mb-2">
                        借出日期 <span class="text-red-500">*</span>
                    </label>
                    <input type="date" id="loan_date" name="loan_date" required
                           value="{% if is_edit %}{{ loan.loan_date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div> <div>
                    <label for="expected_return_date" class="block text-sm font-medium text-gray-700 mb-2">预计归还日期</label>
                    <input type="date" id="expected_return_date" name="expected_return_date"
                           value="{% if is_edit and loan.expected_return_date %}{{ loan.expected_return_date|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div>
            </div> <div>
                <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">借用目的</label>
                <textarea id="purpose" name="purpose" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500"
                          placeholder="样品试用、展会展示、客户测试等...">{% if is_edit %}{{ loan.purpose }}{% endif %}</textarea>
            </div> <div>
                <label for="delivery_address" class="block text-sm font-medium text-gray-700 mb-2">借出地址</label>
                <textarea id="delivery_address" name="delivery_address" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">{% if is_edit %}{{ loan.delivery_address }}{% endif %}</textarea>
            </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="contact_person" class="block text-sm font-medium text-gray-700 mb-2">联系人</label>
                    <input type="text" id="contact_person" name="contact_person"
                           value="{% if is_edit %}{{ loan.contact_person }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div> <div>
                    <label for="contact_phone" class="block text-sm font-medium text-gray-700 mb-2">联系电话</label>
                    <input type="tel" id="contact_phone" name="contact_phone"
                           value="{% if is_edit %}{{ loan.contact_phone }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
                </div>
            </div> <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                <textarea id="notes" name="notes" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">{% if is_edit %}{{ loan.notes }}{% endif %}</textarea>
            </div> <!-- Items Section (Placeholder) -->
            <div class="border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-md font-semibold text-gray-900">借用明细</h4>
                    <button class="btn btn-primary" type="button" onclick="alert('请使用 JavaScript 动态添加明细行')">
                        <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
</svg>添加产品
                    </button>
                </div>
                <p class="text-sm text-gray-600 bg-yellow-50 border border-yellow-200 rounded p-3">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                    <strong>提示：</strong>此表单需要添加 JavaScript 动态明细行功能。请参考 quote_form.html 或 return_form.html 实现。
                    明细数据应以 JSON 格式存储到隐藏字段 items_json 中。
                </p>
                <input type="hidden" name="items_json" id="items_json" value="[]">
            </div> <!-- Submit Buttons -->
            <div class="flex justify-end gap-3 pt-6 border-t">
                <a href="{% if is_edit %}{% url 'sales:loan_detail' loan.pk %}{% else %}{% url 'sales:loan_list' %}{% endif %}"
                   class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    取消
                </a>
                <button class="btn btn-primary" type="submit">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// TODO: 实现动态明细行功能
// 1. 添加产品选择下拉框
// 2. 添加数量输入
// 3. 添加批次号、序列号等字段
// 4. 删除明细行功能
// 5. 将明细数据转换为JSON并存储到 items_json 字段
// 参考: /templates/sales/quote_form.html 的实现
console.log('Loan form loaded. Dynamic items feature needs to be implemented.');
</script>
{% endblock %}
