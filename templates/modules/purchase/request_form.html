{% extends 'layouts/base.html' %}
{% block title %}{% if action == 'create' %}新建{% else %}编辑{% endif %}采购申请 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">采购管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:request_list' %}" class="text-gray-500 hover:text-gray-700">采购申请</a>
{% if action == 'update' %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:request_detail' request.pk %}" class="text-gray-500 hover:text-gray-700">{{ request.request_number }}</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">编辑申请</span>
{% else %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">新建申请</span>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="requestForm()">
<form method="post" @submit="prepareSubmit">
{% csrf_token %}
<input type="hidden" name="items_json" x-model="itemsJSON">

<div class="mb-6">
<h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建采购申请{% else %}编辑采购申请{% endif %}</h3>
</div>

<!-- 基本信息 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">申请人</label>
<input type="text" value="{{ user.get_full_name|default:user.username }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">申请日期 <span class="text-red-500">*</span></label>
<input type="date" name="request_date" value="{% if request %}{{ request.request_date|date:'Y-m-d' }}{% endif %}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">需求日期</label>
<input type="date" name="required_date" value="{% if request and request.required_date %}{{ request.required_date|date:'Y-m-d' }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
<select name="priority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="normal" {% if not request or request.priority == 'normal' %}selected{% endif %}>普通</option>
<option value="urgent" {% if request and request.priority == 'urgent' %}selected{% endif %}>紧急</option>
</select>
</div>
</div>
<div class="mt-4">
<label class="block text-sm font-medium text-gray-700 mb-2">申请理由</label>
<textarea name="justification" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">{% if request %}{{ request.justification }}{% endif %}</textarea>
</div>
</div>

<!-- 申请明细 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h4 class="text-md font-semibold text-gray-900">申请明细</h4>
<button type="button" @click="addItem" class="btn btn-primary text-sm px-3 py-1.5"><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
</svg>添加产品</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full">
<thead class="bg-gray-50">
<tr>
<th class="w-12 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">产品 *</th>
<th class="w-32 px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">申请数量 *</th>
<th class="w-44 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">首选供应商</th>
<th class="w-40 px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">规格要求</th>
<th class="w-20 px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
</tr>
</thead>
<tbody>
<template x-for="(item, index) in items" :key="index">
<tr class="border-t">
<td class="px-3 py-2 text-sm text-gray-500" x-text="index + 1"></td>
<td class="px-3 py-2">
<div class="relative" x-data="{
    isOpen: false,
    searchValue: '',
    dropdownStyle: '',
    get filteredProducts() {
        if (!this.searchValue || !this.searchValue.trim()) {
            return window.productsData || [];
        }
        const query = this.searchValue.toLowerCase().trim();
        return (window.productsData || []).filter(product =>
            product.name.toLowerCase().includes(query) ||
            (product.code && product.code.toLowerCase().includes(query))
        );
    },
    selectProduct(product) {
        item.product_id = product.id;
        this.searchValue = product.name + ' (' + product.code + ')';
        this.isOpen = false;
    },
    selectFirstProduct() {
        if (this.filteredProducts.length > 0) {
            this.selectProduct(this.filteredProducts[0]);
        }
    },
    updateDropdownPosition() {
        if (!this.$el) return;
        const input = this.$el.querySelector('input');
        const rect = input.getBoundingClientRect();
        const width = input.offsetWidth;
        this.dropdownStyle = `position: fixed; top: ${rect.bottom + 4}px; left: ${rect.left}px; width: ${width}px; z-index: 9999;`;
    },
    init() {
        if (item.product_id) {
            const product = (window.productsData || []).find(p => p.id === parseInt(item.product_id));
            if (product) {
                this.searchValue = product.name + ' (' + product.code + ')';
            }
        }
    }
}" x-init="$watch('isOpen', value => { if (value) { $nextTick(() => updateDropdownPosition()); } })">
<!-- 搜索输入框 -->
<div class="relative">
<input
    x-ref="searchInput"
    type="text"
    x-model="searchValue"
    @input="isOpen = true"
    @keydown.enter="selectFirstProduct()"
    @keydown.escape="isOpen = false"
    @focus="isOpen = true; $nextTick(() => updateDropdownPosition())"
    @blur="setTimeout(() => isOpen = false, 150)"
    placeholder="搜索或选择产品"
    class="w-full px-3 py-2 border border-gray-300 rounded-lg pr-10 focus:outline-none focus:border-theme-500 outline-none transition-all text-sm"
>
<!-- 下拉箭头 -->
<button
    type="button"
    @click="isOpen = !isOpen"
    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
>
    <svg x-show="!isOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
    <svg x-show="isOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
    </svg>
</button>
</div>

<!-- 下拉选项面板 -->
<div
    x-show="isOpen && filteredProducts.length > 0"
    x-transition:enter="transition ease-out duration-100"
    x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100"
    x-transition:leave="transition ease-in duration-75"
    x-transition:leave-start="opacity-100 scale-100"
    x-transition:leave-end="opacity-0 scale-95"
    class="max-h-60 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200"
    :style="dropdownStyle"
    style="display: none;"
>
    <template x-for="product in filteredProducts" :key="product.id">
        <div
            @click="selectProduct(product)"
            class="px-4 py-2 hover:bg-theme-50 cursor-pointer transition-colors text-gray-800"
            :class="{ 'bg-theme-100 font-medium': item.product_id && item.product_id === product.id }"
            x-text="product.name + ' (' + product.code + ')'"
        >
        </div>
    </template>
</div>

<!-- 无匹配结果提示 -->
<div
    x-show="isOpen && filteredProducts.length === 0"
    class="bg-white rounded-lg shadow-lg border border-gray-200 px-4 py-3 text-gray-500"
    :style="dropdownStyle"
    style="display: none;"
>
    未找到匹配的产品
</div>
</div>
</td>
<td class="px-3 py-2">
<input type="number" x-model="item.quantity" step="1" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors" required>
</td>
<td class="px-3 py-2">
<select x-model="item.preferred_supplier_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="">未指定</option>
{% for supplier in suppliers %}
<option value="{{ supplier.id }}">{{ supplier.name }}</option>
{% endfor %}
</select>
</td>
<td class="px-3 py-2">
<input type="text" x-model="item.specifications" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500 transition-colors" placeholder="规格说明">
</td>
<td class="px-3 py-2 text-center">
<button type="button" @click="removeItem(index)" class="text-red-600 hover:text-red-800"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg></button>
</td>
</tr>
</template>
<template x-if="items.length === 0">
<tr><td colspan="6" class="px-3 py-8 text-center text-gray-500 text-sm">暂无明细,请点击"添加产品"按钮添加申请项目</td></tr>
</template>
</tbody>
</table>
</div>
</div>

<!-- 操作按钮 -->
<div class="flex justify-end space-x-3 pt-4 border-t">
<a href="{% if action == 'update' %}{% url 'purchase:request_detail' request.pk %}{% else %}{% url 'purchase:request_list' %}{% endif %}" class="btn btn-outline">
<svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>取消
</a>
<button type="submit" class="btn btn-primary">
<svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存申请单
</button>
</div>
</form>
</div>

<script>
// 初始化数据
window.productsData = {{ products|safe }};

function requestForm() {
    // 设置默认日期为当天
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const requestDateInput = document.querySelector('input[name="request_date"]');
        if (requestDateInput && !requestDateInput.value) {
            requestDateInput.value = today;
        }
    });

    return {
        items: [],
        itemsJSON: '[]',

        init() {
            {% if action == 'update' %}
            this.items = [
                {% for item in request.items.all %}
                {
                    product_id: '{{ item.product.id }}',
                    quantity: {{ item.quantity }},
                    preferred_supplier_id: {% if item.preferred_supplier %}'{{ item.preferred_supplier.id }}'{% else %}''{% endif %},
                    specifications: '{{ item.specifications|default:"" }}',
                    notes: '{{ item.notes|default:"" }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            {% endif %}
        },

        addItem() {
            this.items.push({
                product_id: '',
                quantity: 1,
                preferred_supplier_id: '',
                specifications: '',
                notes: ''
            });
        },

        removeItem(index) {
            this.items.splice(index, 1);
        },

        prepareSubmit(e) {
            this.itemsJSON = JSON.stringify(this.items);
        }
    }
}
</script>
{% endblock %}
