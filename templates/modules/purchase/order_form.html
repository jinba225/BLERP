{% extends 'layouts/base.html' %}
{% block title %}{% if action == 'create' %}新建{% else %}编辑{% endif %}采购订单{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="orderForm()" x-init="init()">
<form method="post" @submit="prepareSubmit">
{% csrf_token %}
<input type="hidden" name="items_json" x-model="itemsJSON">
<input type="hidden" name="shipping_cost" x-model="shippingCost">
<input type="hidden" name="discount_amount" x-model="discountAmount">

<div class="mb-6">
<h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建采购订单{% else %}编辑采购订单{% endif %}</h3>
</div>

<!-- 基本信息 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">供应商 <span class="text-red-500">*</span></label>
<div x-data="searchableSelect({
    options: window.suppliersData,
    value: '{% if order and order.supplier %}{{ order.supplier.id }}{% endif %}',
    searchFields: ['name', 'code'],
    displayField: 'name',
    placeholder: '搜索供应商名称或代码',
    required: true,
    onSelect: (supplier) => window.orderFormInstance?.handleSupplierSelected(supplier)
})" class="relative">
    <!-- 隐藏input用于表单提交 -->
    <input type="hidden" name="supplier" :value="value">

    <!-- 搜索输入框 -->
    <div class="relative">
        <input
            type="text"
            x-model="search"
            @input="isOpen = true"
            @keydown.enter="selectFirst()"
            @keydown.escape="close()"
            @focus="isOpen = true"
            @blur="setTimeout(() => close(), 150)"
            :placeholder="placeholder"
            class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 transition-all"
        >
        <!-- 下拉箭头 -->
        <button
            type="button"
            @click="toggle()"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
        >
            <svg x-show="!isOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            <svg x-show="isOpen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>
    </div>

    <!-- 下拉选项面板 -->
    <div
        x-show="isOpen && filtered.length > 0"
        x-transition:enter="transition ease-out duration-100"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-75"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="absolute z-10 mt-1 w-full max-h-60 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200"
        style="display: none;"
    >
        <template x-for="(option, index) in filtered" :key="option.id">
            <div
                @click="select(option)"
                class="px-4 py-2 hover:bg-theme-50 cursor-pointer transition-colors"
                :class="getHighlightClass(index)"
                x-text="option.name"
            >
            </div>
        </template>
    </div>

    <!-- 无匹配提示 -->
    <div
        x-show="isOpen && filtered.length === 0"
        class="absolute z-10 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 px-4 py-3 text-gray-500"
        style="display: none;"
    >
        未找到匹配的供应商
    </div>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">订单日期 <span class="text-red-500">*</span></label>
<input type="date" name="order_date" value="{% if order %}{{ order.order_date|date:'Y-m-d' }}{% endif %}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">要求交期</label>
<input type="date" name="required_date" value="{% if order and order.required_date %}{{ order.required_date|date:'Y-m-d' }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div class="md:col-span-1">
<label class="block text-sm font-medium text-gray-700 mb-2">采购员</label>
<select name="buyer" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="">请选择</option>
{% if buyers and buyers|length > 0 %}
{% for buyer in buyers %}
<option value="{{ buyer.id }}" {% if order and order.buyer and order.buyer.id == buyer.id %}selected{% endif %}>{{ buyer.get_full_name|default:buyer.username }}</option>
{% endfor %}
{% else %}
{% if user.is_authenticated %}
<option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
{% else %}
<option value="">无可用采购员</option>
{% endif %}
{% endif %}
</select>
</div>
<div class="md:col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
<textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">{% if order %}{{ order.notes }}{% endif %}</textarea>
</div>

</div>
</div>

<!-- 订单明细 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h4 class="text-md font-semibold text-gray-900">订单明细</h4>
<button type="button" @click="addItem" class="px-3 py-1.5 bg-theme-600 text-white rounded-lg text-sm hover:bg-theme-700"><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
</svg>添加行</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full">
<thead class="bg-gray-50">
<tr>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-8">#</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">产品 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">数量 *</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">币种</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">未税单价 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">税率 (%)</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">未税小计</th>
<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">操作</th>
</tr>
</thead>
<tbody @product-selected="handleProductSelected($event)">
<template x-for="(item, index) in items" :key="index">
<tr class="border-t">
<td class="px-3 py-2 text-sm text-gray-500" x-text="index + 1"></td>
<td class="px-3 py-2">
    <input type="hidden" x-model="item.product_id">
    <div x-data="tableProductSelect(item.product_id, index)" class="relative">
        <!-- 搜索输入框 -->
        <div class="relative">
            <input
                type="text"
                x-model="search"
                @input="openDropdown()"
                @keydown.enter="selectFirst()"
                @keydown.escape="isOpen = false"
                @focus="openDropdown()"
                @blur="setTimeout(() => isOpen = false, 150)"
                placeholder="搜索产品代码或名称"
                class="w-full px-2 py-1 pr-10 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500 transition-colors"
            >
            <!-- 下拉箭头 -->
            <button
                type="button"
                @click="isOpen = !isOpen; updateDropdownPosition()"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
            >
                <svg x-show="!isOpen" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
                <svg x-show="isOpen" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
            </button>
        </div>

        <!-- 下拉选项面板 - 使用fixed定位 -->
        <div
            x-show="isOpen && filtered.length > 0"
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
            class="max-h-60 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200"
            :style="dropdownStyle"
            style="display: none;"
        >
            <template x-for="product in filtered" :key="product.id">
                <div
                    @click="selectProduct(product)"
                    class="px-3 py-2 hover:bg-theme-50 cursor-pointer transition-colors text-sm"
                >
                    <div class="font-medium" x-text="product.code + ' - ' + product.name"></div>
                    <div x-show="product.specifications" x-text="product.specifications" class="text-xs text-gray-500"></div>
                </div>
            </template>
        </div>

        <!-- 无匹配提示 - 使用fixed定位 -->
        <div
            x-show="isOpen && filtered.length === 0"
            class="max-h-60 overflow-y-auto bg-white rounded-lg shadow-lg border border-gray-200 px-3 py-2 text-gray-500 text-sm"
            :style="dropdownStyle"
            style="display: none;"
        >
            未找到匹配的产品
        </div>
    </div>
</td>
<td class="px-3 py-2"><input type="number" x-model="item.quantity" @input="calculateLineTotal(index)" step="1" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors" required></td>
<td class="px-3 py-2">
    <select x-model="item.currency" @change="calculateLineTotal(index)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:border-theme-500 transition-colors">
        <option value="CNY">CNY</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
    </select>
</td>
<td class="px-3 py-2"><input type="number" x-model="item.unit_price" @input="calculateLineTotal(index)" step="0.01" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors" required></td>
<td class="px-3 py-2">
    <select x-model="item.tax_rate" @change="calculateLineTotal(index)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
        <option value="13" selected>13%</option>
        {% for tax_rate in tax_rates %}
        <option value="{{ tax_rate.rate }}">{{ tax_rate.rate }}%</option>
        {% endfor %}
    </select>
</td>
<td class="px-3 py-2 text-sm text-right font-medium text-gray-900" x-text="formatMoney(item.line_total)"></td>
<td class="px-3 py-2 text-center">
<button type="button" @click="removeItem(index)" class="text-red-600 hover:text-red-800"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg></button>
</td>
</tr>
</template>
<template x-if="items.length === 0">
<tr><td colspan="7" class="px-3 py-8 text-center text-gray-500 text-sm">暂无明细，请点击"添加行"按钮添加产品</td></tr>
</template>
</tbody>
</table>
</div>
</div>

<!-- 金额汇总 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">金额汇总</h4>
<div class="max-w-md ml-auto space-y-2">
<div class="flex justify-between text-sm"><span class="text-gray-600">小计：</span><span class="font-medium" x-text="formatMoney(subtotal)"></span></div>
<div class="flex justify-between text-sm"><span class="text-gray-600">税额：</span><span class="font-medium" x-text="formatMoney(taxAmount)"></span></div>
<div class="flex justify-between text-sm">
    <span class="text-gray-600">运费：</span>
    <input type="number" x-model="shippingCost" @input="calculateTotals" step="0.01" min="0" class="w-32 px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
</div>
<div class="flex justify-between text-sm">
    <span class="text-gray-600">优惠金额：</span>
    <input type="number" x-model="discountAmount" @input="calculateTotals" step="0.01" min="0" class="w-32 px-2 py-1 border border-gray-300 rounded text-sm text-right focus:outline-none focus:border-theme-500 transition-colors">
</div>
<div class="flex justify-between text-lg font-bold pt-2 border-t"><span>总计：</span><span class="text-theme-600" x-text="formatMoney(totalAmount)"></span></div>
</div>
</div>

<!-- 操作按钮 -->
<div class="flex justify-end space-x-3 mb-6">
<a href="{% if action == 'update' %}{% url 'purchase:order_detail' order.pk %}{% else %}{% url 'purchase:order_list' %}{% endif %}" class="h-10 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center">取消</a>
<button type="submit" class="px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700">保存</button>
</div>

</form>
</div>

<script>
// 初始化可搜索下拉框数据
window.suppliersData = {{ suppliers_json|safe }};
window.warehousesData = {{ warehouses_json|safe }};
window.productsData = {{ products_json|safe }};

// 表格行产品选择器组件
document.addEventListener('alpine:init', () => {
    Alpine.data('tableProductSelect', (initialProductId = null, rowIndex = null) => ({
        isOpen: false,
        search: '',
        selected: null,
        rowIndex: rowIndex,
        dropdownStyle: '',

        get filtered() {
            if (!this.search || !this.search.trim()) {
                return window.productsData;
            }
            const query = this.search.toLowerCase().trim();
            return window.productsData.filter(product =>
                product.name.toLowerCase().includes(query) ||
                (product.code && product.code.toLowerCase().includes(query))
            );
        },

        selectProduct(product) {
            console.log('=== tableProductSelect.selectProduct ===');
            console.log('选择的产品:', product);
            console.log('产品ID:', product.id, '类型:', typeof product.id);
            console.log('rowIndex:', this.rowIndex);

            this.selected = product;
            this.search = product.code + ' - ' + product.name;
            this.isOpen = false;

            // 方法1：通过全局实例直接调用父组件方法
            if (window.orderFormInstance && typeof window.orderFormInstance.handleProductSelected === 'function') {
                console.log('通过全局实例调用 handleProductSelected');
                window.orderFormInstance.handleProductSelected({
                    rowIndex: this.rowIndex,
                    product: product
                });
            } else {
                console.log('全局实例不可用，尝试事件派发');
                // 方法2：通过事件派发
                this.$dispatch('product-selected', {
                    rowIndex: this.rowIndex,
                    product: product
                });
            }
        },

        selectFirst() {
            if (this.filtered.length > 0) {
                this.selectProduct(this.filtered[0]);
            }
        },

        updateDropdownPosition() {
            if (!this.isOpen) return;
            this.$nextTick(() => {
                const input = this.$el.querySelector('input[type="text"]');
                if (!input) return;

                const rect = input.getBoundingClientRect();
                const dropdownHeight = 240; // max-h-60 = 240px

                // 计算下拉面板位置
                let top = rect.bottom + window.scrollY + 4;
                const left = rect.left + window.scrollX;
                const width = rect.width;

                // 检查底部空间是否足够
                if (top + dropdownHeight > window.innerHeight + window.scrollY) {
                    // 底部空间不足，显示在输入框上方
                    top = rect.top + window.scrollY - dropdownHeight - 4;
                }

                this.dropdownStyle = `position: fixed; top: ${top}px; left: ${left}px; width: ${width}px; z-index: 9999;`;
            });
        },

        openDropdown() {
            this.isOpen = true;
            this.updateDropdownPosition();
        },

        init() {
            if (initialProductId) {
                this.selected = window.productsData.find(p => p.id == initialProductId);
                if (this.selected) {
                    this.search = this.selected.code + ' - ' + this.selected.name;
                }
            }
        }
    }));
});

function orderForm() {
    // 设置默认日期为当天
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const orderDateInput = document.querySelector('input[name="order_date"]');
        if (orderDateInput && !orderDateInput.value) {
            orderDateInput.value = today;
        }
    });

    return {
        items: [],
        shippingCost: {% if order %}{{ order.shipping_cost }}{% else %}0{% endif %},
        discountAmount: 0,
        subtotal: 0,
        taxAmount: 0,
        totalAmount: 0,
        itemsJSON: '[]',

        init() {
            console.log('=== orderForm init() 开始 ===');
            console.log('action:', '{{ action }}');
            console.log('order存在:', {% if order %}true{% else %}false{% endif %});
            {% if action == 'update' and order %}
            console.log('订单号:', '{{ order.order_number }}');
            console.log('明细数量:', {{ order.items.all|length }});
            this.items = [
                {% for item in order.items.all %}
                {
                    product_id: '{{ item.product.id }}',
                    quantity: {{ item.quantity }},
                    unit_price: {{ item.unit_price }},
                    tax_rate: {% if order.tax_rate %}{{ order.tax_rate }}{% else %}13{% endif %},
                    currency: '{{ order.currency|default:"CNY" }}',
                    line_total: {{ item.line_total }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            console.log('items数组:', this.items);


            {% else %}
            console.log('新建模式，items为空数组');
            {% endif %}
            this.calculateTotals();

            // 将实例保存到全局，供 searchableSelect 的 onSelect 回调使用
            window.orderFormInstance = this;

            console.log('=== orderForm init() 结束 ===');
        },

        addItem() {
            console.log('=== addItem 调用 ===');
            console.log('当前 items 数量:', this.items.length);
            const newItem = {
                product_id: '',
                quantity: 1,
                unit_price: 0,
                tax_rate: 13,
                currency: 'CNY',
                line_total: 0
            };
            this.items.push(newItem);
            console.log('添加后 items 数量:', this.items.length);
            console.log('新添加的 item:', newItem);
        },

        removeItem(index) {
            this.items.splice(index, 1);
            this.calculateTotals();
        },

        onProductChange(index) {
            const select = event.target;
            const option = select.options[select.selectedIndex];
            if (option.dataset.price) {
                this.items[index].unit_price = parseFloat(option.dataset.price);
                this.calculateLineTotal(index);
            }
        },

        handleProductSelected(event) {
            // 处理表格产品选择器派发的事件
            const { rowIndex, product } = event;
            console.log('=== handleProductSelected 触发 ===');
            console.log('rowIndex:', rowIndex, '类型:', typeof rowIndex);
            console.log('product:', product);
            console.log('product.id:', product.id, '类型:', typeof product.id);
            console.log('当前 items 数组:', this.items);
            console.log('items[' + rowIndex + '] 更新前:', this.items[rowIndex]);

            if (rowIndex !== null && rowIndex !== undefined && product && product.id) {
                // 确保 product_id 是数字类型
                this.items[rowIndex].product_id = parseInt(product.id);
                // 从产品数据中获取成本价（如果有）
                this.items[rowIndex].unit_price = parseFloat(product.cost_price || 0);
                console.log(`已更新 items[${rowIndex}]:`, this.items[rowIndex]);
                console.log(`product_id 已设置为: ${this.items[rowIndex].product_id} (类型: ${typeof this.items[rowIndex].product_id})`);
                this.calculateLineTotal(rowIndex);
            } else {
                console.error('handleProductSelected: 无效的参数', { rowIndex, product });
            }
        },

        handleSupplierSelected(supplier) {
            // 处理供应商选择后的采购员自动填充
            console.log('=== handleSupplierSelected 触发 ===');
            console.log('供应商数据:', supplier);

            if (!supplier) {
                console.log('供应商数据为空，跳过自动填充');
                return;
            }

            // 自动填充采购员
            const buyerSelect = document.querySelector('select[name="buyer"]');
            if (buyerSelect) {
                if (supplier.buyer_id) {
                    console.log('填充供应商设定的采购员:', supplier.buyer_id);
                    buyerSelect.value = supplier.buyer_id;
                } else {
                    console.log('供应商未设定采购员，填充当前登录用户');
                    // 查找当前登录用户的选项并选中
                    for (let i = 0; i < buyerSelect.options.length; i++) {
                        if (buyerSelect.options[i].value) {
                            buyerSelect.value = buyerSelect.options[i].value;
                            break;
                        }
                    }
                }
            }
        },


        calculateLineTotal(index) {
            const item = this.items[index];
            const qty = parseFloat(item.quantity) || 0;
            const price = parseFloat(item.unit_price) || 0;

            // 未税小计 = 未税单价 * 数量
            item.line_total = qty * price;

            this.calculateTotals();
        },

        calculateTotals() {
            // 计算未税小计和税额，考虑每个项目的税率
            let exTaxSubtotal = 0;
            let totalTaxAmount = 0;

            this.items.forEach(item => {
                const lineTotal = parseFloat(item.line_total) || 0; // 现在line_total是未税金额
                const taxRate = parseFloat(item.tax_rate) || 0;
                exTaxSubtotal += lineTotal;
                totalTaxAmount += lineTotal * (taxRate / 100);
            });

            this.subtotal = exTaxSubtotal;
            this.taxAmount = totalTaxAmount;

            // 总计 = 未税小计 + 税额 + 运费 - 优惠
            this.totalAmount = this.subtotal + this.taxAmount + parseFloat(this.shippingCost) - parseFloat(this.discountAmount);
        },

        formatMoney(value) {
            return '¥' + (parseFloat(value) || 0).toFixed(2);
        },

        prepareSubmit(e) {
            console.log('=== prepareSubmit 开始 ===');
            console.log('items数组:', this.items);
            console.log('items数量:', this.items.length);

            let validItemsCount = 0;
            this.items.forEach((item, index) => {
                console.log(`--- 明细 ${index} ---`);
                console.log(`  product_id=${item.product_id} (类型: ${typeof item.product_id})`);
                console.log(`  product_id 是空字符串? "${item.product_id === ''}"`);
                console.log(`  quantity=${item.quantity}, unit_price=${item.unit_price}`);
                console.log(`  完整 item 对象:`, JSON.stringify(item));

                // 检查是否是有效明细
                if (item.product_id && item.product_id !== '') {
                    validItemsCount++;
                }
            });

            console.log(`有效明细数量: ${validItemsCount} / ${this.items.length}`);

            // 序列化items数组
            const itemsJson = JSON.stringify(this.items);
            console.log('itemsJSON:', itemsJson);

            // 手动设置隐藏输入框的值（绕过x-model的异步更新）
            const itemsInput = document.querySelector('input[name="items_json"]');
            if (itemsInput) {
                itemsInput.value = itemsJson;
                console.log('已设置 items_json 输入框值，长度:', itemsInput.value.length);
            }

            console.log('=== prepareSubmit 结束 ===');

            // 如果没有有效明细，提示用户
            if (validItemsCount === 0) {
                alert('请至少添加一个产品明细！');
                e.preventDefault();
                return false;
            }

            // 表单会继续正常提交
        }
    }
}
</script>
{% endblock %}
