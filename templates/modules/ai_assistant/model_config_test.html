{% extends 'layouts/base.html' %}

{% block title %}测试AI模型配置 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">系统设置</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'ai_assistant:model_config_list' %}" class="text-gray-500 hover:text-gray-700">AI模型配置</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">测试连接</span>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">
                <svg class="icon text-theme-600 mr-2 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>测试AI模型配置
            </h3>
            <p class="text-sm text-gray-600 mt-1">验证配置是否正确，发送测试消息到AI模型</p>
        </div>
        <a href="{% url 'ai_assistant:model_config_list' %}" class="h-10 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-center">
            <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>返回列表
        </a>
    </div> <!-- Config Info -->
    <div class="bg-white rounded-lg shadow p-6">
        <h4 class="text-md font-semibold text-gray-900 mb-4">
            <svg class="icon text-theme-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>配置信息
        </h4>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <span class="text-gray-600">配置名称：</span>
                <span class="font-medium text-gray-900">{{ config.name }}</span>
            </div>
            <div>
                <span class="text-gray-600">提供商：</span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-theme-100 text-theme-800">
                    {{ config.get_provider_display }}
                </span>
            </div>
            <div>
                <span class="text-gray-600">模型名称：</span>
                <span class="font-medium text-gray-900">{{ config.model_name }}</span>
            </div>
            <div>
                <span class="text-gray-600">状态：</span>
                {% if config.is_active %}
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>启用
                </span>
                {% else %}
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>禁用
                </span>
                {% endif %}
            </div>
            {% if config.api_base %}
            <div class="col-span-2">
                <span class="text-gray-600">自定义端点：</span>
                <span class="font-mono text-xs text-gray-900">{{ config.api_base }}</span>
            </div>
            {% endif %}
        </div>
    </div> <!-- Test Section -->
    <div class="bg-white rounded-lg shadow p-6">
        <h4 class="text-md font-semibold text-gray-900 mb-4">
            <svg class="icon text-purple-600 mr-2 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>连接测试
        </h4> <!-- Test Button -->
        <div class="flex items-center justify-center py-8">
            <button class="btn btn-primary h-10 px-4" type="submit">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span id="buttonText">开始测试</span>
            </button>
        </div> <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-4">
            <div class="inline-flex items-center">
                <svg class="animate-spin h-5 w-5 text-theme-600 mr-3" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-600">正在测试连接...</span>
            </div>
        </div> <!-- Result Container -->
        <div id="resultContainer" class="hidden mt-6">
            <!-- Success Result -->
            <div id="successResult" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="icon text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h5 class="text-sm font-semibold text-green-800 mb-1">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" /></svg>连接测试成功！
                        </h5>
                        <p class="text-sm text-green-700" id="successMessage"></p>
                        <div class="mt-3 text-xs text-green-600">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                            配置正常，可以正常使用此AI模型
                        </div>
                    </div>
                </div>
            </div> <!-- Error Result -->
            <div id="errorResult" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="icon text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
</svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <h5 class="text-sm font-semibold text-red-800 mb-1">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>连接测试失败
                        </h5>
                        <p class="text-sm text-red-700" id="errorMessage"></p>
                        <div class="mt-3 text-xs text-red-600">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548 5.478a1 1 0 01-.994.909H8.626a1 1 0 01-.994-.909l-.548-5.478z" /></svg>
                            <strong>可能的原因：</strong>
                        </div>
                        <ul class="mt-2 text-xs text-red-600 list-disc list-inside space-y-1">
                            <li>API Key 不正确或已过期</li>
                            <li>网络连接问题或防火墙限制</li>
                            <li>API Base URL 配置错误</li>
                            <li>模型名称不存在或无权限访问</li>
                            <li>账户余额不足或已达配额限制</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div> <!-- Usage History (if available) -->
        {% if config.total_requests > 0 %}
        <div class="mt-6 pt-6 border-t border-gray-200">
            <h5 class="text-sm font-semibold text-gray-900 mb-3">
                <svg class="icon text-gray-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
</svg>使用统计
            </h5>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-900">{{ config.total_requests }}</div>
                    <div class="text-xs text-gray-600 mt-1">总请求次数</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-900">{{ config.total_tokens|default:0 }}</div>
                    <div class="text-xs text-gray-600 mt-1">总Token消耗</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <div class="text-sm font-medium text-gray-900">
                        {% if config.last_used_at %}
                        {{ config.last_used_at|date:"Y-m-d H:i" }}
                        {% else %}
                        从未使用
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-600 mt-1">最后使用时间</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div> <!-- Help Section -->
    <div class="bg-theme-50 border border-theme-200 rounded-lg p-4">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="icon text-theme-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
</svg>
            </div>
            <div class="ml-3">
                <h5 class="text-sm font-semibold text-theme-800 mb-2">测试说明</h5>
                <ul class="text-xs text-theme-700 space-y-1">
                    <li><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>测试将发送一条简单的消息到AI模型</li>
                    <li><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>验证API连接、认证和模型访问权限</li>
                    <li><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>不会消耗大量Token，仅用于验证配置</li>
                    <li><svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>测试失败请检查配置信息是否正确</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('testButton').addEventListener('click', async function() {
    const button = this;
    const buttonText = document.getElementById('buttonText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultContainer = document.getElementById('resultContainer');
    const successResult = document.getElementById('successResult');
    const errorResult = document.getElementById('errorResult');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage'); // Reset UI
    button.disabled = true;
    buttonText.textContent = '测试中...';
    loadingIndicator.classList.remove('hidden');
    resultContainer.classList.add('hidden');
    successResult.classList.add('hidden');
    errorResult.classList.add('hidden'); try {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.cookie.match(/csrftoken=([^;]+)/)?.[1]; // Send test request
        const response = await fetch('{% url "ai_assistant:model_config_test" config.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
        }); const data = await response.json(); // Hide loading
        loadingIndicator.classList.add('hidden'); // Show result
        resultContainer.classList.remove('hidden'); if (data.success) {
            successMessage.textContent = data.message;
            successResult.classList.remove('hidden');
        } else {
            errorMessage.textContent = data.message;
            errorResult.classList.remove('hidden');
        } } catch (error) {
        loadingIndicator.classList.add('hidden');
        resultContainer.classList.remove('hidden');
        errorMessage.textContent = '测试请求失败: ' + error.message;
        errorResult.classList.remove('hidden');
    } finally {
        button.disabled = false;
        buttonText.textContent = '重新测试';
    }
});
</script>

<!-- CSRF Token for AJAX -->
{% csrf_token %}
{% endblock %}
