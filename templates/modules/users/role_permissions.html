{% extends 'base.html' %}

{% block title %}{{ role.name }} - 角色管理 - BetterLaser ERP{% endblock %}
{% block page_title %}{{ role.name }} - 角色管理{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'users:role_list' %}" class="text-gray-500 hover:text-gray-700">角色管理</a>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'users:role_detail' role.pk %}" class="text-gray-500 hover:text-gray-700">{{ role.name }}</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">角色管理</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- 角色信息 -->
    <div class="bg-white rounded-lg shadow mb-6 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">{{ role.name }}</h3>
                <p class="text-sm text-gray-500 mt-1">{{ role.code }}</p>
                {% if role.description %}
                <p class="text-sm text-gray-600 mt-2">{{ role.description }}</p>
                {% endif %}
            </div>
            <div class="text-right">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                             {% if role.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                    <svg class="icon text-xs mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
</svg>
                    {% if role.is_active %}启用中{% else %}已停用{% endif %}
                </span>
            </div>
        </div>
    </div> <!-- Tab 导航 -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button type="button" onclick="switchTab('permissions')" id="tab-permissions"
                        class="tab-button active border-theme-600 text-theme-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>权限配置
                </button>
                <button type="button" onclick="switchTab('users')" id="tab-users"
                        class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
</svg>用户管理
                    <span class="ml-2 bg-theme-100 text-theme-800 py-0.5 px-2 rounded-full text-xs">{{ user_count }}</span>
                </button>
            </nav>
        </div>
    </div> <!-- 权限配置 Tab -->
    <div id="content-permissions" class="tab-content">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_permissions"> <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <svg class="icon mr-2" text-theme-600 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>权限配置
                    </h3>
                    <div class="flex gap-2">
                        <button type="button" id="selectAllPerms"
                                class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>全选
                        </button>
                        <button type="button" id="deselectAllPerms"
                                class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>清空
                        </button>
                    </div>
                </div> <div class="p-6">
                    {% if permissions_by_app %}
                    <div class="space-y-6">
                        {% for app_label, models in permissions_by_app.items %}
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- 应用模块标题 -->
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <h4 class="text-md font-semibold text-gray-900 uppercase">
                                    <svg class="icon mr-2" text-theme-600 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>{{ app_label }}
                                </h4>
                            </div> <!-- 权限列表 -->
                            <div class="p-4">
                                {% for model_name, perms in models.items %}
                                <div class="mb-4 last:mb-0">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="icon text-gray-400 mr-2 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                                        {{ model_name|title }}
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 ml-6">
                                        {% for perm in perms %}
                                        <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" name="permissions" value="{{ perm.id }}"
                                                   {% if perm.id in current_permission_ids %}checked{% endif %}
                                                   class="permission-checkbox rounded border-gray-300 text-theme-600 focus:ring-theme-500 h-4 w-4">
                                            <span class="ml-2 text-sm text-gray-700">
                                                {% if perm.name|slice:":3" == "Can" %}
                                                    {{ perm.name|slice:"4:" }}
                                                {% else %}
                                                    {{ perm.name }}
                                                {% endif %}
                                            </span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12">
                        <svg class="icon text-gray-300 text-6xl mb-4 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                        <p class="text-gray-500">暂无可分配的权限</p>
                    </div>
                    {% endif %}
                </div>
            </div> <!-- 保存权限按钮 -->
            <div class="flex justify-between items-center">
                <a href="{% url 'users:role_detail' role.pk %}"
                   class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>返回
                </a>
                <button class="btn btn-primary" type="submit">
                    <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
</svg>保存权限
                </button>
            </div> <!-- 权限说明 -->
            <div class="bg-theme-50 border-l-4 border-theme-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="icon text-theme-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-theme-800 mb-2">权限说明</h3>
                        <ul class="text-sm text-theme-700 space-y-1 list-disc list-inside">
                            <li><strong>add</strong>: 添加/创建权限</li>
                            <li><strong>change</strong>: 修改/编辑权限</li>
                            <li><strong>delete</strong>: 删除权限</li>
                            <li><strong>view</strong>: 查看权限</li>
                        </ul>
                        <p class="text-sm text-theme-700 mt-2">
                            <strong>提示：</strong>修改角色权限后，所有拥有该角色的用户权限将自动更新。
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div> <!-- 用户管理 Tab -->
    <div id="content-users" class="tab-content hidden">
        <!-- 当前用户列表 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <svg class="icon mr-2 text-theme-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
</svg>当前用户
                    <span class="ml-2 text-sm font-normal text-gray-500">(共 {{ user_count }} 人)</span>
                </h3>
            </div> {% if current_users %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">用户信息</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工编号</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">部门/职位</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for user_role in current_users %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        {% if user_role.user.avatar %}
                                        <img class="h-10 w-10 rounded-full" src="{{ user_role.user.avatar.url }}" alt="{{ user_role.user.username }}">
                                        {% else %}
                                        <div class="h-10 w-10 rounded-full bg-theme-100 flex items-center justify-center">
                                            <span class="text-theme-600 font-semibold text-lg">{{ user_role.user.username|first|upper }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ user_role.user.username }}
                                            {% if user_role.user.is_staff %}
                                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                                <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7zm-1.476 3.488a8.987 8.987 0 00-6.03-2.326c-2.043 0-3.926.678-5.446 1.826M14 6a4 4 0 11-8 0 4 4 0 018 0zM2.21 20.89a9 9 0 0112.66-2.08c.31.24.59.51.84.79M12 12V9.5m0 2.5h.01" />
</svg>管理员
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
</svg>{{ user_role.user.email }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ user_role.user.employee_id|default:"-" }}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900">
                                    <svg class="icon mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-9a2 2 0 012-2h4a2 2 0 012 2v9" />
</svg>
                                    {{ user_role.user.department.name|default:"未分配" }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    <svg class="icon mr-1" text-gray-400 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                    {{ user_role.user.position|default:"未设置" }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if user_role.user.is_active %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>活跃
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>停用
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a href="{% url 'users:user_detail' user_role.user.pk %}"
                                   class="text-theme-600 hover:text-theme-900 mr-3" title="查看用户">
                                    <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
</svg>
                                </a>
                                <form method="post" class="inline" onsubmit="return confirm('确定要将此用户从角色中移除吗？');">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="remove_user">
                                    <input type="hidden" name="user_id" value="{{ user_role.user.id }}">
                                    <button type="submit" class="text-red-600 hover:text-red-900" title="移除用户">
                                        <svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="p-12 text-center text-gray-400">
                <svg class="icon mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
</svg>
                <p class="text-lg">暂无用户拥有此角色</p>
                <p class="text-sm mt-2">请在下方添加用户</p>
            </div>
            {% endif %}
        </div> <!-- 添加用户 -->
        <form method="post" id="addUsersForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_users"> <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <svg class="icon mr-2" text-theme-600 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>添加用户到角色
                        </h3>
                        <div class="flex items-center space-x-3">
                            <!-- 搜索框 -->
                            <div class="relative">
                                <input type="text" id="searchInput" value="{{ search }}"
                                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 w-64"
                                       placeholder="搜索用户...">
                                <svg class="icon absolute left-3 top-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
</svg>
                            </div>
                            <!-- 全选/清空按钮 -->
                            <button type="button" id="selectAllUsers"
                                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>全选
                            </button>
                            <button type="button" id="deselectAllUsers"
                                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg>清空
                            </button>
                        </div>
                    </div>
                </div> <div class="p-6">
                    {% if available_users %}
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        {% for user in available_users %}
                        <label class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-gray-200">
                            <input type="checkbox" name="users" value="{{ user.id }}"
                                   class="user-checkbox rounded border-gray-300 text-theme-600 focus:ring-theme-500 h-4 w-4">
                            <div class="ml-4 flex-1 flex items-center">
                                <!-- 用户头像 -->
                                <div class="flex-shrink-0">
                                    {% if user.avatar %}
                                    <img class="h-10 w-10 rounded-full" src="{{ user.avatar.url }}" alt="{{ user.username }}">
                                    {% else %}
                                    <div class="h-10 w-10 rounded-full bg-theme-100 flex items-center justify-center">
                                        <span class="text-theme-600 font-semibold">{{ user.username|first|upper }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <!-- 用户信息 -->
                                <div class="ml-4 flex-1">
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-gray-900">{{ user.username }}</span>
                                        {% if user.is_staff %}
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                            <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7zm-1.476 3.488a8.987 8.987 0 00-6.03-2.326c-2.043 0-3.926.678-5.446 1.826M14 6a4 4 0 11-8 0 4 4 0 018 0zM2.21 20.89a9 9 0 0112.66-2.08c.31.24.59.51.84.79M12 12V9.5m0 2.5h.01" />
</svg>管理员
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
</svg>{{ user.email }}
                                    </div>
                                </div>
                                <!-- 员工信息 -->
                                <div class="text-right">
                                    {% if user.employee_id %}
                                    <div class="text-sm text-gray-900">{{ user.employee_id }}</div>
                                    {% endif %}
                                    {% if user.department %}
                                    <div class="text-xs text-gray-500">
                                        <svg class="icon mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-9a2 2 0 012-2h4a2 2 0 012 2v9" />
</svg>{{ user.department.name }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                        {% endfor %}
                    </div> <!-- 已选择计数 -->
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                        <p class="text-sm text-gray-600">
                            已选择 <span id="selectedUserCount" class="font-semibold text-theme-600">0</span> 个用户
                            / 共 {{ available_users.count }} 个可用用户
                        </p>
                        <button class="btn btn-primary" type="submit" disabled id="submitBtn">
                            <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>添加选中的用户
                        </button>
                    </div> {% else %}
                    <div class="text-center py-12">
                        <svg class="icon text-gray-300 text-6xl mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
</svg>
                        <p class="text-gray-500 text-lg">没有可添加的用户</p>
                        <p class="text-gray-400 text-sm mt-2">所有活跃用户都已拥有此角色</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </form> <!-- 返回按钮 -->
        <div class="flex justify-start mt-6">
            <a href="{% url 'users:role_detail' role.pk %}"
               class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>返回角色详情
            </a>
        </div> <!-- 提示信息 -->
        <div class="bg-theme-50 border-l-4 border-theme-400 p-4 mt-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="icon text-theme-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-theme-800 mb-2">用户管理说明</h3>
                    <ul class="text-sm text-theme-700 space-y-1 list-disc list-inside">
                        <li>只显示尚未拥有此角色的活跃用户</li>
                        <li>添加用户后，系统会自动为其分配角色对应的权限</li>
                        <li>可以使用搜索功能快速查找用户</li>
                        <li>支持批量选择多个用户进行添加</li>
                        <li>移除用户时，系统会自动重新计算其剩余权限</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab 切换功能
    window.switchTab = function(tabName) {
        // 隐藏所有 tab 内容
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        }); // 移除所有 tab 按钮的 active 状态
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active', 'border-theme-600', 'text-theme-600');
            button.classList.add('border-transparent', 'text-gray-500');
        }); // 显示选中的 tab 内容
        document.getElementById('content-' + tabName).classList.remove('hidden'); // 激活选中的 tab 按钮
        const activeButton = document.getElementById('tab-' + tabName);
        activeButton.classList.add('active', 'border-theme-600', 'text-theme-600');
        activeButton.classList.remove('border-transparent', 'text-gray-500');
    }; // 权限配置 - 全选/清空
    const selectAllPermsBtn = document.getElementById('selectAllPerms');
    const deselectAllPermsBtn = document.getElementById('deselectAllPerms');
    const permCheckboxes = document.querySelectorAll('.permission-checkbox'); if (selectAllPermsBtn) {
        selectAllPermsBtn.addEventListener('click', function() {
            permCheckboxes.forEach(cb => cb.checked = true);
        });
    } if (deselectAllPermsBtn) {
        deselectAllPermsBtn.addEventListener('click', function() {
            permCheckboxes.forEach(cb => cb.checked = false);
        });
    } // 用户管理 - 全选/清空
    const selectAllUsersBtn = document.getElementById('selectAllUsers');
    const deselectAllUsersBtn = document.getElementById('deselectAllUsers');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    const submitBtn = document.getElementById('submitBtn');
    const selectedCountSpan = document.getElementById('selectedUserCount'); function updateUserCount() {
        const checkedCount = document.querySelectorAll('.user-checkbox:checked').length;
        if (selectedCountSpan) {
            selectedCountSpan.textContent = checkedCount;
        }
        if (submitBtn) {
            submitBtn.disabled = checkedCount === 0;
        }
    } if (selectAllUsersBtn) {
        selectAllUsersBtn.addEventListener('click', function() {
            userCheckboxes.forEach(cb => cb.checked = true);
            updateUserCount();
        });
    } if (deselectAllUsersBtn) {
        deselectAllUsersBtn.addEventListener('click', function() {
            userCheckboxes.forEach(cb => cb.checked = false);
            updateUserCount();
        });
    } userCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateUserCount);
    }); // 搜索功能
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                const searchValue = searchInput.value.trim();
                const currentUrl = new URL(window.location.href);
                if (searchValue) {
                    currentUrl.searchParams.set('search', searchValue);
                } else {
                    currentUrl.searchParams.delete('search');
                }
                // 切换到用户tab
                currentUrl.hash = '#users';
                window.location.href = currentUrl.toString();
            }, 500);
        });
    } // 初始化
    updateUserCount(); // 如果URL中有hash，切换到对应的tab
    if (window.location.hash === '#users') {
        switchTab('users');
    }
});
</script>
{% endblock %}
