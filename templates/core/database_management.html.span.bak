{% extends 'base.html' %}

{% block title %}{{ page_title }} - BetterLaser ERPç³»ç»Ÿ{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'dashboard' %}" class="text-gray-600 hover:text-gray-900">é¦–é¡µ</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-600">åŸºç¡€è®¾ç½®</span>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{{ page_title }}</span>
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="databaseManagement()">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-database text-theme-600 mr-2"></i>
                {{ page_title }}
            </h1>
            <p class="text-gray-600 mt-1">æ•°æ®åº“ç»´æŠ¤å’Œæµ‹è¯•æ•°æ®ç®¡ç†</p>
        </div>
    </div>

    <!-- Database Info Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <svg x-data="heroicon('information-circle')" class="text-theme-500 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
            æ•°æ®åº“ä¿¡æ¯
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">æ•°æ®åº“ç±»å‹</div>
                <div class="text-xl font-bold text-gray-900">{{ db_info.engine|upper }}</div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">æ•°æ®è¡¨æ•°é‡</div>
                <div class="text-xl font-bold text-gray-900">{{ db_info.table_count }}</div>
            </div>
            {% if db_info.size_mb %}
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">æ•°æ®åº“å¤§å°</div>
                <div class="text-xl font-bold text-gray-900">{{ db_info.size_mb }} MB</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Operations Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <svg x-data="heroicon('wrench')" class="text-theme-500 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
            æ•°æ®åº“æ“ä½œ
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- æ·»åŠ æµ‹è¯•æ•°æ® -->
            <button @click="confirmAddTestData()"
                    :disabled="loading"
                    class="group p-6 bg-gradient-to-br from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 rounded-lg border-2 border-green-200 hover:border-green-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <svg x-data="heroicon('plus-circle')" class="text-3xl text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">æ·»åŠ æµ‹è¯•æ•°æ®</h4>
                    <p class="text-sm text-gray-600">åˆ›å»ºç¤ºä¾‹å®¢æˆ·ã€äº§å“ç­‰æ•°æ®</p>
                </div>
            </button>

            <!-- æ¸…é™¤æ‰€æœ‰å•æ® -->
            <button @click="confirmClearAllDocuments()"
                    :disabled="loading"
                    class="group p-6 bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 rounded-lg border-2 border-red-300 hover:border-red-400 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <svg x-data="heroicon('exclamation-triangle')" class="text-3xl text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
                    </div>
                    <h4 class="font-semibold text-red-900 mb-1">æ¸…é™¤æ‰€æœ‰å•æ®</h4>
                    <p class="text-sm text-red-700">æ¸…ç©ºæ‰€æœ‰ä¸šåŠ¡å•æ®å¹¶é‡ç½®ID</p>
                </div>
            </button>

            <!-- å¤‡ä»½æ•°æ®åº“ -->
            <button @click="confirmBackupDatabase()"
                    :disabled="loading"
                    class="group p-6 bg-gradient-to-br from-theme-50 to-theme-100 hover:from-theme-100 hover:to-theme-200 rounded-lg border-2 border-theme-200 hover:border-theme-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-theme-500 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <svg x-data="heroicon('arrow-down-tray')" class="text-3xl text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">å¤‡ä»½æ•°æ®åº“</h4>
                    <p class="text-sm text-gray-600">åˆ›å»ºæ•°æ®åº“å¤‡ä»½æ–‡ä»¶</p>
                </div>
            </button>

            <!-- è¿˜åŸæ•°æ®åº“ -->
            <button @click="showRestoreModal = true"
                    :disabled="loading || !hasBackups"
                    class="group p-6 bg-gradient-to-br from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 rounded-lg border-2 border-red-200 hover:border-red-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <div class="flex flex-col items-center text-center">
                    <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <i class="fas fa-upload text-3xl text-white"></i>
                    </div>
                    <h4 class="font-semibold text-gray-900 mb-1">è¿˜åŸæ•°æ®åº“</h4>
                    <p class="text-sm text-gray-600">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</p>
                </div>
            </button>
        </div>

        <!-- Loading indicator -->
        <div x-show="loading" class="mt-4 text-center">
            <div class="inline-flex items-center px-4 py-2 bg-theme-100 text-theme-700 rounded-lg">
                <svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="loadingMessage">å¤„ç†ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- Backup List Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-history text-theme-500 mr-2"></i>
            å¤‡ä»½æ–‡ä»¶åˆ—è¡¨
        </h3>

        {% if backups %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ–‡ä»¶å</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¤§å°</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for backup in backups %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-file-archive text-theme-500 mr-2"></i>
                                <span class="text-sm font-medium text-gray-900">{{ backup.name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ backup.created_at|date:"Y-m-d H:i:s" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {{ backup.size_mb }} MB
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="{% url 'core:database_download_backup' backup.name %}"
                               class="text-theme-600 hover:text-theme-900 mr-3">
                                <svg x-data="heroicon('arrow-down-tray')" class="mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>ä¸‹è½½
                            </a>
                            <button @click="selectBackupForRestore('{{ backup.name }}')"
                                    class="text-green-600 hover:text-green-900">
                                <i class="fas fa-undo mr-1"></i>è¿˜åŸ
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <svg x-data="heroicon('inbox')" class="text-4xl text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
            <p class="text-gray-500">æš‚æ— å¤‡ä»½æ–‡ä»¶</p>
            <p class="text-sm text-gray-400 mt-2">ç‚¹å‡»"å¤‡ä»½æ•°æ®åº“"æŒ‰é’®åˆ›å»ºå¤‡ä»½</p>
        </div>
        {% endif %}
    </div>

    <!-- Restore Modal -->
    <div x-show="showRestoreModal"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showRestoreModal = false">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" @click.stop>
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                        <svg x-data="heroicon('exclamation-triangle')" class="text-2xl text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">ç¡®è®¤è¿˜åŸæ•°æ®åº“</h3>
                        <p class="text-sm text-gray-600">æ­¤æ“ä½œå°†æ›¿æ¢å½“å‰æ•°æ®åº“</p>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-700">
                        <svg x-data="heroicon('information-circle')" class="text-yellow-600 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>
                        è¿˜åŸå‰ä¼šè‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®åº“ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å¤‡ä»½æ–‡ä»¶ï¼š</label>
                    <p class="text-sm font-semibold text-gray-900" x-text="selectedBackup || 'æœªé€‰æ‹©'"></p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button @click="showRestoreModal = false"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button @click="restoreDatabase()"
                            :disabled="!selectedBackup"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-data="heroicon('check')" class="mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" x-cloak><span x-html="svg"></span></svg>ç¡®è®¤è¿˜åŸ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function databaseManagement() {
    return {
        loading: false,
        loadingMessage: 'å¤„ç†ä¸­...',
        showRestoreModal: false,
        selectedBackup: null,
        hasBackups: {{ backups|length }} > 0,

        confirmAddTestData() {
            if (confirm('ç¡®å®šè¦æ·»åŠ æµ‹è¯•æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ›å»ºç¤ºä¾‹å®¢æˆ·ã€ä¾›åº”å•†ã€äº§å“ç­‰æ•°æ®ã€‚')) {
                this.addTestData();
            }
        },

        async addTestData() {
            this.loading = true;
            this.loadingMessage = 'æ­£åœ¨æ·»åŠ æµ‹è¯•æ•°æ®...';

            try {
                const response = await fetch('{% url "core:database_add_test_data" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message);
                    location.reload();
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        confirmClearAllDocuments() {
            // ç¬¬ä¸€æ¬¡ç¡®è®¤ï¼šè­¦å‘Šçº§åˆ«
            if (!confirm('âš ï¸ å±é™©æ“ä½œè­¦å‘Šï¼\n\næ­¤æ“ä½œå°†æ¸…é™¤ç³»ç»Ÿä¸­æ‰€æœ‰ä¸šåŠ¡å•æ®ï¼\n\nåŒ…æ‹¬ä½†ä¸é™äºï¼š\nâ€¢ é”€å”®ç±»ï¼šæŠ¥ä»·å•ã€è®¢å•ã€å‘è´§å•ã€é”€å”®é€€è´§\nâ€¢ é‡‡è´­ç±»ï¼šé‡‡è´­ç”³è¯·ã€é‡‡è´­è®¢å•ã€æ”¶è´§å•ã€é‡‡è´­é€€è´§\nâ€¢ å®¢æˆ·/ä¾›åº”å•†ï¼šæ‰€æœ‰å®¢æˆ·å’Œä¾›åº”å•†æ•°æ®\nâ€¢ äº§å“æ•°æ®ï¼šæ‰€æœ‰äº§å“ä¿¡æ¯\nâ€¢ è´¢åŠ¡æ•°æ®ï¼šåº”æ”¶è´¦æ¬¾ã€åº”ä»˜è´¦æ¬¾\nâ€¢ åº“å­˜æ•°æ®ï¼šæ‰€æœ‰åº“å­˜è®°å½•\nâ€¢ åŸºç¡€æ•°æ®ï¼šå•ä½ã€å“ç‰Œã€åˆ†ç±»ã€ä»“åº“ã€åº“ä½ã€ç¨ç‡\n\né‡ç½®å†…å®¹ï¼š\nâ€¢ æ‰€æœ‰æ•°æ®åº“è‡ªå¢IDå°†é‡ç½®ä¸º1\nâ€¢ æ‰€æœ‰å•æ®å·åºåˆ—å°†é‡ç½®ï¼Œä¸‹æ¬¡åˆ›å»ºä»001å¼€å§‹\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            // ç¬¬äºŒæ¬¡ç¡®è®¤ï¼šè¦æ±‚ç”¨æˆ·è¾“å…¥ "CLEAR" ç¡®è®¤
            const confirmation = prompt('ğŸ”´ æœ€ç»ˆç¡®è®¤ï¼š\n\nè¿™æ˜¯ä¸€ä¸ªä¸å¯æ¢å¤çš„å±é™©æ“ä½œï¼\næ‰€æœ‰å•æ®å°†è¢«æ¸…é™¤ï¼Œæ•°æ®åº“IDå’Œå•æ®å·éƒ½å°†é‡ç½®ï¼\n\nè¯·è¾“å…¥ "CLEAR" æ¥ç¡®è®¤æ­¤æ“ä½œï¼š');

            if (confirmation === 'CLEAR') {
                this.clearAllDocuments();
            } else if (confirmation !== null) {
                alert('âŒ ç¡®è®¤æ–‡å­—é”™è¯¯ï¼Œæ“ä½œå·²å–æ¶ˆ');
            }
        },

        async clearAllDocuments() {
            this.loading = true;
            this.loadingMessage = 'æ­£åœ¨æ¸…é™¤æ‰€æœ‰å•æ®å¹¶é‡ç½®ID...';

            try {
                const response = await fetch('{% url "core:database_clear_test_data" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message);
                    location.reload();
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        confirmBackupDatabase() {
            if (confirm('ç¡®å®šè¦å¤‡ä»½å½“å‰æ•°æ®åº“å—ï¼Ÿ\n\nå¤‡ä»½æ–‡ä»¶å°†ä¿å­˜åˆ° backups ç›®å½•ã€‚')) {
                this.backupDatabase();
            }
        },

        async backupDatabase() {
            this.loading = true;
            this.loadingMessage = 'æ­£åœ¨å¤‡ä»½æ•°æ®åº“...';

            try {
                const response = await fetch('{% url "core:database_backup" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message);
                    location.reload();
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        selectBackupForRestore(filename) {
            this.selectedBackup = filename;
            this.showRestoreModal = true;
        },

        async restoreDatabase() {
            if (!this.selectedBackup) {
                alert('è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶');
                return;
            }

            this.showRestoreModal = false;
            this.loading = true;
            this.loadingMessage = 'æ­£åœ¨è¿˜åŸæ•°æ®åº“...';

            try {
                const formData = new FormData();
                formData.append('backup_file', this.selectedBackup);

                const response = await fetch('{% url "core:database_restore_database" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message + '\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('âŒ ' + data.message);
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                this.loading = false;
                this.selectedBackup = null;
            }
        }
    }
}
</script>
{% endblock %}
