{% extends 'base.html' %}

{% block title %}{% if action == 'create' %}新建出库单{% else %}编辑出库单{% endif %} - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">库存管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'inventory:outbound_list' %}" class="text-gray-500 hover:text-gray-700">出库单</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">{% if action == 'create' %}新建{% else %}编辑{% endif %}</span>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建出库单{% else %}编辑出库单{% endif %}</h3>
            {% if outbound %}
            <p class="text-sm text-gray-600">{{ outbound.order_number }}</p>
            {% endif %}
        </div>
    </div>

    <form method="post" class="bg-white rounded-lg shadow overflow-hidden" id="outboundForm">
        {% csrf_token %}
        <input type="hidden" name="items_json" id="items_json">

        <!-- Basic Information -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h4 class="text-md font-semibold text-gray-900">基本信息</h4>
        </div>
        <div class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        出库类型 <span class="text-red-500">*</span>
                    </label>
                    <select name="order_type"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                        <option value="">请选择出库类型</option>
                        {% for type_code, type_name in order_types %}
                        <option value="{{ type_code }}" {% if outbound and outbound.order_type == type_code %}selected{% endif %}>
                            {{ type_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        仓库 <span class="text-red-500">*</span>
                    </label>
                    <select name="warehouse"
                            required
                            id="warehouseSelect"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                        <option value="">请选择仓库</option>
                        {% for w in warehouses %}
                        <option value="{{ w.id }}" {% if outbound and outbound.warehouse_id == w.id %}selected{% endif %}>
                            {{ w.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        出库日期 <span class="text-red-500">*</span>
                    </label>
                    <input type="date"
                           name="order_date"
                           required
                           value="{% if outbound %}{{ outbound.order_date|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">客户</label>
                    <select name="customer"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                        <option value="">请选择客户</option>
                        {% for c in customers %}
                        <option value="{{ c.id }}" {% if outbound and outbound.customer_id == c.id %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">参考单号</label>
                    <input type="text"
                           name="reference_number"
                           value="{% if outbound %}{{ outbound.reference_number }}{% endif %}"
                           placeholder="关联的销售订单号等"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">参考类型</label>
                    <input type="text"
                           name="reference_type"
                           value="{% if outbound %}{{ outbound.reference_type }}{% endif %}"
                           placeholder="如: 销售订单、生产领料等"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="notes"
                              rows="3"
                              placeholder="备注信息"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500 focus:border-transparent">{% if outbound %}{{ outbound.notes }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="px-6 py-4 bg-gray-50 border-t border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h4 class="text-md font-semibold text-gray-900">出库明细</h4>
                <button type="button"
                        onclick="addItem()"
                        class="btn btn-primary text-sm px-3 py-1.5">
                    <i class="fas fa-plus mr-1"></i>添加产品
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full" id="itemsTable">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="pb-2" style="width: 30%">产品 <span class="text-red-500">*</span></th>
                            <th class="pb-2" style="width: 15%">库位</th>
                            <th class="pb-2" style="width: 12%">数量 <span class="text-red-500">*</span></th>
                            <th class="pb-2" style="width: 15%">批次号</th>
                            <th class="pb-2" style="width: 23%">备注</th>
                            <th class="pb-2" style="width: 5%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="itemsBody">
                        <!-- Items will be added dynamically -->
                    </tbody>
                </table>
                <div id="noItemsMessage" class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>暂无产品明细，点击"添加产品"按钮开始</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
            <a href="{% if outbound %}{% url 'inventory:outbound_detail' outbound.pk %}{% else %}{% url 'inventory:outbound_list' %}{% endif %}"
               class="btn btn-outline">
                <i class="fas fa-times mr-2"></i>取消
            </a>
            <button type="submit"
                    class="btn btn-primary">
                <i class="fas fa-save mr-2"></i>保存
            </button>
        </div>
    </form>
</div>

<script>
// 设置出库日期默认为当天
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const orderDateInput = document.querySelector('input[name="order_date"]');
    if (orderDateInput && !orderDateInput.value) {
        orderDateInput.value = today;
    }
});

let itemIndex = 0;
const products = {{ products|safe }};
const locations = {{ locations|safe }};

function addItem() {
    const tbody = document.getElementById('itemsBody');
    const noItemsMsg = document.getElementById('noItemsMessage');

    noItemsMsg.style.display = 'none';

    const row = document.createElement('tr');
    row.className = 'border-t border-gray-200';
    row.id = `item-row-${itemIndex}`;

    row.innerHTML = `
        <td class="py-2 pr-2">
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-theme-500"
                    id="product-${itemIndex}">
                <option value="">请选择产品</option>
                ${products.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('')}
            </select>
        </td>
        <td class="py-2 pr-2">
            <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-theme-500"
                    id="location-${itemIndex}">
                <option value="">请选择库位</option>
                ${locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('')}
            </select>
        </td>
        <td class="py-2 pr-2">
            <input type="number"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-theme-500"
                   placeholder="数量"
                   step="1"
                   min="1"
                   id="quantity-${itemIndex}">
        </td>
        <td class="py-2 pr-2">
            <input type="text"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-theme-500"
                   placeholder="批次号"
                   id="batch-${itemIndex}">
        </td>
        <td class="py-2 pr-2">
            <input type="text"
                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-theme-500"
                   placeholder="备注"
                   id="notes-${itemIndex}">
        </td>
        <td class="py-2">
            <button type="button"
                    onclick="removeItem(${itemIndex})"
                    class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(row);
    itemIndex++;
}

function removeItem(index) {
    const row = document.getElementById(`item-row-${index}`);
    if (row) {
        row.remove();
    }

    // Check if there are no items left
    const tbody = document.getElementById('itemsBody');
    if (tbody.children.length === 0) {
        document.getElementById('noItemsMessage').style.display = 'block';
    }
}

function collectItems() {
    const items = [];
    const tbody = document.getElementById('itemsBody');

    for (let row of tbody.children) {
        const rowId = row.id.split('-')[2];
        const productSelect = document.getElementById(`product-${rowId}`);
        const locationSelect = document.getElementById(`location-${rowId}`);
        const quantityInput = document.getElementById(`quantity-${rowId}`);
        const batchInput = document.getElementById(`batch-${rowId}`);
        const notesInput = document.getElementById(`notes-${rowId}`);

        if (productSelect && productSelect.value && quantityInput && quantityInput.value) {
            items.push({
                product_id: productSelect.value,
                location_id: locationSelect ? locationSelect.value : '',
                quantity: quantityInput.value,
                batch_number: batchInput ? batchInput.value : '',
                notes: notesInput ? notesInput.value : ''
            });
        }
    }

    return items;
}

document.getElementById('outboundForm').addEventListener('submit', function(e) {
    const items = collectItems();

    if (items.length === 0) {
        e.preventDefault();
        alert('请至少添加一个产品明细');
        return false;
    }

    document.getElementById('items_json').value = JSON.stringify(items);
});

// Initialize with one empty row for create mode
{% if action == 'create' %}
addItem();
{% endif %}

// Load existing items for edit mode
{% if outbound and outbound.items.all %}
{% for item in outbound.items.all %}
addItem();
document.getElementById(`product-${itemIndex-1}`).value = '{{ item.product_id }}';
{% if item.location %}
document.getElementById(`location-${itemIndex-1}`).value = '{{ item.location_id }}';
{% endif %}
document.getElementById(`quantity-${itemIndex-1}`).value = '{{ item.quantity }}';
document.getElementById(`batch-${itemIndex-1}`).value = '{{ item.batch_number }}';
document.getElementById(`notes-${itemIndex-1}`).value = '{{ item.notes }}';
{% endfor %}
{% endif %}
</script>
{% endblock %}
