{% extends 'base.html' %}
{% block title %}{% if action == 'create' %}新建{% else %}编辑{% endif %}借用单 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">采购管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:borrow_list' %}" class="text-gray-500 hover:text-gray-700">借用单</a>
{% if action == 'update' %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:borrow_detail' borrow.pk %}" class="text-gray-500 hover:text-gray-700">{{ borrow.borrow_number }}</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">编辑</span>
{% else %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">新建借用单</span>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建{% else %}编辑{% endif %}借用单</h3>
    </div> <form method="post" id="borrowForm" class="space-y-6">
        {% csrf_token %} <!-- 基本信息 -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="text-base font-semibold text-gray-900 mb-4">基本信息</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">供应商 <span class="text-red-500">*</span></label>
                    <div x-data="searchableSelect($el.getRootNode().host ? [] : window.suppliersData || [], {% if borrow %}{{ borrow.supplier.id }}{% elif form_data.supplier %}{{ form_data.supplier }}{% else %}''{% endif %})" class="searchable-select-wrapper">
                        <input type="hidden" name="supplier" :value="selectedValue">
                        <input
                            type="text"
                            class="searchable-select-input"
                            :value="displayValue"
                            @input="search = $event.target.value; isOpen = true"
                            @focus="toggleDropdown()"
                            @keydown="handleKeydown($event)"
                            @click.outside="closeDropdown()"
                            placeholder="请选择供应商"
                            x-ref="searchInput"
                            required
                        >
                        <i class="fas fa-chevron-down searchable-select-arrow" :class="{ 'open': isOpen }"></i>

                        <div x-show="isOpen" x-transition class="searchable-select-dropdown" @click.outside="closeDropdown()">
                            <template x-for="(option, index) in filteredOptions" :key="option.id">
                                <div
                                    class="searchable-select-option"
                                    :class="[
                                        highlightClass(index),
                                        { 'selected': selectedValue == option.id }
                                    ]"
                                    @click="selectOption(option)"
                                    x-text="option.name + (option.code ? ' (' + option.code + ')' : '')"
                                ></div>
                            </template>
                            <div x-show="filteredOptions.length === 0" class="searchable-select-option text-gray-400">
                                未找到匹配的供应商
                            </div>
                        </div>
                    </div>
                    {% if errors.supplier %}
                    <p class="mt-1 text-sm text-red-600">{{ errors.supplier }}</p>
                    {% endif %}
                </div> <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">借用日期 <span class="text-red-500">*</span></label>
                    <input type="date" name="borrow_date" id="borrowDate" required
                           value="{% if borrow %}{{ borrow.borrow_date|date:'Y-m-d' }}{% elif form_data.borrow_date %}{{ form_data.borrow_date }}{% endif %}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500">
                </div> <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">预计归还日期</label>
                    <input type="date" name="expected_return_date"
                           value="{% if borrow and borrow.expected_return_date %}{{ borrow.expected_return_date|date:'Y-m-d' }}{% elif form_data.expected_return_date %}{{ form_data.expected_return_date }}{% endif %}"
                           class="w-full px-3 py-2 border {% if errors.expected_return_date %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-theme-500">
                    {% if errors.expected_return_date %}
                    <p class="mt-1 text-sm text-red-600">{{ errors.expected_return_date }}</p>
                    {% endif %}
                </div> <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">借用目的</label>
                    <textarea name="purpose" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500">{% if borrow %}{{ borrow.purpose }}{% elif form_data.purpose %}{{ form_data.purpose }}{% endif %}</textarea>
                </div> <div class="md:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
                    <textarea name="notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-500">{% if borrow %}{{ borrow.notes }}{% elif form_data.notes %}{{ form_data.notes }}{% endif %}</textarea>
                </div>
            </div>
        </div> <!-- 借用明细 -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-base font-semibold text-gray-900">借用明细</h4>
                <button class="btn btn-primary" type="button" id="addItemBtn">
                    <i class="fas fa-plus mr-2"></i>添加产品
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="itemsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">产品 <span class="text-red-500">*</span></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">借用数量 <span class="text-red-500">*</span></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">备注</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="itemsBody">
                        <!-- 将通过 JavaScript 动态添加行 -->
                    </tbody>
                </table>
            </div> <div id="noItemsMessage" class="py-8 text-center text-gray-400">
                <i class="fas fa-box-open text-3xl mb-2"></i>
                <p class="text-sm">暂无明细，请点击"添加产品"按钮添加</p>
            </div>
        </div> <!-- 隐藏字段：用于提交明细数据 -->
        <input type="hidden" name="items_json" id="itemsJson"> <!-- 操作按钮 -->
        <div class="flex gap-3">
            <button class="btn btn-primary" type="submit">
                <i class="fas fa-save mr-2"></i>保存
            </button>
            <a href="{% if action == 'update' %}{% url 'purchase:borrow_detail' borrow.pk %}{% else %}{% url 'purchase:borrow_list' %}{% endif %}"
               class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                <i class="fas fa-times mr-2"></i>取消
            </a>
        </div>
    </form>
</div>

<script>
// 初始化数据
window.suppliersData = {{ suppliers|safe }};
window.productsData = {{ products|safe }};
const existingItems = {{ existing_items|default:"[]"|safe }};

let itemsData = [];

// 添加明细行
function addItemRow(itemData = {}) {
    const tbody = document.getElementById('itemsBody');
    const rowIndex = itemsData.length;
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';

    // 创建产品选择器容器（用于Alpine.js）
    const productCell = document.createElement('td');
    productCell.className = 'px-4 py-3';

    // 创建产品选择器元素
    const productSelect = document.createElement('div');
    productSelect.className = 'searchable-select-wrapper';

    // 创建隐藏的input用于存储选中的产品ID
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.className = 'item-product';
    hiddenInput.name = 'product_id';
    hiddenInput.value = itemData.product_id || '';
    productSelect.appendChild(hiddenInput);

    // 创建显示输入框
    const displayInput = document.createElement('input');
    displayInput.type = 'text';
    displayInput.className = 'searchable-select-input';
    displayInput.placeholder = '选择产品';
    displayInput.dataset.products = JSON.stringify(window.productsData || []);
    displayInput.dataset.selected = itemData.product_id || '';
    productSelect.appendChild(displayInput);

    // 创建下拉箭头
    const arrow = document.createElement('i');
    arrow.className = 'fas fa-chevron-down searchable-select-arrow';
    productSelect.appendChild(arrow);

    // 创建下拉框容器
    const dropdown = document.createElement('div');
    dropdown.className = 'searchable-select-dropdown';
    dropdown.style.display = 'none';
    productSelect.appendChild(dropdown);

    productCell.appendChild(productSelect);

    // 数量单元格
    const quantityCell = document.createElement('td');
    quantityCell.className = 'px-4 py-3';
    quantityCell.innerHTML = `
        <input type="number" class="item-quantity w-full px-2 py-1 rounded"
               data-index="${rowIndex}" value="${itemData.quantity || ''}" step="1" min="1" required>
    `;

    // 备注单元格
    const notesCell = document.createElement('td');
    notesCell.className = 'px-4 py-3';
    notesCell.innerHTML = `
        <input type="text" class="item-notes w-full px-2 py-1 rounded"
               data-index="${rowIndex}" value="${itemData.notes || ''}">
    `;

    // 操作单元格
    const actionCell = document.createElement('td');
    actionCell.className = 'px-4 py-3 text-center';
    actionCell.innerHTML = `
        <button type="button" onclick="removeItemRow(this)" class="text-red-600 hover:text-red-800">
            <i class="fas fa-trash"></i>
        </button>
    `;

    row.appendChild(productCell);
    row.appendChild(quantityCell);
    row.appendChild(notesCell);
    row.appendChild(actionCell);

    tbody.appendChild(row);

    // 添加到数据数组
    itemsData.push({
        product_id: itemData.product_id || '',
        quantity: itemData.quantity || '',
        notes: itemData.notes || ''
    });

    updateNoItemsMessage();

    // 初始化Alpine.js产品选择器
    initProductSelect(row);
}

// 初始化产品选择器
function initProductSelect(row) {
    const selectContainer = row.querySelector('.searchable-select-wrapper');
    if (!selectContainer) return;

    const hiddenInput = selectContainer.querySelector('.item-product');
    const displayInput = selectContainer.querySelector('.searchable-select-input');
    const dropdown = selectContainer.querySelector('.searchable-select-dropdown');
    const arrow = selectContainer.querySelector('.searchable-select-arrow');

    // 解析产品数据
    const products = JSON.parse(displayInput.dataset.products);
    let selectedValue = displayInput.dataset.selected;
    let search = '';
    let isOpen = false;
    let highlightIndex = -1;

    // 过滤产品
    function getFilteredProducts() {
        if (!search) return products;
        const searchLower = search.toLowerCase();
        return products.filter(p =>
            p.name.toLowerCase().includes(searchLower) ||
            p.code.toLowerCase().includes(searchLower)
        );
    }

    // 显示下拉框
    function showDropdown() {
        isOpen = true;
        dropdown.style.display = 'block';
        arrow.classList.add('open');
        renderDropdown();
    }

    // 隐藏下拉框
    function hideDropdown() {
        isOpen = false;
        dropdown.style.display = 'none';
        arrow.classList.remove('open');
        search = '';
        highlightIndex = -1;
        displayInput.value = getDisplayValue();
    }

    // 获取显示值
    function getDisplayValue() {
        if (!selectedValue) return '';
        const product = products.find(p => p.id == selectedValue);
        return product ? `${product.name} (${product.code})` : '';
    }

    // 选择产品
    function selectProduct(product) {
        selectedValue = product.id;
        hiddenInput.value = product.id;
        hideDropdown();
    }

    // 渲染下拉框内容
    function renderDropdown() {
        const filtered = getFilteredProducts();
        dropdown.innerHTML = '';

        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="searchable-select-option text-gray-400">未找到匹配的产品</div>';
            return;
        }

        filtered.forEach((product, index) => {
            const option = document.createElement('div');
            option.className = 'searchable-select-option';
            if (index === highlightIndex) {
                option.classList.add('highlighted');
            }
            if (selectedValue == product.id) {
                option.classList.add('selected');
            }
            option.textContent = `${product.name} (${product.code})`;
            option.addEventListener('click', () => selectProduct(product));
            option.addEventListener('mouseenter', () => {
                highlightIndex = index;
                renderDropdown();
            });
            dropdown.appendChild(option);
        });
    }

    // 事件监听
    displayInput.addEventListener('focus', () => {
        showDropdown();
    });

    displayInput.addEventListener('input', (e) => {
        search = e.target.value;
        if (!isOpen) showDropdown();
        else renderDropdown();
    });

    displayInput.addEventListener('keydown', (e) => {
        const filtered = getFilteredProducts();

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (!isOpen) {
                    showDropdown();
                } else {
                    highlightIndex = Math.min(highlightIndex + 1, filtered.length - 1);
                    renderDropdown();
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                highlightIndex = Math.max(highlightIndex - 1, -1);
                renderDropdown();
                break;
            case 'Enter':
                e.preventDefault();
                if (isOpen && highlightIndex >= 0) {
                    selectProduct(filtered[highlightIndex]);
                }
                break;
            case 'Escape':
                hideDropdown();
                break;
            case 'Tab':
                hideDropdown();
                break;
        }
    });

    displayInput.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isOpen) showDropdown();
    });

    document.addEventListener('click', (e) => {
        if (!selectContainer.contains(e.target)) {
            hideDropdown();
        }
    });

    // 初始化显示值
    if (selectedValue) {
        displayInput.value = getDisplayValue();
    }
}

// 删除明细行
function removeItemRow(btn) {
    const row = btn.closest('tr');
    const productSelect = row.querySelector('.item-product');
    const index = parseInt(productSelect.dataset.index);

    // 销毁 Tom Select 实例（如果存在）
    if (productSelect && productSelect.tomselect) {
        productSelect.tomselect.destroy();
    }

    itemsData.splice(index, 1);
    row.remove(); // 重新索引
    reindexRows();
    updateNoItemsMessage();
}

// 重新索引所有行
function reindexRows() {
    const rows = document.querySelectorAll('#itemsBody tr');
    rows.forEach((row, index) => {
        row.querySelectorAll('[data-index]').forEach(el => {
            el.dataset.index = index;
        });
    });
}

// 更新"无明细"提示
function updateNoItemsMessage() {
    const noMsg = document.getElementById('noItemsMessage');
    const table = document.getElementById('itemsTable'); if (itemsData.length === 0) {
        noMsg.classList.remove('hidden');
        table.classList.add('hidden');
    } else {
        noMsg.classList.add('hidden');
        table.classList.remove('hidden');
    }
}

// 收集表单数据
function collectItemsData() {
    const items = [];
    const rows = document.querySelectorAll('#itemsBody tr'); rows.forEach((row, index) => {
        const productId = row.querySelector('.item-product').value;
        const quantity = row.querySelector('.item-quantity').value;
        const notes = row.querySelector('.item-notes').value; if (productId && quantity) {
            items.push({
                product_id: parseInt(productId),
                quantity: parseFloat(quantity),
                notes: notes
            });
        }
    }); return items;
}

// 表单提交前处理
document.getElementById('borrowForm').addEventListener('submit', function(e) {
    const items = collectItemsData(); if (items.length === 0) {
        e.preventDefault();
        alert('请至少添加一个产品明细');
        return false;
    } document.getElementById('itemsJson').value = JSON.stringify(items);
    return true;
});

// 添加产品按钮事件
document.getElementById('addItemBtn').addEventListener('click', function() {
    addItemRow();
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 设置默认借用日期为今天
    const borrowDate = document.getElementById('borrowDate');
    if (!borrowDate.value) {
        borrowDate.value = new Date().toISOString().split('T')[0];
    } // 加载现有明细（编辑模式）
    if (existingItems.length > 0) {
        existingItems.forEach(item => {
            addItemRow(item);
        });
    } updateNoItemsMessage();
});
</script>
{% endblock %}
