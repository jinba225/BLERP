{% extends 'base.html' %}
{% block title %}{% if action == 'create' %}新建{% else %}编辑{% endif %}采购申请 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">采购管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:request_list' %}" class="text-gray-500 hover:text-gray-700">采购申请</a>
{% if action == 'update' %}
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'purchase:request_detail' request.pk %}" class="text-gray-500 hover:text-gray-700">{{ request.request_number }}</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">编辑申请</span>
{% else %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">新建申请</span>
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="requestForm()">
<form method="post" @submit="prepareSubmit">
{% csrf_token %}
<input type="hidden" name="items_json" x-model="itemsJSON">

<div class="mb-6">
<h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建采购申请{% else %}编辑采购申请{% endif %}</h3>
</div>

<!-- 基本信息 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">申请人</label>
<input type="text" value="{{ user.get_full_name|default:user.username }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">申请日期 <span class="text-red-500">*</span></label>
<input type="date" name="request_date" value="{% if request %}{{ request.request_date|date:'Y-m-d' }}{% endif %}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">需求日期</label>
<input type="date" name="required_date" value="{% if request and request.required_date %}{{ request.required_date|date:'Y-m-d' }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
<select name="priority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="normal" {% if not request or request.priority == 'normal' %}selected{% endif %}>普通</option>
<option value="urgent" {% if request and request.priority == 'urgent' %}selected{% endif %}>紧急</option>
</select>
</div>
</div>
<div class="mt-4">
<label class="block text-sm font-medium text-gray-700 mb-2">申请理由</label>
<textarea name="justification" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">{% if request %}{{ request.justification }}{% endif %}</textarea>
</div>
</div>

<!-- 申请明细 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h4 class="text-md font-semibold text-gray-900">申请明细</h4>
<button type="button" @click="addItem" class="btn btn-primary text-sm px-3 py-1.5"><i class="fas fa-plus mr-1"></i>添加产品</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full">
<thead class="bg-gray-50">
<tr>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-8">#</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">产品 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">申请数量 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">预估单价</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">预估总价</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-40">首选供应商</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-32">规格要求</th>
<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">操作</th>
</tr>
</thead>
<tbody>
<template x-for="(item, index) in items" :key="index">
<tr class="border-t">
<td class="px-3 py-2 text-sm text-gray-500" x-text="index + 1"></td>
<td class="px-3 py-2">
<select x-model="item.product_id" @change="onProductChange(index)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" required>
<option value="">选择产品</option>
{% for p in products %}
<option value="{{ p.id }}" data-unit="{{ p.unit.symbol|default:'' }}">{{ p.code }} - {{ p.name }}</option>
{% endfor %}
</select>
</td>
<td class="px-3 py-2">
<input type="number" x-model="item.quantity" step="1" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right" required>
</td>
<td class="px-3 py-2">
<select x-model="item.preferred_supplier_id" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
<option value="">未指定</option>
{% for supplier in suppliers %}
<option value="{{ supplier.id }}">{{ supplier.name }}</option>
{% endfor %}
</select>
</td>
<td class="px-3 py-2">
<input type="text" x-model="item.specifications" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="规格说明">
</td>
<td class="px-3 py-2 text-center">
<button type="button" @click="removeItem(index)" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
</td>
</tr>
</template>
<template x-if="items.length === 0">
<tr><td colspan="8" class="px-3 py-8 text-center text-gray-500 text-sm">暂无明细,请点击"添加产品"按钮添加申请项目</td></tr>
</template>
</tbody>
</table>
</div>
</div>

<!-- 操作按钮 -->
<div class="flex justify-end space-x-3 pt-4 border-t">
<a href="{% if action == 'update' %}{% url 'purchase:request_detail' request.pk %}{% else %}{% url 'purchase:request_list' %}{% endif %}" class="btn btn-outline">
<i class="fas fa-times mr-2"></i>取消
</a>
<button type="submit" class="btn btn-primary">
<i class="fas fa-save mr-2"></i>保存申请单
</button>
</div>
</form>
</div>

<script>
function requestForm() {
    // 设置默认日期为当天
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const requestDateInput = document.querySelector('input[name="request_date"]');
        if (requestDateInput && !requestDateInput.value) {
            requestDateInput.value = today;
        }
    });

    return {
        items: [],
        itemsJSON: '[]',

        init() {
            {% if action == 'update' %}
            this.items = [
                {% for item in request.items.all %}
                {
                    product_id: '{{ item.product.id }}',
                    quantity: {{ item.quantity }},
                    preferred_supplier_id: {% if item.preferred_supplier %}'{{ item.preferred_supplier.id }}'{% else %}''{% endif %},
                    specifications: '{{ item.specifications|default:"" }}',
                    notes: '{{ item.notes|default:"" }}'
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            {% endif %}
        },

        addItem() {
            this.items.push({
                product_id: '',
                quantity: 1,
                preferred_supplier_id: '',
                specifications: '',
                notes: ''
            });
        },

        removeItem(index) {
            this.items.splice(index, 1);
        },

        onProductChange(index) {
            // 产品选择变化时可以在这里添加逻辑
        },

        prepareSubmit(e) {
            this.itemsJSON = JSON.stringify(this.items);
        }
    }
}
</script>
{% endblock %}
