{% extends 'base.html' %}

{% block title %}退货统计分析 - BetterLaser ERP{% endblock %}

{% block breadcrumb %}
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-500">销售管理</span>
<span class="mx-2 text-gray-400">/</span>
<a href="{% url 'sales:return_list' %}" class="text-gray-500 hover:text-gray-700">销售退货</a>
<span class="mx-2 text-gray-400">/</span>
<span class="text-gray-900 font-semibold">统计分析</span>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-900">退货统计分析</h3>
        <a href="{% url 'sales:return_list' %}"
           class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>返回列表
        </a>
    </div> <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <form method="get" class="flex items-end space-x-4">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">开始日期</label>
                <input type="date" name="date_from" value="{{ date_from|date:'Y-m-d' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">结束日期</label>
                <input type="date" name="date_to" value="{{ date_to|date:'Y-m-d' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-theme-500 focus:border-theme-500">
            </div>
            <button class="btn btn-primary" type="submit">
                <svg class="icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
</svg>查询
            </button>
        </form>
    </div> <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <!-- Total Returns -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-1">退货总数</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_returns }}</p>
                </div>
                <div class="w-12 h-12 bg-theme-100 rounded-lg flex items-center justify-center">
                    <svg class="icon text-theme-600 text-xl fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
                </div>
            </div>
        </div> <!-- Total Refund -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-1">退款总额</p>
                    <p class="text-2xl font-bold text-red-600">¥{{ total_refund|floatformat:2 }}</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <svg class="icon text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                </div>
            </div>
        </div> <!-- Return Rate -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-1">退货率</p>
                    <p class="text-2xl font-bold text-orange-600">{{ return_rate }}%</p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <svg class="icon text-orange-600 text-xl fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 17L17 7M7 7h10v10" /></svg>
                </div>
            </div>
        </div> <!-- Average Processing Days -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-1">
                    <p class="text-sm text-gray-600 mb-1">平均处理时间</p>
                    <p class="text-2xl font-bold text-green-600">{{ avg_processing_days }} 天</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="icon text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
                </div>
            </div>
        </div>
    </div> <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Reason Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">退货原因分布</h4>
            <canvas id="reasonChart" height="300"></canvas>
        </div> <!-- Status Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">退货状态分布</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">数量</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">退款金额</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in status_stats %}
                        <tr class="border-b">
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 text-xs font-semibold rounded
                                    {% if stat.status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% elif stat.status == 'approved' %}bg-theme-100 text-theme-800
                                    {% elif stat.status == 'received' %}bg-indigo-100 text-indigo-800
                                    {% elif stat.status == 'processed' %}bg-green-100 text-green-800
                                    {% elif stat.status == 'rejected' %}bg-red-100 text-red-800
                                    {% endif %}">
                                    {{ stat.status }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-right">{{ stat.count }}</td>
                            <td class="px-4 py-3 text-sm text-right text-theme-600">¥{{ stat.total_refund|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">暂无数据</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div> <!-- Monthly Trend -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h4 class="text-lg font-semibold text-gray-900 mb-4">月度退货趋势</h4>
        <canvas id="monthlyChart" height="100"></canvas>
    </div> <!-- Detailed Statistics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Products -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">退货最多的产品 (Top 10)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">产品</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">退货次数</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">退货数量</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in product_stats %}
                        <tr class="border-b">
                            <td class="px-4 py-3 text-sm">
                                <div class="font-medium text-gray-900">{{ stat.order_item__product__name }}</div>
                                <div class="text-xs text-gray-500">{{ stat.order_item__product__code }}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-right">{{ stat.return_count }}</td>
                            <td class="px-4 py-3 text-sm text-right">{{ stat.total_quantity }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">暂无数据</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div> <!-- Top Customers -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">退货最多的客户 (Top 10)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">客户</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">退货次数</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">退款金额</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in customer_stats %}
                        <tr class="border-b">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ stat.sales_order__customer__name }}</td>
                            <td class="px-4 py-3 text-sm text-right">{{ stat.return_count }}</td>
                            <td class="px-4 py-3 text-sm text-right text-red-600">¥{{ stat.total_refund|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">暂无数据</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div> <!-- Reason Details Table -->
    <div class="bg-white rounded-lg shadow p-6">
        <h4 class="text-lg font-semibold text-gray-900 mb-4">退货原因详细统计</h4>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">退货原因</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">数量</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">占比</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">退款金额</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in reason_stats %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ stat.reason }}</td>
                        <td class="px-6 py-4 text-sm text-right">{{ stat.count }}</td>
                        <td class="px-6 py-4 text-sm text-right">
                            <div class="flex items-center justify-end">
                                <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-theme-600 h-2 rounded-full" style="width: {{ stat.percentage }}%"></div>
                                </div>
                                <span>{{ stat.percentage|floatformat:1 }}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-right text-red-600">¥{{ stat.total_refund|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">暂无数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Reason Distribution Pie Chart
const reasonCtx = document.getElementById('reasonChart').getContext('2d');
const reasonChart = new Chart(reasonCtx, {
    type: 'pie',
    data: {
        labels: {{ reason_labels_json|safe }},
        datasets: [{
            data: {{ reason_data_json|safe }},
            backgroundColor: [
                '#3b82f6', // blue
                '#ef4444', // red
                '#f59e0b', // orange
                '#10b981', // green
                '#8b5cf6', // purple
                '#ec4899', // pink
                '#14b8a6', // teal
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
            }
        }
    }
});

// Monthly Trend Line Chart
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: {{ monthly_labels_json|safe }},
        datasets: [
            {
                label: '退货数量',
                data: {{ monthly_counts_json|safe }},
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                yAxisID: 'y',
            },
            {
                label: '退款金额 (¥)',
                data: {{ monthly_refunds_json|safe }},
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                yAxisID: 'y1',
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: '退货数量'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: '退款金额 (¥)'
                },
                grid: {
                    drawOnChartArea: false,
                },
            },
        }
    }
});
</script>
{% endblock %}
