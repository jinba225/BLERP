{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿é¢„è§ˆ - {{ template.name }}</title>

    <!-- æ‰€æœ‰ä¾èµ–åº“ - æœ¬åœ°æ–‡ä»¶ -->
    <script src="{% static 'libs/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'libs/jsbarcode.min.js' %}"></script>
    <script src="{% static 'libs/socket.io.min.js' %}"></script>

    <!-- âœ¨ å…³é”®ï¼å¿…é¡»åœ¨ socket.io åŠ è½½åã€HiPrint åŠ è½½å‰ç¦ç”¨è¿æ¥ -->
    <script>
        console.log('ğŸ”§ é…ç½® socket.io ä¸ºç¦ç”¨æ¨¡å¼ï¼ˆåœ¨ HiPrint åŠ è½½å‰ï¼‰');
        if (typeof io !== 'undefined') {
            // åˆ›å»ºç©ºå¯¹è±¡ï¼Œé¿å…è¿æ¥
            var dummySocket = {
                on: function() { return this; },
                once: function() { return this; },
                off: function() { return this; },
                emit: function() { return this; },
                close: function() { return this; },
                disconnect: function() { return this; },
                connect: function() { return this; },
                send: function() { return this; }
            };

            // é‡å†™ io æ–¹æ³•
            io.connect = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io è¿æ¥å°è¯•');
                return dummySocket;
            };

            io.Manager = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io Manager åˆå§‹åŒ–');
                return dummySocket;
            };

            // ç›´æ¥è°ƒç”¨ io() çš„æƒ…å†µ
            window.io = function() {
                console.log('âš ï¸ å·²é˜»æ­¢ socket.io ç›´æ¥è°ƒç”¨');
                return dummySocket;
            };
            window.io.connect = io.connect;
            window.io.Manager = io.Manager;

            console.log('âœ… socket.io å·²å®Œå…¨ç¦ç”¨');
        } else {
            console.warn('âš ï¸ socket.io æœªæ‰¾åˆ°');
        }
    </script>

    <script src="{% static 'libs/jspdf.umd.min.js' %}"></script>
    <script src="{% static 'libs/html2canvas.min.js' %}"></script>
    <script src="{% static 'libs/canvg.umd.min.js' %}"></script>

    <!-- HiPrint CSS -->
    <link rel="stylesheet" href="{% static 'libs/print-lock.css' %}">

    <!-- âœ¨ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ Object.defineProperty é”å®š autoConnect ä¸º falseï¼ˆä¸å¯è¢« HiPrint è¦†ç›–ï¼‰ -->
    <script>
        console.log('ğŸ”§ [æ ¸å¿ƒä¿®å¤] é”å®š window.autoConnect = falseï¼ˆä¸å¯å†™ã€ä¸å¯åˆ é™¤ï¼‰');

        // ä½¿ç”¨ Object.defineProperty å¼ºåˆ¶é”å®š autoConnect å±æ€§
        Object.defineProperty(window, 'autoConnect', {
            get: function() {
                return false;  // å§‹ç»ˆè¿”å› false
            },
            set: function(value) {
                console.warn('âš ï¸ æ‹¦æˆªè®¾ç½® window.autoConnect =', value, 'ï¼ˆå¼ºåˆ¶ä¿æŒ falseï¼‰');
            },
            configurable: false,
            enumerable: true
        });

        console.log('âœ… window.autoConnect å·²é”å®šä¸º false');
    </script>

    <!-- HiPrint JS -->
    <script src="{% static 'libs/vue-plugin-hiprint.js' %}"></script>

    <script>
        console.log('âœ… HiPrint å·²åŠ è½½ï¼Œwindow.autoConnect =', window.autoConnect);

        // âœ¨âœ¨âœ¨ ç»ˆææ–¹æ¡ˆï¼šå®Œå…¨æ›¿æ¢ print2 æ–¹æ³•ï¼Œä½¿ç”¨éšè— iframe æ‰“å°
        if (typeof hiprint !== 'undefined' && hiprint.PrintTemplate) {
            console.log('ğŸ”§ [ç»ˆæä¿®å¤] æ›¿æ¢ print2 æ–¹æ³•ä¸º iframe æ‰“å°ç‰ˆæœ¬');

            hiprint.PrintTemplate.prototype.print2 = function(data, options, printOptions) {
                console.log('ğŸ–¨ï¸ [è‡ªå®šä¹‰ print2] ä½¿ç”¨éšè— iframe æ‰“å°');

                try {
                    var htmlContent = this.getHtml(data);
                    console.log('   è·å– HTML å†…å®¹æˆåŠŸ');

                    var printIframe = document.getElementById('hiprint-print-iframe');
                    if (!printIframe) {
                        printIframe = document.createElement('iframe');
                        printIframe.id = 'hiprint-print-iframe';
                        printIframe.style.position = 'fixed';
                        printIframe.style.top = '0';
                        printIframe.style.left = '0';
                        printIframe.style.width = '0';
                        printIframe.style.height = '0';
                        printIframe.style.border = 'none';
                        printIframe.style.opacity = '0';
                        printIframe.style.pointerEvents = 'none';
                        document.body.appendChild(printIframe);
                    }

                    var iframeDoc = printIframe.contentDocument || printIframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write('<!DOCTYPE html>');
                    iframeDoc.write('<html><head>');
                    iframeDoc.write('<meta charset="UTF-8">');
                    iframeDoc.write('<title>æ‰“å°é¢„è§ˆ</title>');
                    iframeDoc.write('<link rel="stylesheet" href="/static/libs/print-lock.css">');
                    iframeDoc.write('<style>');
                    iframeDoc.write('body { margin: 0; padding: 0; }');
                    iframeDoc.write('@page { margin: 0; }');
                    iframeDoc.write('</style>');
                    iframeDoc.write('</head><body>');
                    iframeDoc.write(htmlContent);
                    iframeDoc.write('</body></html>');
                    iframeDoc.close();

                    setTimeout(function() {
                        try {
                            printIframe.contentWindow.focus();
                            printIframe.contentWindow.print();
                            console.log('âœ… æ‰“å°å¯¹è¯æ¡†å·²å¼¹å‡º');
                            if (printOptions && printOptions.callback) {
                                printOptions.callback();
                            }
                        } catch (error) {
                            console.error('âŒ æ‰“å°å¤±è´¥:', error);
                            alert('æ‰“å°å¤±è´¥: ' + error.message);
                        }
                    }, 500);

                } catch (error) {
                    console.error('âŒ æ¸²æŸ“å¤±è´¥:', error);
                    alert('æ‰“å°å¤±è´¥: ' + error.message);
                }
            };

            console.log('âœ… print2 æ–¹æ³•å·²æ›¿æ¢');
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .toolbar {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar button,
        .toolbar a {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(107, 114, 128, 0.3);
        }

        .template-info {
            font-size: 12px;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        .data-badge {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        #preview-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 400px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* HiPrintç”»å¸ƒæ ·å¼ - ç¡®ä¿ä¸ç¼–è¾‘å™¨ä¸€è‡´ */
        .hiprint-printPanel {
            margin: 0 auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white !important;
            position: relative;
        }

        /* HiPrintå…ƒç´ æ ·å¼ */
        .hiprint-printElement {
            user-select: none;
            pointer-events: none; /* ç¦æ­¢äº¤äº’ */
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            border-radius: 8px;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            padding: 40px;
            text-align: center;
        }

        .error-icon {
            font-size: 48px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .info-icon {
            font-size: 48px;
            color: #f59e0b;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="template-info">
            <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
</svg>
            <span>æ¨¡æ¿é¢„è§ˆï¼š</span>
            <span class="template-badge">{{ template.name }}</span>
            <span class="data-badge"><svg w-5 h-5 fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg> æµ‹è¯•æ•°æ®</span>
        </div>
        <div>
            <button onclick="window.close()" class="btn-secondary">
                <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
</svg> å…³é—­
            </button>
        </div>
    </div>

    <div id="preview-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div style="text-align: center;">
                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                <p style="color: #6b7280; font-size: 14px;">æ­£åœ¨åŠ è½½é¢„è§ˆ...</p>
            </div>
        </div>
    </div>

    <script>
    let hiprintTemplate;

    $(document).ready(function() {
        console.log('=== é¢„è§ˆé¡µé¢åˆå§‹åŒ– ===');

        // è·å–æ¨¡æ¿JSON
        const templateJson = {{ layout_config_json|safe }};
        console.log('æ¨¡æ¿JSON:', templateJson);

        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        const previewData = generateSampleData();
        console.log('æµ‹è¯•æ•°æ®:', previewData);

        // åˆå§‹åŒ–HiPrintæ¨¡æ¿
        if (templateJson && Object.keys(templateJson).length > 0) {
            try {
                console.log('åˆ›å»º HiPrint æ¨¡æ¿å®ä¾‹...');

                // âœ¨ ä»æ¨¡æ¿JSONè·å–ç”»å¸ƒå°ºå¯¸é…ç½®
                let canvasWidth = 210;  // é»˜è®¤A4çº¸å®½åº¦(mm)
                let canvasHeight = 297; // é»˜è®¤A4çº¸é«˜åº¦(mm)

                if (templateJson.panels && templateJson.panels.length > 0) {
                    const panel = templateJson.panels[0];
                    if (panel.width) canvasWidth = panel.width;
                    if (panel.height) canvasHeight = panel.height;

                    console.log('ğŸ“ ç”»å¸ƒå°ºå¯¸é…ç½®:', {
                        width: canvasWidth + 'mm',
                        height: canvasHeight + 'mm',
                        paperType: panel.paperType || 'A4',
                        orientation: panel.orientation || 'portrait'
                    });
                }

                // è½¬æ¢mmåˆ°px (96 DPI: 1mm â‰ˆ 3.7795px)
                const MM_TO_PX = 3.7795275591;
                const canvasWidthPx = canvasWidth * MM_TO_PX;
                const canvasHeightPx = canvasHeight * MM_TO_PX;

                console.log('ğŸ“ ç”»å¸ƒåƒç´ å°ºå¯¸:', {
                    width: canvasWidthPx.toFixed(2) + 'px',
                    height: canvasHeightPx.toFixed(2) + 'px'
                });

                hiprintTemplate = new hiprint.PrintTemplate({
                    template: templateJson
                });

                // å…ˆéšè—åŠ è½½åŠ¨ç”»
                $('#loadingOverlay').fadeOut(300);

                // âœ¨ ä½¿ç”¨designæ–¹æ³•æ¸²æŸ“æ¨¡æ¿ï¼ˆä¿ç•™å®Œæ•´æ ·å¼å’Œç”»å¸ƒå°ºå¯¸ï¼‰
                hiprintTemplate.design('#preview-container');

                // åº”ç”¨ç”»å¸ƒå°ºå¯¸å¹¶ç¦ç”¨ç¼–è¾‘åŠŸèƒ½
                setTimeout(function() {
                    // è·å–ç”»å¸ƒé¢æ¿
                    const $panel = $('.hiprint-printPanel');

                    if ($panel.length > 0) {
                        // âœ¨ è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºè®¾è®¡æ—¶çš„å°ºå¯¸
                        $panel.css({
                            'width': canvasWidthPx + 'px',
                            'height': canvasHeightPx + 'px',
                            'min-width': canvasWidthPx + 'px',
                            'min-height': canvasHeightPx + 'px',
                            'max-width': canvasWidthPx + 'px',
                            'max-height': canvasHeightPx + 'px'
                        });

                        console.log('âœ… ç”»å¸ƒå°ºå¯¸å·²åº”ç”¨:', canvasWidthPx + 'px Ã— ' + canvasHeightPx + 'px');
                    }

                    // ç¦ç”¨æ‰€æœ‰ç¼–è¾‘åŠŸèƒ½
                    $('.hiprint-printElement').each(function() {
                        $(this).css({
                            'pointer-events': 'none',
                            'user-select': 'none'
                        });

                        // ç§»é™¤å¯æ‹–æ‹½ç±»
                        $(this).removeClass('ui-draggable ui-resizable');
                    });

                    // ç§»é™¤å·¥å…·æ å’Œè°ƒæ•´æ‰‹æŸ„
                    $('.hiprint-printElement-operating, .ui-resizable-handle').remove();

                    // ç§»é™¤å³é”®èœå•
                    $('.hiprint-contextMenu').remove();

                    // ç¦ç”¨æ·»åŠ å…ƒç´ åŠŸèƒ½
                    $('.hiprint-printTemplate-design').css('pointer-events', 'none');

                    console.log('âœ… é¢„è§ˆæ¸²æŸ“å®Œæˆ');
                }, 500);

            } catch (error) {
                console.error('âŒ HiPrintåˆå§‹åŒ–å¤±è´¥:', error);
                $('#loadingOverlay').hide();
                showError('æ¨¡æ¿åŠ è½½å¤±è´¥: ' + error.message);
            }
        } else {
            $('#loadingOverlay').hide();
            showWarning('æ¨¡æ¿å°šæœªè®¾è®¡ï¼Œè¯·å…ˆè®¾è®¡æ¨¡æ¿');
        }
    });

    // ç”Ÿæˆæµ‹è¯•æ•°æ®
    function generateSampleData() {
        return {
            // åŸºæœ¬ä¿¡æ¯
            quote_number: 'BL-Q-20250109-DEMO',
            quote_date: '2025-01-09',
            valid_until: '2025-02-09',
            quote_type: 'å›½å†…æŠ¥ä»·',
            reference_number: 'REF-DEMO-001',
            sales_rep: 'å¼ ä¸‰ï¼ˆé”€å”®ä»£è¡¨ï¼‰',
            print_date: '2025-01-09 15:30',

            // å®¢æˆ·ä¿¡æ¯
            customer_name: 'ã€é¢„è§ˆã€‘ç¤ºä¾‹å®¢æˆ·æœ‰é™å…¬å¸',
            customer_phone: '0755-88888888',
            customer_address: 'å¹¿ä¸œçœæ·±åœ³å¸‚å—å±±åŒºç§‘æŠ€å›­åŒ—åŒºç¤ºä¾‹è·¯100å·',
            contact_person: 'æç»ç†',
            contact_phone: '13900000000',
            contact_email: 'li@example.com',

            // é‡‘é¢ä¿¡æ¯
            currency: 'CNY',
            exchange_rate: '1.00',
            subtotal: '385000.00',
            discount_amount: '15000.00',
            tax_amount: '48100.00',
            total_amount: '418100.00',

            // æ¡æ¬¾ä¿¡æ¯
            payment_terms: 'é¢„ä»˜30%ï¼Œå‘è´§å‰ä»˜æ¸…ä½™æ¬¾',
            delivery_terms: 'å‘è´§å5-7ä¸ªå·¥ä½œæ—¥é€è¾¾',
            warranty_terms: 'è´¨ä¿æœŸ12ä¸ªæœˆï¼Œå…è´¹ä¸Šé—¨æœåŠ¡',
            notes: 'æ­¤ä¸ºæ¨¡æ¿é¢„è§ˆï¼Œä½¿ç”¨æµ‹è¯•æ•°æ®å±•ç¤º',

            // å…¬å¸ä¿¡æ¯
            company_name: '{{ template.company_name }}',
            company_address: '{{ template.company_address }}',
            company_phone: '{{ template.company_phone }}',
            company_email: '{{ template.company_email }}',

            // æ˜ç»†é¡¹æ•°æ®ï¼ˆæµ‹è¯•ç”¨ï¼ŒåŒ…å«4æ¡ï¼‰
            items: [
                {
                    index: 1,
                    product_code: 'BL-LS-1000',
                    product_name: 'å…‰çº¤æ¿€å…‰å™¨ 1000W',
                    specifications: 'IPG YLR-1000',
                    quantity: '2',
                    unit: 'å°',
                    unit_price: '35000.00',
                    discount_rate: '5%',
                    discount_amount: '3500.00',
                    tax_rate: '13%',
                    line_total: '70000.00',
                    lead_time: '30å¤©',
                    notes: 'å«é…ä»¶'
                },
                {
                    index: 2,
                    product_code: 'BL-CUT-3015',
                    product_name: 'æ¿€å…‰åˆ‡å‰²æœº 3015',
                    specifications: 'å·¥ä½œå° 3000Ã—1500mm',
                    quantity: '1',
                    unit: 'å°',
                    unit_price: '280000.00',
                    discount_rate: '8%',
                    discount_amount: '22400.00',
                    tax_rate: '13%',
                    line_total: '280000.00',
                    lead_time: '45å¤©',
                    notes: 'å«åŸ¹è®­'
                },
                {
                    index: 3,
                    product_code: 'BL-ACC-001',
                    product_name: 'æ¿€å…‰é˜²æŠ¤çœ¼é•œ',
                    specifications: 'OD5+ é˜²æŠ¤çº§åˆ«',
                    quantity: '10',
                    unit: 'å‰¯',
                    unit_price: '150.00',
                    discount_rate: '0%',
                    discount_amount: '0.00',
                    tax_rate: '13%',
                    line_total: '1500.00',
                    lead_time: '7å¤©',
                    notes: 'æ ‡é…'
                },
                {
                    index: 4,
                    product_code: 'BL-SRV-001',
                    product_name: 'å®‰è£…è°ƒè¯•æœåŠ¡',
                    specifications: 'ç°åœºå®‰è£…ã€è°ƒè¯•åŠéªŒæ”¶',
                    quantity: '1',
                    unit: 'é¡¹',
                    unit_price: '8000.00',
                    discount_rate: '0%',
                    discount_amount: '0.00',
                    tax_rate: '6%',
                    line_total: '8000.00',
                    lead_time: 'éšæœºå‘è´§',
                    notes: 'å«å·®æ—…è´¹'
                }
            ]
        };
    }

    function showError(message) {
        $('#preview-container').html(`
            <div class="error-container">
                <svg class="icon error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
</svg>
                <h3 style="margin-bottom: 10px; color: #111827;">æ¨¡æ¿åŠ è½½å¤±è´¥</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">${message}</p>
            </div>
        `);
    }

    function showWarning(message) {
        $('#preview-container').html(`
            <div class="error-container">
                <svg info-icon fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                <h3 style="margin-bottom: 10px; color: #111827;">æ¨¡æ¿å°šæœªè®¾è®¡</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">${message}</p>
            </div>
        `);
    }
    </script>
</body>
</html>
