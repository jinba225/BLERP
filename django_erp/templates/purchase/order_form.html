{% extends 'base.html' %}
{% block title %}{% if action == 'create' %}新建{% else %}编辑{% endif %}采购订单{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="orderForm()" x-init="init()">
<form method="post" @submit="prepareSubmit">
{% csrf_token %}
<input type="hidden" name="items_json" x-model="itemsJSON">

<div class="flex justify-between items-center mb-6">
<h3 class="text-lg font-semibold text-gray-900">{% if action == 'create' %}新建采购订单{% else %}编辑采购订单{% endif %}</h3>
<div class="flex space-x-3">
<a href="{% if action == 'update' %}{% url 'purchase:order_detail' order.pk %}{% else %}{% url 'purchase:order_list' %}{% endif %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">取消</a>
<button type="submit" class="px-4 py-2 bg-theme-600 text-white rounded-lg hover:bg-theme-700">保存</button>
</div>
</div>

<!-- 基本信息 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">基本信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">供应商 <span class="text-red-500">*</span></label>
<select name="supplier" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="">请选择供应商</option>
{% for supplier in suppliers %}
<option value="{{ supplier.id }}" {% if order and order.supplier.id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
{% endfor %}
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">订单日期 <span class="text-red-500">*</span></label>
<input type="date" name="order_date" value="{% if order %}{{ order.order_date|date:'Y-m-d' }}{% endif %}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">要求交期</label>
<input type="date" name="required_date" value="{% if order and order.required_date %}{{ order.required_date|date:'Y-m-d' }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">采购员</label>
<select name="buyer" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="">请选择</option>
{% for buyer in buyers %}
<option value="{{ buyer.id }}" {% if order and order.buyer and order.buyer.id == buyer.id %}selected{% endif %}>{{ buyer.get_full_name|default:buyer.username }}</option>
{% endfor %}
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">收货仓库</label>
<select name="warehouse" data-disable-tom-select class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white ">
<option value="">请选择</option>
{% for warehouse in warehouses %}
<option value="{{ warehouse.id }}" {% if order and order.warehouse and order.warehouse.id == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
{% endfor %}
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">币种</label>
<select name="currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="CNY" {% if order and order.currency == 'CNY' or not order %}selected{% endif %}>CNY (人民币)</option>
<option value="USD" {% if order and order.currency == 'USD' %}selected{% endif %}>USD (美元)</option>
<option value="EUR" {% if order and order.currency == 'EUR' %}selected{% endif %}>EUR (欧元)</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">税率 (%)</label>
<input type="number" name="tax_rate" value="{% if order %}{{ order.tax_rate }}{% else %}13{% endif %}" step="0.01" x-model="taxRate" @input="calculateTotals" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">折扣率 (%)</label>
<input type="number" name="discount_rate" value="{% if order %}{{ order.discount_rate }}{% else %}0{% endif %}" step="0.01" x-model="discountRate" @input="calculateTotals" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">运费</label>
<input type="number" name="shipping_cost" value="{% if order %}{{ order.shipping_cost }}{% else %}0{% endif %}" step="0.01" x-model="shippingCost" @input="calculateTotals" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
</div>
</div>

<!-- 订单明细 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<div class="flex justify-between items-center mb-4 pb-2 border-b">
<h4 class="text-md font-semibold text-gray-900">订单明细</h4>
<button type="button" @click="addItem" class="px-3 py-1.5 bg-theme-600 text-white rounded-lg text-sm hover:bg-theme-700"><i class="fas fa-plus mr-1"></i>添加行</button>
</div>
<div class="overflow-x-auto">
<table class="min-w-full">
<thead class="bg-gray-50">
<tr>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-8">#</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">产品 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">数量 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">单价 *</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-24">折扣率%</th>
<th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase w-28">行总计</th>
<th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-16">操作</th>
</tr>
</thead>
<tbody>
<template x-for="(item, index) in items" :key="index">
<tr class="border-t">
<td class="px-3 py-2 text-sm text-gray-500" x-text="index + 1"></td>
<td class="px-3 py-2">
<select x-model="item.product_id" @change="onProductChange(index)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" required>
<option value="">选择产品</option>
{% for p in products %}
<option value="{{ p.id }}" data-price="{{ p.purchase_price|default:0 }}" data-unit="{{ p.unit.symbol|default:'' }}">{{ p.code }} - {{ p.name }}</option>
{% endfor %}
</select>
</td>
<td class="px-3 py-2"><input type="number" x-model="item.quantity" @input="calculateLineTotal(index)" step="0.01" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right" required></td>
<td class="px-3 py-2"><input type="number" x-model="item.unit_price" @input="calculateLineTotal(index)" step="0.01" min="0" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right" required></td>
<td class="px-3 py-2"><input type="number" x-model="item.discount_rate" @input="calculateLineTotal(index)" step="0.01" min="0" max="100" class="w-full px-2 py-1 border border-gray-300 rounded text-sm text-right"></td>
<td class="px-3 py-2 text-sm text-right font-medium text-gray-900" x-text="formatMoney(item.line_total)"></td>
<td class="px-3 py-2 text-center">
<button type="button" @click="removeItem(index)" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
</td>
</tr>
</template>
<template x-if="items.length === 0">
<tr><td colspan="7" class="px-3 py-8 text-center text-gray-500 text-sm">暂无明细，请点击"添加行"按钮添加产品</td></tr>
</template>
</tbody>
</table>
</div>
</div>

<!-- 金额汇总 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">金额汇总</h4>
<div class="max-w-md ml-auto space-y-2">
<div class="flex justify-between text-sm"><span class="text-gray-600">小计：</span><span class="font-medium" x-text="formatMoney(subtotal)"></span></div>
<div class="flex justify-between text-sm"><span class="text-gray-600">折扣金额：</span><span class="font-medium" x-text="formatMoney(discountAmount)"></span></div>
<div class="flex justify-between text-sm"><span class="text-gray-600">税额：</span><span class="font-medium" x-text="formatMoney(taxAmount)"></span></div>
<div class="flex justify-between text-sm"><span class="text-gray-600">运费：</span><span class="font-medium" x-text="formatMoney(shippingCost)"></span></div>
<div class="flex justify-between text-lg font-bold pt-2 border-t"><span>总计：</span><span class="text-theme-600" x-text="formatMoney(totalAmount)"></span></div>
</div>
</div>

<!-- 其他信息 -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
<h4 class="text-md font-semibold text-gray-900 mb-4 pb-2 border-b">其他信息</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
<select name="payment_method" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
<option value="">请选择</option>
{% for value, label in PAYMENT_METHOD_CHOICES %}
<option value="{{ value }}" {% if order and order.payment_method == value %}selected{% endif %}>{{ label }}</option>
{% endfor %}
</select>
</div>
<div class="col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">交货地址</label>
<input type="text" name="delivery_address" value="{% if order %}{{ order.delivery_address }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">交货联系人</label>
<input type="text" name="delivery_contact" value="{% if order %}{{ order.delivery_contact }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">交货电话</label>
<input type="text" name="delivery_phone" value="{% if order %}{{ order.delivery_phone }}{% endif %}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
</div>
<div class="col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">备注</label>
<textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">{% if order %}{{ order.notes }}{% endif %}</textarea>
</div>
<div class="col-span-2">
<label class="block text-sm font-medium text-gray-700 mb-2">内部备注</label>
<textarea name="internal_notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">{% if order %}{{ order.internal_notes }}{% endif %}</textarea>
</div>
</div>
</div>

</form>
</div>

<script>
function orderForm() {
    // 设置默认日期为当天
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const orderDateInput = document.querySelector('input[name="order_date"]');
        if (orderDateInput && !orderDateInput.value) {
            orderDateInput.value = today;
        }
    });

    return {
        items: [],
        taxRate: {% if order %}{{ order.tax_rate }}{% else %}13{% endif %},
        discountRate: {% if order %}{{ order.discount_rate }}{% else %}0{% endif %},
        shippingCost: {% if order %}{{ order.shipping_cost }}{% else %}0{% endif %},
        subtotal: 0,
        discountAmount: 0,
        taxAmount: 0,
        totalAmount: 0,
        itemsJSON: '[]',

        init() {
            console.log('=== orderForm init() 开始 ===');
            console.log('action:', '{{ action }}');
            console.log('order存在:', {% if order %}true{% else %}false{% endif %});
            {% if action == 'update' and order %}
            console.log('订单号:', '{{ order.order_number }}');
            console.log('明细数量:', {{ order.items.all|length }});
            this.items = [
                {% for item in order.items.all %}
                {
                    product_id: '{{ item.product.id }}',
                    quantity: {{ item.quantity }},
                    unit_price: {{ item.unit_price }},
                    discount_rate: {{ item.discount_rate }},
                    line_total: {{ item.line_total }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            console.log('items数组:', this.items);
            {% else %}
            console.log('新建模式，items为空数组');
            {% endif %}
            this.calculateTotals();
            console.log('=== orderForm init() 结束 ===');
        },

        addItem() {
            this.items.push({
                product_id: '',
                quantity: 1,
                unit_price: 0,
                discount_rate: 0,
                line_total: 0
            });
        },

        removeItem(index) {
            this.items.splice(index, 1);
            this.calculateTotals();
        },

        onProductChange(index) {
            const select = event.target;
            const option = select.options[select.selectedIndex];
            if (option.dataset.price) {
                this.items[index].unit_price = parseFloat(option.dataset.price);
                this.calculateLineTotal(index);
            }
        },

        calculateLineTotal(index) {
            const item = this.items[index];
            const qty = parseFloat(item.quantity) || 0;
            const price = parseFloat(item.unit_price) || 0;
            const discountRate = parseFloat(item.discount_rate) || 0;

            const discountAmount = qty * price * (discountRate / 100);
            item.line_total = (qty * price) - discountAmount;

            this.calculateTotals();
        },

        calculateTotals() {
            this.subtotal = this.items.reduce((sum, item) => sum + (parseFloat(item.line_total) || 0), 0);
            this.discountAmount = this.subtotal * (parseFloat(this.discountRate) / 100);
            const afterDiscount = this.subtotal - this.discountAmount;
            this.taxAmount = afterDiscount * (parseFloat(this.taxRate) / 100);
            this.totalAmount = afterDiscount + this.taxAmount + parseFloat(this.shippingCost);
        },

        formatMoney(value) {
            return '¥' + (parseFloat(value) || 0).toFixed(2);
        },

        prepareSubmit(e) {
            this.itemsJSON = JSON.stringify(this.items);
        }
    }
}
</script>
{% endblock %}
