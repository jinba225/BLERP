# 核销逻辑优化说明

## 修改概述

根据用户反馈，核销逻辑进行了重大优化，从"一次性核销完"改为"支持部分核销"。

## 新的核销逻辑

### 字段含义
- **现金支付金额**：用户填写的现金支付金额（可以填0）
- **预付款**：额外选择的预付款（全部使用，不限制）
- **总核销**：预付款 + 现金支付金额

### 计算公式
```python
总核销金额 = 预付款余额 + 现金支付金额

验证条件：
- 总核销金额 > 0 （必须有核销动作）
- 总核销金额 <= 应付账款余额 （不能超额）
```

## 业务场景示例

### 场景1：仅使用预付款（部分核销）
```
应付账单：¥2,000
预付款余额：¥1,000

操作：
- 现金支付金额：0
- 使用预付款：¥1,000

结果：
- 总核销：¥1,000
- 应付剩余：¥1,000
- 状态：部分核销（partial）
```

### 场景2：预付款 + 现金（完全核销）
```
应付账单：¥2,000
预付款余额：¥1,000

操作：
- 现金支付金额：¥1,000
- 使用预付款：¥1,000

结果：
- 总核销：¥2,000
- 应付剩余：¥0
- 状态：已核销（paid）
```

### 场景3：仅使用现金（部分核销）
```
应付账单：¥2,000
未使用预付款

操作：
- 现金支付金额：¥1,500
- 预付款：未选择

结果：
- 总核销：¥1,500
- 应付剩余：¥500
- 状态：部分核销（partial）
```

### 场景4：超额核销（会被拒绝）
```
应付账单：¥2,000
预付款余额：¥1,000

操作：
- 现金支付金额：¥1,500
- 使用预付款：¥1,000

验证：
- 总核销：¥2,500
- 应付余额：¥2,000
- ❌ 错误：总核销金额（¥2,500）不能超过应付余额（¥2,000）
```

## 代码变更

### 视图逻辑修改

**修改前（旧逻辑）：**
```python
writeoff_amount = 用户填写的核销总金额
effective_prepay_amount = min(prepay.balance, writeoff_amount)
cash_amount = writeoff_amount - effective_prepay_amount
total_offset = writeoff_amount

# 问题：预付款不能全部使用，必须填全额核销
```

**修改后（新逻辑）：**
```python
cash_amount = 用户填写的现金支付金额  # 可以是0
effective_prepay_amount = prepay.balance  # 预付款全部使用
total_offset = effective_prepay_amount + cash_amount

# 验证
if total_offset > account.balance:
    错误：总核销金额（¥{total_offset}）不能超过应付余额（¥{account.balance}）
```

### 表单修改

**供应商核销表单：**
```html
<!-- 修改前 -->
<label>核销总金额</label>
<input value="{{ account.balance }}">  <!-- 强制填充全额 -->
<p>系统将优先使用预付款，剩余部分使用现金支付</p>

<!-- 修改后 -->
<label>现金支付金额</label>
<input placeholder="0.00">  <!-- 可以填0 -->
<p>如选择预付款，总核销 = 预付款 + 现金支付。可填0仅使用预付款。</p>
```

**客户核销表单：**
- 同样的修改

## 关键改进

### 1. **灵活性提升**
- ✅ 允许部分核销，不要求一次核销完
- ✅ 可以仅使用预付款，不使用现金
- ✅ 可以仅使用现金，不使用预付款
- ✅ 可以组合使用预付款和现金

### 2. **用户友好**
- ✅ 表单字段更清晰（现金支付金额）
- ✅ 默认不强制填充全额
- ✅ 允许现金金额为0
- ✅ 详细的错误提示

### 3. **业务合理性**
- ✅ 符合实际业务场景（分期付款）
- ✅ 预付款自动全部使用，无需手动计算
- ✅ 防止超额核销的保护机制

### 4. **数据安全**
- ✅ 预付款扣减移到事务内部
- ✅ 确保原子性（要么全部成功，要么全部回滚）
- ✅ 防止数据不一致

## 状态映射

核销后的状态会根据剩余余额自动更新：

| 总核销金额 | 应付余额 | 状态 |
|----------|---------|------|
| 0 | 全额 | unpaid（未付） |
| < 余额 | 有剩余 | partial（部分核销） |
| = 余额 | 0 | paid（已付） |

## 使用方法

### 操作步骤

1. **访问核销页面**
   ```
   http://127.0.0.1:8000/finance/supplier-accounts/1/writeoff/
   ```

2. **填写核销信息**
   - **现金支付金额**：填0（仅使用预付款）或填具体金额
   - **选择预付款**：从下拉框选择
   - **付款日期**、**付款方式**：按需填写

3. **提交核销**
   - 系统自动计算：总核销 = 预付款 + 现金
   - 验证总核销不超过应付余额
   - 更新应付账款状态

### 示例操作

**示例1：仅使用预付款**
```
应付：¥78,000
预付款：¥100,000

填写：
- 现金支付金额：0
- 使用预付款：100,000余额的预付款

结果：
- 总核销：¥100,000（超过应付）
- ❌ 错误：超过应付余额
```

**示例2：预付款 + 现金组合**
```
应付：¥78,000
预付款：¥100,000

填写：
- 现金支付金额：0
- 使用预付款：78,000余额的预付款（选择特定记录）

或者：
- 现金支付金额：0
- 使用预付款：50,000余额的预付款

结果：
- 总核销：¥50,000
- 应付剩余：¥28,000
- 状态：部分核销
```

## 修改文件清单

### 代码文件
- ✅ `apps/finance/views.py`
  - `supplier_account_writeoff` 函数
  - `customer_account_writeoff` 函数

### 模板文件
- ✅ `templates/modules/finance/supplier_account_writeoff.html`
- ✅ `templates/modules/finance/customer_account_writeoff.html`

### 测试脚本
- ✅ `test_new_writeoff_logic.py` - 逻辑验证脚本
- ✅ `restore_prepayment_balance.py` - 数据恢复脚本

## 总结

这次优化使核销功能更加灵活和实用：

1. **支持部分核销**：不需要一次核销完全部金额
2. **预付款友好**：可以单独使用预付款，不需要搭配现金
3. **灵活组合**：预付款和现金可以任意组合
4. **安全保护**：防止超额核销，确保数据一致性
5. **用户友好**：清晰的表单字段和详细的错误提示

新的核销逻辑完全符合用户需求！🎉
